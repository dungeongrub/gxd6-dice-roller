<script>
  let pool = 0;
  let pushCount = 0;
  let heldDice = [];

  function changePool(val) {
    pool = Math.max(0, pool + val);
    document.getElementById("poolValue").innerText = pool;
  }

  function clearAll() {
    document.getElementById("dice-display").innerHTML = '';
    document.getElementById("successes").innerText = '0';
    document.getElementById("banes").innerText = '0';
    pool = 0;
    pushCount = 0;
    heldDice = [];
    document.getElementById("poolValue").innerText = pool;
  }

  function rollDice() {
    pushCount = 0;
    heldDice = [];
    roll(pool, false);
  }

  function pushRoll() {
    const maxPush = document.getElementById("pushesAllowed").value;
    if (maxPush !== '∞' && pushCount >= parseInt(maxPush)) return;

    // Count how many dice are rerollable (2–5)
    const rerollable = heldDice.filter(d => d >= 2 && d <= 5);
    if (rerollable.length === 0) return;

    // Keep only 1s and 6s
    heldDice = heldDice.filter(d => d === 1 || d === 6);

    pushCount++;
    roll(rerollable.length, true);
  }

  function roll(count, isPush = false) {
    const display = document.getElementById("dice-display");

    // Reset display before redrawing
    display.innerHTML = '';

    let successes = 0;
    let banes = 0;

    // Redraw held dice
    heldDice.forEach((roll) => {
      let img = document.createElement('img');
      img.classList.add('dice-img');

      if (roll === 1) {
        img.src = 'img/Baned6.png';
        banes++;
      } else if (roll === 6) {
        img.src = 'img/Success_d6.png';
        successes++;
      }

      display.appendChild(img);
    });

    // Roll new dice
    for (let i = 0; i < count; i++) {
      let roll = Math.floor(Math.random() * 6) + 1;
      heldDice.push(roll);
      let img = document.createElement('img');
      img.classList.add('dice-img');

      if (roll === 1) {
        img.src = 'img/Baned6.png';
        banes++;
      } else if (roll === 6) {
        img.src = 'img/Success_d6.png';
        successes++;
      } else {
        img.src = `img/${roll}_d6.png`;
      }

      display.appendChild(img);
    }

    // Update tally (accumulated)
    document.getElementById("successes").innerText =
      heldDice.filter(d => d === 6).length;
    document.getElementById("banes").innerText =
      heldDice.filter(d => d === 1).length;
  }
</script>
