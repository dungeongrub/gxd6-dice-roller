<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GxD6 Character Sheet</title>

  <!-- ===== Base Sheet Styles ===== -->
  <style>
/* === Fonts (for the sheet) === */
@font-face { font-family: 'DominicanSmall'; src: url('fonts/DOMISC__.TTF'); font-display: swap; }
@font-face { font-family: 'Dominican';      src: url('fonts/DOMINICA.TTF'); font-display: swap; }
@font-face { font-family: 'DeutschGothic';  src: url('fonts/DeutschGothic.ttf'); font-display: swap; }
@font-face { font-family: 'GokilNova';      src: url('fonts/Gokil-Nova.ttf') format('truetype'); font-display: swap; }
@font-face { font-family: 'Gothics';        src: url('fonts/GOTHICS.ttf'); font-display: swap; }

body{
  font-family:'DominicanSmall', Georgia, serif;
  background:#f5f5f5;
  margin:0;
  padding:20px;
  color:black;
}

.sheet-container{ width:800px; margin:0 auto; min-width:800px; }

input,select,textarea{
  font-family:'Dominican', serif;
  font-size:14px;
  padding:2px 6px;
  background:transparent;
  border:none;
}
input[type="text"]{ font-family:'Dominican', serif; }

input[type=number]{
  font-family:'DeutschGothic', monospace;
  font-size:16px;
  text-align:center;
  -moz-appearance:textfield;
}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; }

button{
  font-family:'DominicanSmall', serif;
  padding:4px 6px;
  cursor:pointer;
}

.top-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:20px;
}
.login-controls,.admin-controls{ display:flex; align-items:center; gap:10px; }

/* === Attribute pip styles === */
.pip-base,.pip-current{
  width:20px; height:22px;
  border:none;
  background:transparent;
  display:flex; align-items:center; justify-content:center;
  position:relative;
}
.pip-base input,.pip-current input{
  width:20px; height:22px; font-size:20px;
  border:none; background:transparent; text-align:center;
  font-family:'DeutschGothic', monospace;
  padding:0; margin:0;
}
.pip-base .lock-icon{
  position:absolute; bottom:-10px; left:50%; transform:translateX(-50%);
  width:14px; height:14px; cursor:pointer;
}
.trauma-controls{
  position:absolute; top:0; right:-20px;
  display:flex; flex-direction:column; gap:2px;
}
.trauma-controls button{
  width:18px; height:18px; font-size:12px; font-weight:bold;
  background:#e0e0e0; border:none; cursor:pointer; line-height:1; padding:0;
}

/* === Canvas === */
.sheet-canvas{
  position:relative;
  width:800px; height:950px;
  background:url("img/CharSheet_Block_Lengthened.jpg") no-repeat 0 0 / 100% 100%;
  border:1px solid #000; margin-top:20px;
}
.abs{
  position:absolute;
  left:var(--x,0); top:var(--y,0);
  width:var(--w,auto); height:var(--h,auto);
  z-index:10;
}
/* Overlay text fields */
.abs input[type="text"], .abs select{
  font-family:'Dominican', serif;
  font-size:12px;
  background:transparent;
  padding:2px 6px;
  border:none;
  box-sizing:border-box;
  height:20px;
}
.abs input[type="number"]{
  font-family:'DeutschGothic', monospace;
  font-size:16px; text-align:center;
  height:20px; padding:0 4px;
}
.abs input[type="number"]::-webkit-outer-spin-button,
.abs input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; }

/* Debug baseline outline when on */
.canvas-debug .abs{ outline:1px dashed rgba(0,0,0,.25); }

/* Tabs */
.tabBtn{ background:#eee; border:1px solid #333; }
.tabBtn.active{ background:#333; color:#fff; }

/* === Skill UI bits === */
.skill-num {
  font-family: 'DeutschGothic', monospace;
  font-size: 10px;   /* tiny numerals */
  height: 15px;
  width: 15px;
  text-align: center;
  padding: 0;
  background: transparent;
  border: none;
}

/* Pip checkbox (skill “key” dots) */
.pip-check {
  appearance: none;
  -webkit-appearance: none;
  width: 7px; height: 7px; border-radius: 50%;
  background: transparent; cursor: pointer; display: inline-block;
  padding: 0; margin: 0; line-height: 0; vertical-align: middle;
}
.pip-check:checked { background: white; }
.pip-check:focus { outline: none; }

/* Roll button overlay (uses roll_icon.png, shows '+') */
.roll-btn{
  width:20px; height:20px;
  background:url("img/roll_icon.png") no-repeat center/contain;
  border:none; cursor:pointer;
  font-family:'DeutschGothic';
  font-size:14px; font-weight:bold; color:black;
  text-align:center; line-height:18px; padding:0;
}
.roll-btn:active{ transform:scale(0.9); }

/* FINAL OVERRIDE for tiny skill boxes */
#mainCanvas .skill-num {
  font-size: 10px !important;
  line-height: 1;
  text-align: center;
  padding: 0;
}

/* === Dice Roller mini UI === */
.pool-mini {
  width: 22px; height: 22px;
  border: none; border-radius: 50%;
  background: transparent; color: black;
  font-family: 'DeutschGothic', monospace;
  font-size: 10px; line-height: 22px; text-align: center;
  cursor: pointer; padding: 0; margin: 0;
}
.pool-mini:active { transform: scale(0.95); }

/* Dice pool field */
#dicePool {
  width: 40px; height: 20px;
  font-family: 'DeutschGothic', monospace;
  font-size: 14px; text-align: center;
  background: transparent; border: none;
}

/* Dice grid: up to 20 dice (4×5) */
#diceGrid {
  display: grid;
  grid-template-columns: repeat(5, 26px);
  grid-auto-rows: 26px;
  gap: 3px;
  width: 145px; height: 125px;
}
.die { width: 26px; height: 26px; opacity: 0; animation: dieFade .25s ease forwards; }
@keyframes dieFade { to { opacity: 1; } }

/* Tallies */
.tally-num {
  font-family: 'DeutschGothic', monospace;
  font-size: 16px; width: 28px; text-align: center;
  background: transparent; border: none;
}
#successCount { color: #0a8615; }
#baneCount    { color: #b00020; }

/* Icon buttons */
.icon-btn-sm {
  width: 24px; height: 24px; cursor: pointer;
  transition: transform .15s ease;
}
.icon-btn-sm:active { transform: scale(0.9); }

/* Tiny select for pushes */
#pushesAllowed {
  font-family: 'DominicanSmall';
  font-size: 10px; height: 18px;
  background: transparent; border: 1px solid transparent;
}
  </style>

  <!-- Tab Main overlay + independent ticks/XP (all inside #tabMainWrap) -->
  <style>
    .tab-main-wrap { position: relative; width: 450px; margin: 0 auto; }
    #tabMainBg { display:block; width:100%; height:auto; pointer-events:none; user-select:none; }

    /* Make overlay wrappers hug content (no big panels) */
    .overlay-field { background: transparent; display: inline-block; width: max-content; height: max-content; padding: 0; }

    /* Specific field sizes */
    #archetype1, #archetype2 { width:100px; height:20px; }
    #profession1, #profession2 { width:140px; height:20px; }

    /* XP number */
    .xp-num {
      width: 24px;
      height: 15px;
      font-size: 16px;
      text-align: center;
    }
    .xp-btn {
      width: 18px; height: 18px; font-size: 12px; font-weight: bold; line-height: 1; background: transparent; border: none; cursor: pointer; padding: 0;
    }
    .xp-btn:active { transform: scale(0.95); }

    /* Independent tick styling */
    #tick1, #tick2, #tick3, #tick4 { appearance:none; -webkit-appearance:none; width:12px; height:12px; border:1px solid #000; border-radius:2px; background:transparent; cursor:pointer; margin:0; padding:0; position:absolute; }
    #tick1:checked::after, #tick2:checked::after, #tick3:checked::after, #tick4:checked::after { content: "×"; position: absolute; top: -2px; left: 1px; font-size: 14px; line-height: 12px; color: #000; }
	
	/* Add Talent button */
#addTalentBtn{
  padding:0;                 /* remove padding as requested */
  margin-left:70px;          /* move 70px to the right */
  border:1px solid #000;
  border-radius:0;
  background:#fff;
  box-shadow:0 1px 4px #0002;
  cursor:pointer;
  }
  
  .panel { 
  background: #fff8; 
  border: 1px solid #2228; 
  border-radius: 6px; 
  padding: 8px; 
  box-sizing: border-box; 
}

.panel-header{
  font: 14px/1.2 'DominicanSmall', Georgia, serif;
  font-weight: 700;
  letter-spacing: 0.3px;
  margin-bottom: 6px;
}

#wounds { overflow: visible; } /* allow textarea growth */

.wounds-text{
  width: 100%;
  min-height: 64px;      /* starting height */
  resize: none;          /* we auto-size instead */
  border: none;
  background: #ffff;
  padding: 3px 4px;
  font: 12px/1.35 'Dominican', Georgia, serif;
  box-sizing: border-box;
}
  
  </style>

<style>
  /* adjust the max-height to the space you actually have */
  #woundsText{
    box-sizing: border-box;
    width: 100%;
    max-height: 170px;      /* ← cap it */
    overflow-y: auto;        /* ← scroll once capped */
    resize: none;            /* optional (prevents manual resize) */
  }
</style>


  <!-- ===== Unified Debugger (styles) ===== -->
  <style>
.debugger-panel { position: fixed; right: 12px; bottom: 12px; z-index: 1000000; background: #ffffff; color: #111; border: 1px solid #bbb; font: 9px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 6px; border-radius: 6px; box-shadow: 0 6px 18px rgba(0,0,0,.15); user-select: none; min-width: 190px; }
.debugger-panel .row { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
.debugger-panel input[type="text"], .debugger-panel input[type="number"], .debugger-panel button, .debugger-panel label { font: 9px/1.35 system-ui,system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
.debugger-panel button { border: 1px solid #bbb; background: #f6f6f6; cursor: pointer; }
.debugger-panel .muted { opacity: .75; }
.debug-tooltip,.debug-coord-hud { position: fixed; z-index: 999998; display: none; background: #111; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 3px 5px; font: 9px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; pointer-events: none; white-space: nowrap; }
.debug-crosshair-x, .debug-crosshair-y { position: fixed; z-index: 999996; background: rgba(255,0,0,.85); display: none; pointer-events: none; }
.debug-crosshair-x { height: 1px; left: 0; right: 0; }
.debug-crosshair-y { width: 1px; top: 0; bottom: 0; }
.debug-marquee { position: fixed; z-index: 999997; display: none; border: 1px dashed #0077ff; background: rgba(0,119,255,.12); pointer-events: none; }
.debug-selected { outline: 2px solid #0077ff !important; box-shadow: 0 0 0 2px rgba(0,119,255,.2) inset; }
.debug-outline  { outline:1px dotted rgba(0,0,0,.4) !important; }
.debug-selected-hud { position: fixed; z-index: 999999; background: #111; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 2px 4px; font: 9px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; pointer-events: none; white-space: nowrap; }
.debug-measure { position: fixed; z-index: 999997; display: none; border: 1px dashed #00aa55; background: rgba(0,170,85,.10); pointer-events: none; }
.debug-measure-hud { position: fixed; z-index: 999998; display: none; background:#111; color:#fff; border:1px solid #444; border-radius:4px; padding:2px 4px; pointer-events:none; white-space:nowrap; }
.debugger-panel.compact > :not(:first-child){ display: none; }
  </style>

<!-- ===================== TALENT STYLES (INSIDE MAIN TAB) ===================== -->
<style>
/* ===== Talents area (unchanged container sizes) ===== */
#talentsArea{
  position:absolute; left:0; top:100px; width:450px; margin:0 !important; padding:0;
}
.talents-dropwrap{
  width:450px; height:250px; border:1px dashed #0003; background:transparent; overflow:auto; padding-top:10px;
}
.talents-panel{ display:flex; flex-direction:column; gap:8px; padding-left:0; }

/* ===== Talent cards — match Gear look ===== */
.talent-card{
  display:flex; flex-direction:column; width:100%;
  background:#fff; border:1px solid #000; border-radius:0;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}
.talent-card.min .talent-body, .talent-card.min .card-footer{ display:none !important; }

/* Use the same header pieces as Gear */
.talent-card .card-header{
  display:flex; align-items:center; gap:6px; justify-content:flex-start;
  padding:4px 6px; background:#f2f2f2; border-bottom:1px solid #000; user-select:none;
}
/* Drag stays larger */
.talent-card .drag-handle{
  border:1px solid #000; background:#fff; width:22px; height:22px; line-height:20px; padding:0; cursor:grab;
}
/* Min/Lock are 15×15 like Gear */
.talent-card .min-btn,
.talent-card .lock-btn{
  border:1px solid #000; background:#fff; width:15px; height:15px; line-height:13px; padding:0; cursor:pointer;
}
.talent-card .lock-btn{ background-position:center; background-repeat:no-repeat; background-size:contain; }

/* Stack Min over Lock at far right */
.talent-card .mm-wrap{ display:flex; flex-direction:column; gap:2px; }
.talent-card .hdr-right{ margin-left:auto; display:flex; align-items:flex-start; gap:8px; }

.talent-card .drag-handle{ cursor:grab; }
.talent-card .lock-btn{ background-position:center; background-repeat:no-repeat; background-size:contain; }

.talent-card .card-title{
  flex:1 1 auto; min-width:0; border:none; background:transparent;
  font-family:'GokilNova','DominicanSmall',serif; font-size:16px; text-align:center;
  padding:0; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* Level control at top-right (replaces Gear Bonus area) */
.lvl-wrap{ display:flex; align-items:center; gap:6px; white-space:nowrap; margin-left:auto; }
.lvl-label{ font:11px 'DominicanSmall',serif; text-transform:lowercase; line-height:10px; }
.lvl-select{
  width:44px; height:18px; text-align:center; padding:0 2px;
  font-family:'DeutschGothic', monospace; font-size:12px; background:#fff; border:1px solid #000;
}

/* Body (only description) */
.talent-body{ display:flex; flex-direction:column; padding:8px; }
.talent-body textarea.description{
  width:100%; min-height:72px; border:1px dashed #bbb; background:transparent;
  font-family:'Gothics','Dominican',serif; font-size:11px; resize:vertical; padding:4px; box-sizing:border-box;
}

/* Footer (Remove only) */
.talent-card .card-footer{
  display:flex; gap:6px; justify-content:flex-end;
  padding:6px; border-top:1px solid #000; background:#fafafa;
}
.talent-card .card-footer .remove-btn{
  border:1px solid #000; background:#fff; padding:2px 8px; cursor:pointer; font:12px 'DominicanSmall',serif;
}

/* Lock & hover */
.talent-card.is-locked{ opacity:.96; }
.talent-card:hover{ box-shadow:0 3px 8px #0003; }

/* Drag feedback */
.talent-card.dragging{ opacity:.6 }
.talent-card.drop-target{ outline:2px dashed #0077ff }

/* Disabled look for Remove when locked (same as Gear logic we’ll apply) */
.talent-card .card-footer .remove-btn[disabled]{ opacity:.4; cursor:not-allowed; }
</style>

<!-- =============== END OF TALENT STYLES (INSIDE MAIN TAB) ===================== -->

<!-- =============== START OF GEAR STYLES (INSIDE MAIN TAB) ===================== -->
<style id="gear-cards-css">
/* ================= GEAR PANEL — Toolbar + Encumbrance ================= */
#gearToolbar{
  display:flex; align-items:center; gap:3px; margin-bottom:6px; flex-wrap:nowrap;
}
#gearToolbar button{
  border:1px solid #000; background:#fff; padding:2px 2px; cursor:pointer;
  font:12px 'DominicanSmall',serif; height:26px; line-height:20px;
}

.enc-block{
  margin-left:auto; width:170px; height:50px; border:1px solid #000; border-radius:2px; background:#fff;
  box-sizing:border-box; padding:2px 2px; display:grid; grid-template-rows:14px 1fr 1fr;
}
.enc-title{ font:12px 'DominicanSmall',serif; text-align:center; line-height:14px; margin:0; }
.enc-row{ display:flex; align-items:center; justify-content:center; gap:3px; height:14px; }
.enc-cat{ font:10px 'DominicanSmall',serif; min-width:52px; text-align:right; }
.enc-sub{ font:8px 'DominicanSmall',serif; opacity:.9; line-height:10px; }

/* ===== Input looks (matches Money/Encumbrance) ===== */
.enc-input{
  width:22px; height:15px; text-align:center;
  font-family:'DeutschGothic', monospace; font-size:12px; line-height:12px;
  border:1px solid #000; background:#fff; padding:0; box-sizing:border-box;
}
/* Tiny numeric (Shots / Reload) */
.enc-input-xs{
  width:15px; height:15px; text-align:center;
  font-family:'DeutschGothic', monospace; font-size:10px; line-height:12px;
  border:1px solid #000; background:#fff; padding:0; box-sizing:border-box;
}
/* HARD override to keep Shots/Reload tiny against global input[type=number] rules */
#panel-gear .gear-card .rr-row input.enc-input-xs,
#panel-gear .gear-card .rr-row input[name="shots"],
#panel-gear .gear-card .rr-row input[name="reloadAP"]{
  width:15px !important; height:15px !important;
  font-family:'DeutschGothic', monospace !important; font-size:10px !important; line-height:12px !important;
  padding:0 !important; border:1px solid #000 !important; box-sizing:border-box !important;
}

/* Compact text fields (+2px height as requested) */
.enc-text{
  height:17px;                         /* +2px vs earlier */
  font: 11px 'Dominican', serif;       /* text uses Dominican */
  border:1px solid #000; background:#fff;
  padding:0 4px; box-sizing:border-box;
}
/* Selects: ensure Dominican for text */
.enc-select{
  height:15px;
  font: 11px 'Dominican', serif;       /* text uses Dominican */
  border:1px solid #000; background:#fff;
  padding:0 2px; box-sizing:border-box;
}

/* Damage Type 15px narrower so it stays on one line */
#panel-gear .gear-card .ws-row input[name="damageType"]{
  width:110px;               /* ~15px narrower */
  min-width:90px;
}

/* ================= Boxed field layout ================= */
.field-row{ display:flex; align-items:center; flex-wrap:wrap; gap:6px; } /* base gap between rows */
.field-row.boxed{ gap:2px; } /* gaps between boxes: 2px */
.field-box{
  display:inline-flex; align-items:center;
  border:1px solid #000; padding:0; gap:2px; /* zero padding, tiny internal gap */
}
.field-box > label{ margin:0; padding:0; font:11px 'DominicanSmall',serif; }
.field-box > input[type="number"]{ margin:0; }
.field-box > input[type="text"]{ margin:0; }
.field-box > select{ margin:0; }

/* ================= GEAR CARDS ================= */
#gearPanelInner{
  width:450px; height:350px; border:1px dashed #0003; background:transparent; overflow:auto;
  padding:6px 0 0 0; box-sizing:border-box;
}
.gear-list{ display:flex; flex-direction:column; gap:8px; padding-top:10px; padding-left:0; }

.gear-card{
  position:relative; width:100%;
  background:#fff; border:1px solid #000; border-radius:0; box-shadow:0 2px 6px rgba(0,0,0,.15);
  box-sizing:border-box;
}
.gear-card.min .card-body, .gear-card.min .card-footer{ display:none !important; }

/* -------- Header: drag | title | [stack] | [min over lock] -------- */
.card-header{
  display:flex; align-items:center; gap:6px; justify-content:flex-start;
  padding:4px 6px; background:#f2f2f2; border-bottom:1px solid #000; user-select:none;
}
.drag-handle{ border:1px solid #000; background:#fff; width:22px; height:22px; line-height:20px; padding:0; cursor:grab; }
.card-title{
  flex:1 1 auto; min-width:0; border:none; background:transparent;
  font-family:'GokilNova','DominicanSmall',serif; font-size:16px; text-align:center;
  padding:0; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.hdr-right{ margin-left:auto; display:flex; align-items:flex-start; gap:8px; }

/* 15×15 header controls */
.hdr-15{ width:15px; height:15px; box-sizing:border-box; }
.hdr-btn{ border:1px solid #000; background:#fff; padding:0; cursor:pointer; line-height:13px; text-align:center; }

/* Header stack */
.stack-wrap{ display:flex; flex-direction:column; gap:2px; }
.hdr-row{ display:flex; align-items:center; gap:3px; }
.hdr-label{ display:inline-block; white-space:nowrap; font:11px 'DominicanSmall',serif; text-transform:lowercase; line-height:10px; }

/* Header fields look like Money/Encumbrance */
.gb-input-header, .dmg-input-header{
  width:22px !important; height:15px !important; text-align:center !important;
  font-family:'DeutschGothic', monospace !important; font-size:12px !important; line-height:15px !important;
  border:1px solid #000 !important; background:#fff !important; padding:0 !important; box-sizing:border-box !important;
}
/* Dice icon overlaps the Gear Bonus field a bit */
.gb-wrap{ position:relative; display:inline-block; margin-right:8px; }
.gb-wrap .gb-input-header{ display:block; }
.gb-wrap .gb-roll{
  position:absolute; top:50%; right:-10px; transform:translateY(-50%); pointer-events:auto;
  width:15px; height:15px; cursor:pointer; transform-origin:center;
}
.gb-roll.is-animating{ animation: gb-press 300ms ease; }
@keyframes gb-press{
  0%{ transform:scale(1) rotate(0deg); }
  30%{ transform:scale(0.9) rotate(-10deg); }
  70%{ transform:scale(1.1) rotate(12deg); }
  100%{ transform:scale(1) rotate(0deg); }
}

/* Minimise/Lock stack */
.mm-wrap{ display:flex; flex-direction:column; gap:2px; }
.lock-btn{ background-position:center; background-repeat:no-repeat; background-size:contain; }

/* -------- Body -------- */
.card-body{ display:flex; flex-direction:column; gap:8px; padding:8px; }
.fields-rows{ display:flex; flex-direction:column; gap:6px; }
.field-row label{ font:11px 'DominicanSmall',serif; }

/* W/S row (legacy fallback) */
.ws-row input[type="number"]{
  width:22px; height:15px; text-align:center;
  font-family:'DeutschGothic',monospace; font-size:12px; line-height:12px;
  border:1px solid #000; background:#fff; padding:0; box-sizing:border-box;
}
.ws-row .slash{ font:11px 'DominicanSmall',serif; opacity:.9; }

/* Description */
.card-body textarea.description{
  width:100%; min-height:72px; border:1px dashed #bbb; background:transparent;
  font-family:'Gothics','Dominican',serif; font-size:11px; resize:vertical; padding:4px; box-sizing:border-box;
}

/* Footer */
.card-footer{
  display:flex; gap:6px; justify-content:flex-end; padding:6px; border-top:1px solid #000; background:#fafafa;
}
.card-footer button{
  border:1px solid #000; background:#fff; padding:2px 8px; cursor:pointer; font:12px 'DominicanSmall',serif;
}

/* Visuals */
.gear-card.dragging{ opacity:.6 }
.gear-card.drop-target{ outline:2px dashed #0077ff }
.gear-card.is-locked{ opacity:.96 }
.gear-card.is-locked .card-title{ opacity:.85 }
</style>

<!-- =============== GEAR STYLES (INSIDE MAIN TAB) ===================== -->

<style>
/* ===== Row of boxed fields (3px gap) ===== */
.field-row.row-boxed{
  display:flex;
  flex-wrap:wrap;
  gap:3px;                     /* 3px buffer between boxes */
}

/* Each label+field group lives in a thin bordered box */
.field-box{
  display:inline-flex;
  align-items:center;
  gap:3px;                     /* tiny gap between label and its inputs */
  border:1px solid #000;
  border-radius:2px;
  padding:0;                   /* zero internal padding */
  box-sizing:border-box;
}

/* Labels inside boxes */
.field-box label{
  font:10px/1 'DominicanSmall', serif;
  margin:0 2px 0 3px;
}

/* Small numerics (match Shots/Reload) */
.num-xs{
  width:15px;
  height:15px;
  text-align:center;
  font-family:'DeutschGothic', monospace;
  font-size:10px;
  line-height:12px;
  border:1px solid #000;
  background:#fff;
  padding:0;
  box-sizing:border-box;
}

/* Small text field for "damage type" */
.text-xs{
  height:15px;
  font:11px 'Dominican', serif;          /* Dominican for text */
  border:1px solid #000;
  background:#fff;
  padding:0 3px;
  box-sizing:border-box;
}

/* Make damage type 15px narrower than before (now ~80px) */
.type-text{ width:80px; }

/* Optional: keep the slash tiny & tidy in the W/S box */
.ws-slash{
  font:10px 'DominicanSmall', serif;
  margin:0 2px;
}
</style>
<style>
/* ============================== */
/* GEAR CARDS — FINAL OVERRIDES   */
/* ============================== */

/* 0) Kill oversized numerals anywhere inside gear cards (header + body) */
#panel-gear .gear-card input[type="number"]{
  font-family:'DeutschGothic', monospace;
  font-size:10px;          /* ← small everywhere */
  height:15px;
  line-height:12px;
  padding:0;
  box-sizing:border-box;
}

/* 1) Boxed rows: each label+field lives in a thin bordered box */
.field-row.row-boxed{
  display:flex;
  flex-wrap:wrap;
  gap:3px;                 /* 3px buffer between the boxes */
}

.field-box{
  display:inline-flex;
  align-items:center;
  gap:3px;                 /* tiny gap between label and its input(s) */
  border:1px solid #000;
  border-radius:2px;
  padding:0;               /* zero internal padding */
  box-sizing:border-box;
}

.field-box label{
  font:10px/1 'DominicanSmall', serif;
  margin:0 2px 0 3px;      /* small breathing room inside the box */
}

/* 2) Text selects should be Dominican (NOT Deutsch) inside gear cards */
#panel-gear .gear-card .card-body select.enc-select{
  font-family:'Dominican', serif;
  font-size:11px;
  height:15px;
  line-height:13px;
  border:1px solid #000;
  background:#fff;
  padding:0 2px;
  box-sizing:border-box;
}

/* 3) Compact number inputs for body fields (small font everywhere) */
.num-xs{                    /* tiny (e.g., Shots/Reload) */
  width:15px;
  height:15px;
  text-align:center;
  border:1px solid #000;
  background:#fff;
  padding:0;
}

.num-compact{              /* slightly wider but same small font */
  width:22px;
  height:15px;
  text-align:center;
  border:1px solid #000;
  background:#fff;
  padding:0;
}

/* 4) Damage type text field — 15px narrower */
.text-xs{
  height:15px;
  font:11px 'Dominican', serif;
  border:1px solid #000;
  background:#fff;
  padding:0 3px;
  box-sizing:border-box;
}
.type-text{ width:80px; }  /* narrower so it sticks to the same row */

/* 5) Tiny slash in W/S box */
.ws-slash{
  font:10px 'DominicanSmall', serif;
  margin:0 2px;
}
</style>

<style id="armour-card-css">
/* Tiny header number (same visual language as Shots/Reload) */
#panel-gear .gear-card .arm-input-header{
  width:22px;
  height:15px;
  text-align:center;
  border:1px solid #000;
  background:#fff;
  padding:0;
  box-sizing:border-box;
  font-family:'DeutschGothic', monospace; /* numbers only */
  font-size:10px;
  line-height:12px;
}

/* Small dice icon + slight overlap */
#panel-gear .gear-card .gb-wrap{ position:relative; display:inline-block; margin-right:8px; }
#panel-gear .gear-card .gb-roll.hdr-15{
  width:15px; height:15px; cursor:pointer;
  position:absolute; top:50%; right:-10px; transform:translateY(-50%);
}

/* Keep ALL number inputs inside Armour cards small (scoped to armour only) */
#panel-gear .gear-card[data-card-type="armour"] input[type="number"]{
  font-family:'DeutschGothic', monospace;
  font-size:10px;
  line-height:12px;
  height:15px;
}
</style>


<style>
/* === FINAL OVERRIDES: Encumbrance inputs match Money fields === */
#panel-gear #gearToolbar .enc-block .enc-input{
  width:22px !important;
  height:15px !important;
  font-size:12px !important;           /* same as Money fields */
  line-height:15px !important;
  text-align:center !important;
  padding:0 !important;
  border:1px solid #000 !important;
  font-family:'DeutschGothic', monospace !important;
  box-sizing:border-box !important;
}
</style>


<!-- =============== END OF GEAR STYLES (INSIDE MAIN TAB) ===================== -->

<!-- =============== MONEY STYLES (INSIDE MAIN TAB) ===================== -->
<style id="money-panel-css">
/* Bottom bar container inside the Gear panel */
#gearBottomBar{
  /* no positioning — it will flow under the cards area */
  height:110px;
  display:flex;
  gap:6px;
  align-items:stretch;
  box-sizing:border-box;
  margin-top:6px;   /* a little breathing room under the cards */
}

/* Money panel (fixed width on the left) */
#moneyPanel{
  width:150px;
  height:100%;
  border:1px solid #000;
  border-radius:2px;
  background:#fff;
  box-sizing:border-box;
  padding:4px;
  overflow:auto;
}

#moneyPanel .money-grid{
  display:grid;
  grid-template-columns: 1fr 48px;  /* label | tiny number */
  row-gap:2px;
  column-gap:4px;
}

#moneyPanel label{
  font: 11px/1.1 'DominicanSmall', Georgia, serif;
  margin-top:1px;
  white-space:nowrap;
}

#moneyPanel input[type="number"]{
  width:22px;
  height:15px;
  text-align:center;
  font-family:'DeutschGothic', monospace;
  font-size:12px;               /* matches your Money fields */
  border:1px solid #000;
  padding:0;
}

/* Assets / Property / Vehicles (fills remaining width on the right) */
#assetsPanel{
  flex:1 1 auto;                /* take remaining space */
  height:100%;
  border:1px solid #000;
  border-radius:2px;
  background:#fff;
  box-sizing:border-box;
  padding:4px;
  overflow:hidden;              /* keep tidy */
}

#assetsPanel .assets-header{
  font: 11px 'DominicanSmall', serif;
  margin-bottom:2px;
  white-space:nowrap;
}

#assetsPanel textarea{
  width:100%;
  height:calc(100% - 16px);     /* leaves space for header */
  border:none;
  background:transparent;
  resize:none;
  font-family:Gothics, Dominican, serif; /* same as gear card descriptions */
  font-size:11px;
  line-height:1.3;
  padding:2px;
  box-sizing:border-box;
  overflow:auto;
}
</style>
<!-- =============== END OF MONEY STYLES (INSIDE MAIN TAB) ===================== -->

</head>
<body>

<div class="sheet-container">

  <!-- LOGIN FORM -->
  <div id="loginForm" class="top-row">
    <div class="login-controls">
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button onclick="signIn()">Sign In</button>
      <button onclick="signUp()">Sign Up</button>
    </div>
  </div>

  <!-- ADMIN CONTROLS -->
  <div id="accountControls" class="top-row" style="display:none;">
    <div class="admin-controls">
      <button onclick="signOutUser()">Sign Out</button>
      <button onclick="deleteAccount()">Delete Account</button>
      <button onclick="saveCharacter()">Save</button>
      <button onclick="loadCharacter()">Load</button>
      <label>Saved
        <select id="characterSelect"><option value="">--Select--</option></select>
      </label>
      <button onclick="deleteCharacter()">Delete Character</button>
    </div>
  </div>

  <!-- === Main canvas === -->
  <div class="sheet-canvas" id="mainCanvas">

    <!-- Character Info -->
    <input id="charName" class="abs" type="text" maxlength="40" style="--x:28px; --y:123px; --w:210px;" />
    <input id="ageGroup" class="abs" type="text" maxlength="20" style="--x:262px; --y:123px; --w:90px;" />
    <input id="gender"  class="abs" type="text" maxlength="20" style="--x:382px; --y:123px; --w:80px;" />
    <input id="origin"  class="abs" type="text" maxlength="60" style="--x:482px; --y:123px; --w:250px;" />

    <!-- Attributes -->
    <span class="pip-base abs" style="--x:127px; --y:210px;">
      <input id="brawn" type="number" min="1" max="5" value="1">
      <img id="lock-brawn" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('brawn')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:210px;">
      <input id="brawnCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('brawnCurrent')">+</button>
        <button onclick="stepDownField('brawnCurrent')">−</button>
      </div>
    </span>

    <span class="pip-base abs" style="--x:127px; --y:345px;">
      <input id="agility" type="number" min="1" max="5" value="1">
      <img id="lock-agility" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('agility')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:345px;">
      <input id="agilityCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('agilityCurrent')">+</button>
        <button onclick="stepDownField('agilityCurrent')">−</button>
      </div>
    </span>

    <span class="pip-base abs" style="--x:127px; --y:480px;">
      <input id="wits" type="number" min="1" max="5" value="1">
      <img id="lock-wits" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('wits')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:480px;">
      <input id="witsCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('witsCurrent')">+</button>
        <button onclick="stepDownField('witsCurrent')">−</button>
      </div>
    </span>

    <span class="pip-base abs" style="--x:127px; --y:665px;">
      <input id="will" type="number" min="1" max="5" value="1">
      <img id="lock-will" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('will')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:665px;">
      <input id="willCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('willCurrent')">+</button>
        <button onclick="stepDownField('willCurrent')">−</button>
      </div>
    </span>

    <!-- POWER POINTS (current) -->
    <span class="pip-current abs" style="--x:284px; --y:244px;">
      <input id="powerCurrent" type="number" min="0" max="99" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('powerCurrent')">+</button>
        <button onclick="stepDownField('powerCurrent')">−</button>
      </div>
    </span>

    <!-- ===== BRAWN SKILLS ===== -->
    <input id="endurance_key"   type="checkbox" class="abs pip-check" style="--x:41px; --y:252px;">
    <input id="endurance_lvl"   type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:247px;">
    <input id="endurance_mod"   type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:247px;">
    <input id="endurance_total" type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:247px;">
    <button id="endurance_roll" class="abs roll-btn" style="--x:212px; --y:250px;" onclick="addToDicePool('endurance_total')">+</button>

    <input id="fight_key"       type="checkbox" class="abs pip-check" style="--x:41px; --y:277px;">
    <input id="fight_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:272px;">
    <input id="fight_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:272px;">
    <input id="fight_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:272px;">
    <button id="fight_roll"     class="abs roll-btn" style="--x:212px; --y:301px;" onclick="addToDicePool('fight_total')">+</button>

    <input id="might_key"       type="checkbox" class="abs pip-check" style="--x:41px; --y:301px;">
    <input id="might_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:297px;">
    <input id="might_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:297px;">
    <input id="might_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:297px;">
    <button id="might_roll"     class="abs roll-btn" style="--x:212px; --y:275px;" onclick="addToDicePool('might_total')">+</button>

    <!-- ===== AGILITY SKILLS ===== -->
    <input id="marksmanship_key"   type="checkbox" class="abs pip-check" style="--x:41px; --y:387px;">
    <input id="marksmanship_lvl"   type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:383px;">
    <input id="marksmanship_mod"   type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:383px;">
    <input id="marksmanship_total" type="number"   class="abs skill-num" readonly value="0" style="--x:196px; --y:382px;">
    <button id="marksmanship_roll" class="abs roll-btn" style="--x:212px; --y:385px;" onclick="addToDicePool('marksmanship_total')">+</button>

    <input id="mobility_key"       type="checkbox" class="abs pip-check" style="--x:41px; --y:412px;">
    <input id="mobility_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:407px;">
    <input id="mobility_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:407px;">
    <input id="mobility_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:407px;">
    <button id="mobility_roll"     class="abs roll-btn" style="--x:212px; --y:410px;" onclick="addToDicePool('mobility_total')">+</button>

    <input id="precision_key"      type="checkbox" class="abs pip-check" style="--x:41px; --y:437px;">
    <input id="precision_lvl"      type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:432px;">
    <input id="precision_mod"      type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:432px;">
    <input id="precision_total"    type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:432px;">
    <button id="precision_roll"    class="abs roll-btn" style="--x:212px; --y:435px;" onclick="addToDicePool('precision_total')">+</button>

    <!-- ===== WITS SKILLS ===== -->
    <input id="heal_key"           type="checkbox" class="abs pip-check" style="--x:41px; --y:521px;">
    <input id="heal_lvl"           type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:517px;">
    <input id="heal_mod"           type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:517px;">
    <input id="heal_total"         type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:518px;">
    <button id="heal_roll"         class="abs roll-btn" style="--x:212px; --y:519px;" onclick="addToDicePool('heal_total')">+</button>

    <input id="insight_key"        type="checkbox" class="abs pip-check" style="--x:41px; --y:546px;">
    <input id="insight_lvl"        type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:542px;">
    <input id="insight_mod"        type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:542px;">
    <input id="insight_total"      type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:542px;">
    <button id="insight_roll"      class="abs roll-btn" style="--x:212px; --y:544px;" onclick="addToDicePool('insight_total')">+</button>

    <input id="logic_key"          type="checkbox" class="abs pip-check" style="--x:41px; --y:570px;">
    <input id="logic_lvl"          type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:567px;">
    <input id="logic_mod"          type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:567px;">
    <input id="logic_total"        type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:567px;">
    <button id="logic_roll"        class="abs roll-btn" style="--x:212px; --y:570px;" onclick="addToDicePool('logic_total')">+</button>

    <input id="survival_key"       type="checkbox" class="abs pip-check" style="--x:41px; --y:596px;">
    <input id="survival_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:593px;">
    <input id="survival_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:592px;">
    <input id="survival_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:593px;">
    <button id="survival_roll"     class="abs roll-btn" style="--x:212px; --y:594px;" onclick="addToDicePool('survival_total')">+</button>

    <input id="vigilance_key"      type="checkbox" class="abs pip-check" style="--x:41px; --y:621px;">
    <input id="vigilance_lvl"      type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:617px;">
    <input id="vigilance_mod"      type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:617px;">
    <input id="vigilance_total"    type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:617px;">
    <button id="vigilance_roll"    class="abs roll-btn" style="--x:212px; --y:619px;" onclick="addToDicePool('vigilance_total')">+</button>

    <!-- ===== WILL SKILLS ===== -->
    <input id="inspire_key"        type="checkbox" class="abs pip-check" style="--x:41px; --y:691px;">
    <input id="inspire_lvl"        type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:702px;">
    <input id="inspire_mod"        type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:703px;">
    <input id="inspire_total"      type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:702px;">
    <button id="inspire_roll"      class="abs roll-btn" style="--x:212px; --y:708px;" onclick="addToDicePool('inspire_total')">+</button>

    <input id="manipulate_key"     type="checkbox" class="abs pip-check" style="--x:41px; --y:713px;">
    <input id="manipulate_lvl"     type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:727px;">
    <input id="manipulate_mod"     type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:727px;">
    <input id="manipulate_total"   type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:727px;">
    <button id="manipulate_roll"   class="abs roll-btn" style="--x:212px; --y:730px;" onclick="addToDicePool('manipulate_total')">+</button>

    <input id="resolve_key"        type="checkbox" class="abs pip-check" style="--x:41px; --y:735px;">
    <input id="resolve_lvl"        type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:752px;">
    <input id="resolve_mod"        type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:167px; --y:752px;">
    <input id="resolve_total"      type="number"   class="abs skill-num" readonly value="0" style="--x:197px; --y:751px;">
    <button id="resolve_roll"      class="abs roll-btn" style="--x:212px; --y:755px;" onclick="addToDicePool('resolve_total')">+</button>

    <!-- ===== Dice Roller UI ===== -->
    <input id="dicePool" class="abs" type="number" min="0" max="20" value="0" style="--x:372px; --y:189px;">

    <div id="poolBtns" class="abs" style="--x:368px; --y:220px; --w:125px; --h:75px;">
      <div style="display:grid; grid-template-columns: repeat(5, 22px); grid-auto-rows:22px; gap:3px;">
        <button class="pool-mini" onclick="changePool(+1)">+1</button>
        <button class="pool-mini" onclick="changePool(+2)">+2</button>
        <button class="pool-mini" onclick="changePool(+3)">+3</button>
        <button class="pool-mini" onclick="changePool(+4)">+4</button>
        <button class="pool-mini" onclick="changePool(+5)">+5</button>
        <button class="pool-mini" onclick="changePool(+6)">+6</button>
        <button class="pool-mini" onclick="changePool(+7)">+7</button>
        <button class="pool-mini" onclick="changePool(+8)">+8</button>
        <button class="pool-mini" onclick="changePool(+9)">+9</button>
        <button class="pool-mini" onclick="changePool(+10)">+10</button>
        <button class="pool-mini" onclick="changePool(-1)">-1</button>
        <button class="pool-mini" onclick="changePool(-2)">-2</button>
        <button class="pool-mini" onclick="changePool(-3)">-3</button>
        <button class="pool-mini" onclick="changePool(-4)">-4</button>
        <button class="pool-mini" onclick="changePool(-5)">-5</button>
      </div>
    </div>

    <!-- Dice grid -->
    <div id="diceGrid" class="abs" style="--x:590px; --y:190px;"></div>

    <!-- Tallies -->
    <div class="abs" style="--x:486px; --y:191px;">
      <input id="successCount" class="tally-num" type="text" value="0" readonly>
    </div>
    <div class="abs" style="--x:557px; --y:191px;">
      <input id="baneCount" class="tally-num" type="text" value="0" readonly>
    </div>

    <!-- Roll / Push / Pushes Allowed -->
    <img src="img/roll_icon.png" class="abs icon-btn-sm" style="--x:540px; --y:232px;" alt="Roll" onclick="rollDice()">
    <img src="img/push_icon.png" class="abs icon-btn-sm" style="--x:540px; --y:268px;" alt="Push" onclick="pushRoll()">
    <select id="pushesAllowed" class="abs" style="--x:537px; --y:293px; width:38px;" title="Pushes allowed">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="∞">∞</option>
    </select>

    <!-- Clear All -->
    <img src="img/clear_icon.png" class="abs icon-btn-sm" style="--x:363px; --y:295px;" alt="Clear" onclick="clearAllDice()">

    <!-- Tabs box -->
    <div id="tabBox" class="abs" style="--x:278px; --y:331px; --w:440px; --h:430px; background:transparent; border:none; padding:5px;">
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button type="button" class="tabBtn" data-tab="main"   onclick="showTab('main')">Main</button>
        <button type="button" class="tabBtn" data-tab="combat" onclick="showTab('combat')">Combat</button>
        <button type="button" class="tabBtn" data-tab="gear"   onclick="showTab('gear')">Gear</button>
        <button type="button" class="tabBtn" data-tab="powers" onclick="showTab('powers')">Powers</button>
      </div>

      <!-- panel-main -->
      <div id="panel-main" class="tabPanel" style="display:block;">
        <div class="tab-main-wrap" id="tabMainWrap">
          <img id="tabMainBg" src="img/tab_main.png" alt="Main Tab Background">

          <div class="abs overlay-field" style="--x:7px; --y:25px;" data-dbg="Archetype 1">
            <input id="archetype1" type="text" placeholder="Archetype 1">
          </div>

          <div class="abs overlay-field" style="--x:7px; --y:72px;" data-dbg="Archetype 2">
            <input id="archetype2" type="text" placeholder="Archetype 2">
          </div>

          <div class="abs overlay-field" style="--x:125px; --y:25px;" data-dbg="Profession 1">
            <input id="profession1" type="text" placeholder="Profession 1">
          </div>

          <div class="abs overlay-field" style="--x:125px; --y:72px;" data-dbg="Profession 2">
            <input id="profession2" type="text" placeholder="Profession 2">
          </div>

          <!-- Independent XP controls -->
          <button id="xpMinus" class="abs xp-btn" style="--x:300px; --y:75px;"  type="button" title="XP −1" onclick="stepXp(-1)">−</button>
          <input  id="xp"      class="abs skill-num xp-num" style="--x:283px; --y:55px;" type="number" inputmode="numeric" min="0" step="1" value="0" title="XP">
          <button id="xpPlus"  class="abs xp-btn" style="--x:273px; --y:75px;"  type="button" title="XP +1" onclick="stepXp(+1)">+</button>

          <!-- Independent tick boxes -->
          <input id="tick1" type="checkbox" class="abs" style="--x:333px; --y:37px;">
          <input id="tick2" type="checkbox" class="abs" style="--x:333px; --y:53px;">
          <input id="tick3" type="checkbox" class="abs" style="--x:333px; --y:69px;">
          <input id="tick4" type="checkbox" class="abs" style="--x:333px; --y:86px;">

          <!-- ===== Talents area (INSIDE main panel) ===== -->
          <div id="talentsArea" class="abs" style="--x:0px; --y:100px; --w:450px; --h:250px;">
            <div class="talents-header">
              <button id="addTalentBtn" type="button" title="Add a Talent">+ Add Talent</button>
            </div>
            <div class="talents-dropwrap">
              <section id="talentsPanel" class="talents-panel" aria-label="Character Talents" data-columns="2"></section>
            </div>
          </div>
		
		<!-- Wounds box: same width as Talents, auto-expands with content -->
<div id="wounds" class="abs panel" 
     style="--x:0px; --y:400px; width: 450px; min-height: 30px; max-height: 120px;"
     data-label="MAIN: Wounds">
  <div class="panel-header">Wounds</div>
  <textarea id="woundsText" class="wounds-text" placeholder="Describe wounds, locations, penalties…"></textarea>
</div>

        </div><!-- /#tabMainWrap -->
      </div><!-- /#panel-main -->

<!-- COMBAT PANEL -->
      <div id="panel-combat" class="tabPanel" style="display:none;">Combat coming soon</div>

<!--------------------------- GEAR PANEL ----------------------------->
<div id="panel-gear" class="tabPanel" style="display:none; position:relative; min-height:380px;">

<!-- Toolbar -->
<div id="gearToolbar">
  <button type="button" title="Add Weapon"
          onclick="window.spawnBlankGearCard && spawnBlankGearCard('weapon')">+ Weapon</button>
  <button type="button" title="Catalog"
          onclick="openCatalogPicker('weapons')">Catalog…</button>

  <button type="button" title="Add Armour"
          onclick="window.spawnBlankGearCard && spawnBlankGearCard('armor')">+ Armour</button>
  <button type="button" title="Catalog"
          onclick="openCatalogPicker('armour')">Catalog…</button>

  <button type="button" title="Add Gear"
          onclick="window.spawnBlankGearCard && spawnBlankGearCard('gear')">+ Gear</button>
  <button type="button" title="Catalog"
          onclick="openCatalogPicker('gear')">Catalog…</button>

  <button type="button" title="Add Chemical"
          onclick="window.spawnBlankGearCard && spawnBlankGearCard('chemical')">+ Chemical</button>
  <button type="button" title="Catalog"
          onclick="openCatalogPicker('chemical')">Catalog…</button>

    <!-- Encumbrance box (right side of toolbar) -->
    <div class="enc-block">
      <div class="enc-title">Encumbrance</div>

      <div class="enc-row">
        <span class="enc-cat">Weight</span>
        <span class="enc-sub">Max.</span>
        <input id="encWeightMax" class="enc-input" type="number" min="0" step="1" value="0">
        <span class="enc-sub">Curr.</span>
        <input id="encWeightCur" class="enc-input" type="number" min="0" step="1" value="0">
      </div>

      <div class="enc-row">
        <span class="enc-cat">Stowage</span>
        <span class="enc-sub">Max.</span>
        <input id="encStowMax" class="enc-input" type="number" min="0" step="1" value="0">
        <span class="enc-sub">Curr.</span>
        <input id="encStowCur" class="enc-input" type="number" min="0" step="1" value="0">
      </div>
    </div>
  </div><!-- /#gearToolbar -->

  <!-- Gear cards area (required by the GearCards module) -->
  <div id="gearPanelInner">
    <section class="gear-list"></section>
  </div>
	
<!-- Bottom bar: Money (left, fixed width) + Assets (right, fills) -->
<div id="gearBottomBar">
  <div id="moneyPanel">
    <div class="money-grid">
      <label for="moneyCrown">Crown (₵)</label>
      <input id="moneyCrown" type="number" min="0" max="999" step="1" value="0" oninput="limit3(this)">

      <label for="moneyShilling">Shilling (ș)</label>
      <input id="moneyShilling" type="number" min="0" max="999" step="1" value="0" oninput="limit3(this)">

      <label for="moneyPenny">Penny (ḍ)</label>
      <input id="moneyPenny" type="number" min="0" max="999" step="1" value="0" oninput="limit3(this)">

      <label for="moneyFarthing">Farthing (ƒ)</label>
      <input id="moneyFarthing" type="number" min="0" max="999" step="1" value="0" oninput="limit3(this)">
    </div>
  </div>

  <div id="assetsPanel">
    <div class="assets-header">Assets, Property, Vehicles, etc.</div>
    <textarea id="assetsText" placeholder="List holdings, property deeds, vehicles, investments…"></textarea>
  </div>
</div>


</div>


<!-- ------------------------- POWERS PANEL ---------------->
      <div id="panel-powers" class="tabPanel" style="display:none;">Powers coming soon</div>
    </div><!-- /#tabBox -->

  </div><!-- /#mainCanvas -->
</div><!-- /.sheet-container -->

<!-- Scripts (tabs + small helpers) -->
<script>
/* Tabs */
window.showTab = function(which){
  document.querySelectorAll('.tabPanel').forEach(p=>p.style.display='none');
  const active = document.getElementById('panel-'+which);
  if(active) active.style.display='block';
  document.querySelectorAll('.tabBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab===which);
  });
};

/* Attribute lock toggle (by click on the padlock) */
window.toggleLock = id => {
  const field = document.getElementById(id);
  const icon = document.getElementById(`lock-${id}`);
  if (!field || !icon) return;
  const locked = !field.disabled;
  field.disabled = locked;
  icon.src = locked ? 'img/lock.png' : 'img/lock_open.png';
  field.style.opacity = locked ? 0.6 : 1;
};

/* Programmatic lock setter (used on load) */
window.setLockState = (id, locked) => {
  const field = document.getElementById(id);
  const icon  = document.getElementById(`lock-${id}`);
  if (!field || !icon) return;
  field.disabled = !!locked;
  icon.src = locked ? 'img/lock.png' : 'img/lock_open.png';
  field.style.opacity = locked ? 0.6 : 1;
};

/* Tiny helpers for + / − buttons by the current-value pips */
window.stepUpField   = id => { document.getElementById(id)?.stepUp();   };
window.stepDownField = id => { document.getElementById(id)?.stepDown(); };
</script>

<script>
/* Dice pool add from a skill total */
function addToDicePool(totalId){
  const totalEl = document.getElementById(totalId);
  const add = parseInt(totalEl?.value,10) || 0;
  if (add <= 0) return;
  setPool(Math.min(20, getPool() + add));
}

/* XP helpers */
function stepXp(delta){
  const el = document.getElementById('xp');
  const cur = parseInt(el.value || '0', 10) || 0;
  el.value = Math.max(0, cur + delta);
}
</script>

<script>
  function limit3(el){
    // enforce 0..999 and keep max 3 visible digits
    let v = el.value.replace(/\D/g,'').slice(0,3);
    el.value = v === '' ? '' : Math.min(999, parseInt(v,10));
  }
</script>


<!-- Firebase / Firestore -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVINPqS-nMiWEs7RvabEqKuuUrii2S2MM",
  authDomain: "gxd6-character-sheet.firebaseapp.com",
  projectId: "gxd6-character-sheet",
  storageBucket: "gxd6-character-sheet.firebasestorage.app",
  messagingSenderId: "761778638151",
  appId: "1:761778638151:web:06a1d72423a7e980889062"
};
initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const loginFormEl=document.getElementById('loginForm');
const accountControlsEl=document.getElementById('accountControls');
const characterSelectEl=document.getElementById('characterSelect');

onAuthStateChanged(auth,user=>{
  if(user){
    loginFormEl.style.display='none';
    accountControlsEl.style.display='flex';
    populateCharacterList(user.uid);
  }else{
    loginFormEl.style.display='flex';
    accountControlsEl.style.display='none';
    characterSelectEl.innerHTML='<option value="">--Select--</option>';
  }
});

async function populateCharacterList(uid){
  const snap=await getDocs(collection(db,'users',uid,'characters'));
  characterSelectEl.innerHTML='<option value="">--Select--</option>';
  snap.forEach(d=>{
    const opt=document.createElement('option');opt.value=d.id;opt.text=d.id;characterSelectEl.appendChild(opt);
  });
}

window.signUp=async()=>{
  const em = document.getElementById('email').value.trim();
  const pw = document.getElementById('password').value;
  await createUserWithEmailAndPassword(auth,em,pw);
  alert('Signed up!');
};
window.signIn=async()=>{
  const em = document.getElementById('email').value.trim();
  const pw = document.getElementById('password').value;
  await signInWithEmailAndPassword(auth,em,pw);
  alert('Signed in!');
};
window.signOutUser=async()=>{
 await signOut(auth);
   // optional UI cleanup
  if (window.clearGearCards) window.clearGearCards();
 alert('Signed out'); 
 };

window.deleteAccount=async()=>{
  if(auth.currentUser && confirm('Delete account?')){
    await deleteUser(auth.currentUser);
    alert('Account deleted');
  }
};

window.saveCharacter=async()=>{
  const user=auth.currentUser;
  const name=document.getElementById('charName').value.trim();
  if(!user||!name) return alert('Sign in & name required');

  const data={};
  document.querySelectorAll('#mainCanvas input, #mainCanvas select, #tabBox input, #tabBox select, #tabBox textarea').forEach(el=>{
    if(!el.id || el.id.startsWith('lock')) return;
    data[el.id] = (el.type==='checkbox') ? el.checked : el.value;
  });

  // Persist talents separately
  if(window.exportCharacterTalents){
    data.__talents = window.exportCharacterTalents();
  }
  
  // Persist gear cards
if(window.exportCharacterGear){
  data.__gear = window.exportCharacterGear();
}

// Persist attribute base lock states
data.__attrLocks = {
  brawn:   !!document.getElementById('brawn')?.disabled,
  agility: !!document.getElementById('agility')?.disabled,
  wits:    !!document.getElementById('wits')?.disabled,
  will:    !!document.getElementById('will')?.disabled
};

  await setDoc(doc(db,'users',user.uid,'characters',name),data);
  alert('Saved');
  populateCharacterList(user.uid);
};

window.loadCharacter=async()=>{
  const user=auth.currentUser;
  if(!user) return alert('Sign in first');

  const id=characterSelectEl.value || document.getElementById('charName').value.trim();
  if(!id) return alert('Choose or type name');

  const snap=await getDoc(doc(db,'users',user.uid,'characters',id));
  if(!snap.exists()) return alert('Not found');

  const data=snap.data();
  Object.keys(data).forEach(k=>{
    if(k==='__talents') return;
    const el=document.getElementById(k);
    if(el && !k.startsWith('lock')){
      (el.type==='checkbox') ? el.checked=!!data[k] : el.value=(data[k] ?? '');
    }
  });

  // >>> Clears the current talents UI/state) <<<
  if (window.clearTalentsPanel) window.clearTalentsPanel();

  document.getElementById('charName').value = id;
  characterSelectEl.value = id;

  if(window.importCharacterTalents){
    window.importCharacterTalents(Array.isArray(data.__talents)? data.__talents : []);
  }
  
  const locks = data.__attrLocks || {};
  if (typeof window.setLockState === 'function') {
    window.setLockState('brawn',   !!locks.brawn);
    window.setLockState('agility', !!locks.agility);
    window.setLockState('wits',    !!locks.wits);
    window.setLockState('will',    !!locks.will);
  }
  
 // Clear any previous gear cards and import fresh ones
if (window.clearGearCards) window.clearGearCards();
if (window.importCharacterGear){
  window.importCharacterGear(Array.isArray(data.__gear) ? data.__gear : []);
} 

// --- Back-compat for old encumbrance keys (pre-Weight/Stowage split)
if (!data.encWeightMax && data.encMax) {
  const el = document.getElementById('encWeightMax');
  if (el) el.value = data.encMax;
}
if (!data.encWeightCur && data.encCurrent) {
  const el = document.getElementById('encWeightCur');
  if (el) el.value = data.encCurrent;
}

  initAllSkillTotals();
  alert('Loaded');
};

window.deleteCharacter=async()=>{
  const user=auth.currentUser; const name=characterSelectEl.value;
  if(!user||!name) return alert('Select a character');
  if(confirm(`Delete "${name}"?`)){
    await deleteDoc(doc(db,'users',user.uid,'characters',name));
    alert('Deleted');
    populateCharacterList(user.uid);
  }
};
</script>

<!-- Skill totals -->
<script>
function toNum(v){ const n = parseInt(v,10); return isNaN(n) ? 0 : n; }
function setupSkillRow(attrCurrentId, baseId){
  const attrEl  = document.getElementById(attrCurrentId);
  const lvlEl   = document.getElementById(`${baseId}_lvl`);
  const modEl   = document.getElementById(`${baseId}_mod`);
  const totalEl = document.getElementById(`${baseId}_total`);
  if(!attrEl || !lvlEl || !modEl || !totalEl) return;
  const recalc = () => { totalEl.value = toNum(attrEl.value) + toNum(lvlEl.value) + toNum(modEl.value); };
  ['input','change'].forEach(ev=>{
    attrEl.addEventListener(ev,recalc);
    lvlEl.addEventListener(ev,recalc);
    modEl.addEventListener(ev,recalc);
  });
  recalc();
}
function initBrawnSkillTotals(){ setupSkillRow('brawnCurrent','endurance'); setupSkillRow('brawnCurrent','fight'); setupSkillRow('brawnCurrent','might'); }
function initAgilitySkillTotals(){ setupSkillRow('agilityCurrent','marksmanship'); setupSkillRow('agilityCurrent','mobility'); setupSkillRow('agilityCurrent','precision'); }
function initWitsSkillTotals(){ setupSkillRow('witsCurrent','heal'); setupSkillRow('witsCurrent','insight'); setupSkillRow('witsCurrent','logic'); setupSkillRow('witsCurrent','survival'); setupSkillRow('witsCurrent','vigilance'); }
function initWillSkillTotals(){ setupSkillRow('willCurrent','inspire'); setupSkillRow('willCurrent','manipulate'); setupSkillRow('willCurrent','resolve'); }
function initAllSkillTotals(){ initBrawnSkillTotals(); initAgilitySkillTotals(); initWitsSkillTotals(); initWillSkillTotals(); }

document.addEventListener('DOMContentLoaded', initAllSkillTotals);
</script>

<!-- Dice Roller Logic -->
<script>
let diceValues = [];
let pushCount  = 0;

function getPool(){
  return Math.max(0, Math.min(20, parseInt(document.getElementById('dicePool').value,10) || 0));
}
function setPool(n){
  const v = Math.max(0, Math.min(20, n|0));
  const el = document.getElementById('dicePool');
  el.value = v;
  return v;
}
function changePool(delta){ setPool(getPool() + delta); }

function clearAllDice(){
  diceValues.length = 0;
  pushCount = 0;
  document.getElementById('diceGrid').innerHTML = '';
  document.getElementById('successCount').value = '0';
  document.getElementById('baneCount').value    = '0';
  setPool(0);
}

function rollDice(){
  const pool = getPool();
  if (pool <= 0) return;
  pushCount = 0;
  diceValues = Array.from({length: pool}, () => randD6());
  animateDiceRoll();
}

function pushRoll(){
  if (!diceValues.length) return;
  const maxPush = document.getElementById('pushesAllowed').value;
  if (maxPush !== '∞' && pushCount >= parseInt(maxPush,10)) return;

  for (let i=0;i<diceValues.length;i++){
    const d = diceValues[i];
    if (d > 1 && d < 6) diceValues[i] = randD6();
  }
  pushCount++;
  animateDiceRoll();
}

function animateDiceRoll(){
  const grid = document.getElementById('diceGrid');
  const flashes = 4;
  let frame = 0;

  const iv = setInterval(() => {
    grid.innerHTML = '';
    for (let i=0;i<diceValues.length && i<20;i++){
      const show = (frame < flashes - 1) ? randD6() : diceValues[i];
      grid.appendChild(renderDie(show));
    }
    frame++;
    if (frame >= flashes){
      clearInterval(iv);
      updateTallies();
    }
  }, 110);
}

function randD6(){ return (Math.random()*6|0)+1; }
function renderDie(v){
  const img = document.createElement('img');
  img.className = 'die';
  if (v === 1)      img.src = 'img/Baned6.png';
  else if (v === 6) img.src = 'img/Success_d6.png';
  else              img.src = `img/${v}_d6.png`;
  img.alt = String(v);
  return img;
}
function updateTallies(){
  const succ = diceValues.filter(d=>d===6).length;
  const bane = diceValues.filter(d=>d===1).length;
  document.getElementById('successCount').value = succ;
  document.getElementById('baneCount').value    = bane;
}
</script>

<!-- Unified Debugger (unchanged JS) -->
<script>
(()=>{
  let TARGET_SELECTOR = '.abs';
  let debugOn = false, hoverEnabled = false, marqueeActive = false, cursorMode = false, measureMode = false;
  let selected = new Set();
  let startX = 0, startY = 0;
  let draggingEl = null, dragOffsetX = 0, dragOffsetY = 0;

  const canvas = document.getElementById('mainCanvas');

  const tooltip = document.createElement('div');
  tooltip.className = 'debug-tooltip'; document.body.appendChild(tooltip);

  const marquee = document.createElement('div');
  marquee.className = 'debug-marquee'; document.body.appendChild(marquee);

  const crossX = document.createElement('div');
  crossX.className = 'debug-crosshair-x'; document.body.appendChild(crossX);
  const crossY = document.createElement('div');
  crossY.className = 'debug-crosshair-y'; document.body.appendChild(crossY);

  const coordHUD = document.createElement('div');
  coordHUD.className = 'debug-coord-hud'; coordHUD.textContent = 'X: 0  Y: 0';
  document.body.appendChild(coordHUD);

  const measureBox = document.createElement('div');
  measureBox.className = 'debug-measure'; document.body.appendChild(measureBox);
  const measureHUD = document.createElement('div');
  measureHUD.className = 'debug-measure-hud'; measureHUD.textContent = '0 × 0';
  document.body.appendChild(measureHUD);
  let measureActive = false;

  function getXY(el){
    const x = parseFloat(el.style.getPropertyValue('--x')) || 0;
    const y = parseFloat(el.style.getPropertyValue('--y')) || 0;
    return [x,y];
  }
  function refreshSelectedHUD(){
    document.querySelectorAll('.debug-selected-hud').forEach(n => n.remove());
    if (!debugOn || !selected.size) return;
    selected.forEach(el => {
      const hud = document.createElement('div');
      hud.className = 'debug-selected-hud';
      const [x,y] = getXY(el);
      hud.textContent = `${el.id ? '#'+el.id : el.tagName.toLowerCase()} (${Math.round(x)}, ${Math.round(y)})`;
      const rect = el.getBoundingClientRect();
      hud.style.left = Math.max(0, Math.min(window.innerWidth - 8, rect.left)) + 'px';
      hud.style.top  = Math.max(0, rect.top - 14) + 'px';
      document.body.appendChild(hud);
    });
  }

  const panel = document.createElement('div');
  panel.className = 'debugger-panel';
  panel.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <strong>Debugger</strong>
      <label class="row" title="Enable/disable debugger">
        <input id="dbg-toggle" type="checkbox"><span>On</span>
      </label>
    </div>

    <div class="row"><span class="muted">Selector</span></div>
    <input id="dbg-selector" type="text" value="${'.abs'}" title="CSS selector for debug targets">

    <div class="row" style="justify-content:space-between; margin-top:6px">
      <label class="row" title="Show crosshair + cursor coordinates">
        <input id="dbg-cursor" type="checkbox" checked><span>Cursor mode</span>
      </label>
      <label class="row" title="Drag on canvas to measure W×H in px">
        <input id="dbg-measure" type="checkbox"><span>Measure mode</span>
      </label>
    </div>
    <div class="row"><span class="muted">D=toggle • C=cursor • Alt=tooltip • Shift+drag=marquee • Drag=move • Arrows=nudge • Ctrl=5px</span></div>

    <hr style="border:none;border-top:1px solid #ddd;margin:8px 0" />

    <div class="row">
      <input id="dbg-left-x" class="grow" type="number" placeholder="Left X (px)">
      <button id="dbg-align-left" type="button" title="Set all selected left to X">Align Left</button>
    </div>
    <div class="row">
      <input id="dbg-top-y" class="grow" type="number" placeholder="Top Y (px)">
      <button id="dbg-align-top" type="button" title="Set all selected top to Y">Align Top</button>
    </div>

    <div class="row">
      <input id="dbg-center-x" class="grow" type="number" placeholder="Center X (px) — empty = use first">
      <button id="dbg-center-x-btn" type="button" title="Center each selected at this X">Align Center X</button>
    </div>
    <div class="row">
      <input id="dbg-center-y" class="grow" type="number" placeholder="Center Y (px) — empty = use first">
      <button id="dbg-center-y-btn" type="button" title="Center each selected at this Y">Align Center Y</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="dbg-clear" type="button" title="Clear selection">Clear selection</button>
      <button id="dbg-log" type="button" title="Log selected coords to console">Log coords</button>
    </div>

    <hr style="border:none;border-top:1px solid #ddd;margin:8px 0" />

    <div class="row" style="justify-content:space-between">
      <button id="dbg-export" type="button" title="Download selected positions as JSON">Export JSON</button>
      <button id="dbg-import" type="button" title="Import positions from JSON">Import JSON</button>
      <button id="dbg-export-html" type="button" title="Download a <style> block you can paste">Export HTML</button>
      <input id="dbg-file" type="file" accept="application/json" style="display:none">
    </div>
  `;
  document.body.appendChild(panel);

  (function(){
    const headerRow = panel.querySelector('.row');
    if (headerRow) headerRow.style.cursor = 'pointer';
    function setCompact(on){ panel.classList.toggle('compact', !!on); }
    setCompact(true);
    headerRow && headerRow.addEventListener('click', function(e){
      const tgt = e.target;
      if (tgt && (tgt.id === 'dbg-toggle' || (tgt.closest && tgt.closest('#dbg-toggle')))) return;
      setCompact(!panel.classList.contains('compact'));
    });
    const toggle = document.getElementById('dbg-toggle');
    if (toggle){
      toggle.addEventListener('change', function(){
        setCompact(!toggle.checked);
        debugOn = toggle.checked;
        document.getElementById('dbg-cursor').checked = true;
        setCursorMode(debugOn);
        canvas.classList.toggle('canvas-debug', debugOn);
        if (!debugOn) { hideTooltip(); clearSelection(); setMeasureMode(false); }
        else { refreshSelectedHUD(); }
      });
      setCompact(!toggle.checked);
    }
  })();

  const $ = sel => document.querySelector(sel);
  const selectorEl = $('#dbg-selector');
  const cursorEl   = $('#dbg-cursor');
  const measureEl  = $('#dbg-measure');
  const clearBtn   = $('#dbg-clear');
  const logBtn     = $('#dbg-log');
  const leftInput  = $('#dbg-left-x');
  const topInput   = $('#dbg-top-y');
  const centerXInp = $('#dbg-center-x');
  const centerYInp = $('#dbg-center-y');
  const alignLeft  = $('#dbg-align-left');
  const alignTop   = $('#dbg-align-top');
  const centerXBtn = $('#dbg-center-x-btn');
  const centerYBtn = $('#dbg-center-y-btn');
  const exportBtn  = $('#dbg-export');
  const importBtn  = $('#dbg-import');
  const exportHtmlBtn = $('#dbg-export-html');
  const fileInput  = $('#dbg-file');

  const inCanvas = el => canvas && canvas.contains(el);
  const isTarget = el => !!(el && el.matches && el.matches(TARGET_SELECTOR) && inCanvas(el));

  function setXY(el, x, y){
    el.style.setProperty('--x', x + 'px');
    el.style.setProperty('--y', y + 'px');
    refreshSelectedHUD();
  }
  function clampToCanvas(el, x, y){
    const maxX = canvas.clientWidth  - el.offsetWidth;
    const maxY = canvas.clientHeight - el.offsetHeight;
    return [ Math.max(0, Math.min(x, maxX)), Math.max(0, Math.min(y, maxY)) ];
  }
  function centerOnX(el, cx){
    const r = el.getBoundingClientRect();
    const parent = canvas.getBoundingClientRect();
    const newLeft = Math.round(cx - (r.width/2) - parent.left);
    const [nx] = clampToCanvas(el, newLeft, getXY(el)[1]);
    setXY(el, nx, getXY(el)[1]);
  }
  function centerOnY(el, cy){
    const r = el.getBoundingClientRect();
    const parent = canvas.getBoundingClientRect();
    const newTop = Math.round(cy - (r.height/2) - parent.top);
    const [,ny] = clampToCanvas(el, getXY(el)[0], newTop);
    setXY(el, getXY(el)[0], ny);
  }

  function labelFor(el) { const id = el.id ? `#${el.id}` : el.tagName.toLowerCase(); const [x,y] = getXY(el); return `${id} (${Math.round(x)}, ${Math.round(y)})`; }
  function showTooltip(el, x, y) {
    el.classList.add('debug-outline');
    tooltip.textContent = labelFor(el);
    const tx = Math.min(window.innerWidth - 8, (x ?? el.getBoundingClientRect().left) + 8);
    const ty = Math.min(window.innerHeight - 8, (y ?? el.getBoundingClientRect().top) + 8);
    tooltip.style.left = tx + 'px';
    tooltip.style.top  = ty + 'px';
    tooltip.style.display = 'block';
  }
  function hideTooltip() { tooltip.style.display = 'none'; document.querySelectorAll('.debug-outline').forEach(n => n.classList.remove('debug-outline')); }

  function rectFromPoints(x1,y1,x2,y2){ const left = Math.min(x1,x2), top = Math.min(y1,y2); const width = Math.abs(x2-x1), height = Math.abs(y2-y1); return {left, top, width, height, right:left+width, bottom:top+height}; }
  function intersects(a, b){ return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom); }
  function pageRect(el){ const r = el.getBoundingClientRect(); return {left:r.left, top:r.top, right:r.right, bottom:r.bottom}; }

  function clearSelection() { selected.forEach(el => el.classList.remove('debug-selected')); selected.clear(); refreshSelectedHUD(); }
  function addToSelection(el) { if (!selected.has(el)) { selected.add(el); el.classList.add('debug-selected'); } refreshSelectedHUD(); }

  function nudge(el, dx, dy) { const [x,y] = getXY(el); const [nx, ny] = clampToCanvas(el, x + dx, y + dy); setXY(el, nx, ny); }

  function cssPath(el) { const parts = []; for (let node = el; node && node.nodeType === 1 && node !== canvas; node = node.parentElement) { let sel = node.tagName.toLowerCase(); if (node.id) { sel += `#${node.id}`; parts.unshift(sel); break; } let sibIndex = 1, sib = node; while ((sib = sib.previousElementSibling) && sib.tagName === node.tagName) sibIndex++; sel += `:nth-of-type(${sibIndex})`; parts.unshift(sel); } return parts.join(' > '); }
  function keyFor(el){ return el.id ? `#${el.id}` : cssPath(el); }
  function findByKey(key){ if (!key) return null; if (key.startsWith('#')) return canvas.querySelector(key); return canvas.querySelector(key); }

  function exportSelection() { const items = [...selected].map(el => { const [left, top] = getXY(el); return { key: keyFor(el), left, top }; }); return { version: 1, items }; }
  function importPositions(json) { const items = Array.isArray(json) ? json : (json?.items || []); const result = { applied: 0, total: items.length, unmatched: [] }; items.forEach(item => { const el = findByKey(item.key); if (!el) { result.unmatched.push(item.key || '(no key)'); return; } const [x,y] = clampToCanvas(el, item.left ?? 0, item.top ?? 0); setXY(el, x, y); result.applied++; }); return result; }

  const $qs = sel => document.querySelector(sel);
  selectorEl.addEventListener('change', () => { TARGET_SELECTOR = selectorEl.value.trim() || TARGET_SELECTOR; clearSelection(); });
  cursorEl.addEventListener('change', () => setCursorMode(cursorEl.checked));
  measureEl.addEventListener('change', () => setMeasureMode(measureEl.checked));
  clearBtn.addEventListener('click', clearSelection);
  logBtn.addEventListener('click', () => { if (!selected.size) return; console.table([...selected].map(el => ({ key:keyFor(el), x:getXY(el)[0], y:getXY(el)[1] }))); });
  alignLeft.addEventListener('click', () => { const x = parseFloat(leftInput.value); if (Number.isNaN(x)) return; selected.forEach(el => setXY(el, clampToCanvas(el, x, getXY(el)[1])[0], getXY(el)[1])); });
  alignTop.addEventListener('click', () => { const y = parseFloat(topInput.value); if (Number.isNaN(y)) return; selected.forEach(el => setXY(el, getXY(el)[0], clampToCanvas(el, getXY(el)[0], y)[1])); });
  centerXBtn.addEventListener('click', () => { if (!selected.size) return; let cx = parseFloat(centerXInp.value); if (Number.isNaN(cx)) { const first = [...selected][0].getBoundingClientRect(); cx = Math.round(first.left + first.width/2); } selected.forEach(el => centerOnX(el, cx)); });
  centerYBtn.addEventListener('click', () => { if (!selected.size) return; let cy = parseFloat(centerYInp.value); if (Number.isNaN(cy)) { const first = [...selected][0].getBoundingClientRect(); cy = Math.round(first.top + first.height/2); } selected.forEach(el => centerOnY(el, cy)); });

  function currentCharName() { const n = document.getElementById('charName')?.value?.trim(); return n ? n.replace(/[^\w\-]+/g, '_') : 'positions'; }

  exportBtn.addEventListener('click', () => { const data = exportSelection(); if (!data.items.length) { alert('Select at least one element to export.'); return; } const json = JSON.stringify(data, null, 2); const blob = new Blob([json], { type: 'application/json;charset=utf-8' }); const a = document.createElement('a'); const ts = new Date().toISOString().replace(/[:.]/g,'-'); a.href = URL.createObjectURL(blob); a.download = `${currentCharName()}-debug-positions-${ts}.json`; document.body.appendChild(a); a.click(); setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0); });

  importBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => { const file = fileInput.files?.[0]; if (!file) return; const reader = new FileReader(); reader.onload = () => { try { const json = JSON.parse(String(reader.result)); const res = importPositions(json); alert(`Import complete: ${res.applied}/${res.total} applied.\nUnmatched: ${res.unmatched.length}`); console.log('Unmatched keys:', res.unmatched); } catch (e) { alert('Invalid JSON file.'); console.error(e); } fileInput.value = ''; }; reader.readAsText(file); });

  function selectorFor(el) { if (el.id) return `#${el.id}`; const parts = []; let node = el; while (node && node.nodeType === 1 && node !== canvas) { let sel = node.tagName.toLowerCase(); const parent = node.parentElement; if (node.id) { sel += `#${node.id}`; parts.unshift(sel); break; } const siblings = parent ? Array.from(parent.children).filter(n => n.tagName === node.tagName) : []; const idx = siblings.indexOf(node) + 1; sel += `:nth-of-type(${idx})`; parts.unshift(sel); node = parent; } return `#mainCanvas > ${parts.join(' > ')}`; }
  function exportSelectedAsHTML() { const items = [...selected]; if (!items.length) { alert('Select at least one element to export.'); return; } let css = `/* Exported positions (${new Date().toISOString()}) */\n`; items.forEach(el => { const [x, y] = getXY(el); css += `${selectorFor(el)}{ --x:${Math.round(x)}px; --y:${Math.round(y)}px; }\n`; }); const htmlDoc =
`<!doctype html>
<html><head><meta charset="utf-8"><title>GxD6 Positions</title></head>
<body>
<style id="exported-positions">
${css}
</style>
<!-- Paste the <style> block above into your main HTML (after base styles), or include as a separate CSS file -->
</body></html>`; const blob = new Blob([htmlDoc], { type: 'text/html;charset=utf-8' }); const a = document.createElement('a'); const ts = new Date().toISOString().replace(/[:.]/g,'-'); a.href = URL.createObjectURL(blob); a.download = `${currentCharName()}-positions-${ts}.html`; document.body.appendChild(a); a.click(); setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0); }
  exportHtmlBtn.addEventListener('click', exportSelectedAsHTML);

  window.addEventListener('keydown', e => { if (e.key === 'd' || e.key === 'D') { if (document.activeElement && ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return; const t = document.getElementById('dbg-toggle'); t.checked = !t.checked; t.dispatchEvent(new Event('change')); } if (e.key === 'c' || e.key === 'C') { const c = document.getElementById('dbg-cursor'); c.checked = !c.checked; setCursorMode(c.checked); } if (debugOn && e.altKey) hoverEnabled = true; });
  window.addEventListener('keyup',   e => { if (debugOn && !e.altKey) { hoverEnabled = false; hideTooltip(); } });
  window.addEventListener('scroll',  () => { if (debugOn) refreshSelectedHUD(); });
  window.addEventListener('resize',  () => { if (debugOn) refreshSelectedHUD(); });

  document.addEventListener('mouseover', e => { if (!debugOn || !hoverEnabled) return; const t = e.target.closest(TARGET_SELECTOR); if (isTarget(t)) showTooltip(t, e.clientX, e.clientY); }, {capture:true});
  document.addEventListener('mousemove', e => { if (!debugOn || !hoverEnabled || tooltip.style.display !== 'block') return; tooltip.style.left = Math.min(window.innerWidth - 8, e.clientX + 8) + 'px'; tooltip.style.top  = Math.min(window.innerHeight - 8, e.clientY + 8) + 'px'; });
  document.addEventListener('mouseout', e => { if (!debugOn || !hoverEnabled) return; const t = e.target.closest(TARGET_SELECTOR); if (isTarget(t)) hideTooltip(); }, {capture:true});

  canvas.addEventListener('mousedown', e => { if (!debugOn || !e.shiftKey || measureMode) return; marqueeActive = true; startX = e.clientX; startY = e.clientY; Object.assign(marquee.style, { left:startX+'px', top:startY+'px', width:'0px', height:'0px', display:'block' }); e.preventDefault(); });
  window.addEventListener('mousemove', e => { if (!debugOn || !marqueeActive) return; const box = rectFromPoints(startX, startY, e.clientX, e.clientY); Object.assign(marquee.style, { left:box.left+'px', top:box.top+'px', width:box.width+'px', height:box.height+'px' }); clearSelection(); canvas.querySelectorAll(TARGET_SELECTOR).forEach(el => { const r = pageRect(el); if (intersects(box, r)) addToSelection(el); }); });
  window.addEventListener('mouseup', () => { if (!debugOn || !marqueeActive) return; marqueeActive = false; marquee.style.display = 'none'; });

  function setMeasureMode(on){ measureMode = !!on; if (!measureMode){ measureActive=false; measureBox.style.display='none'; measureHUD.style.display='none'; } }
  canvas.addEventListener('mousedown', e => { if (!debugOn || !measureMode) return; const t = e.target.closest(TARGET_SELECTOR); if (t) return; measureActive = true; startX = e.clientX; startY = e.clientY; Object.assign(measureBox.style, { left:startX+'px', top:startY+'px', width:'0px', height:'0px', display:'block' }); measureHUD.style.display = 'block'; e.preventDefault(); });
  window.addEventListener('mousemove', e => { if (!debugOn || !measureMode || !measureActive) return; let x2 = e.clientX, y2 = e.clientY; if (e.ctrlKey){ const snap = v => Math.round(v / 5) * 5; x2 = snap(x2); y2 = snap(y2); } const box = rectFromPoints(startX, startY, x2, y2); Object.assign(measureBox.style, { left:box.left+'px', top:box.top+'px', width:box.width+'px', height:box.height+'px' }); measureHUD.textContent = `${box.width} × ${box.height}px`; measureHUD.style.left = (box.left + box.width + 8) + 'px'; measureHUD.style.top  = (box.top - 2) + 'px'; });
  window.addEventListener('mouseup', () => { if (!debugOn || !measureMode || !measureActive) return; measureActive = false; measureBox.style.display = 'none'; measureHUD.style.display = 'none'; });

  let selectedBeforeDrag = null;
  canvas.addEventListener('mousedown', e => {
    if (!debugOn || e.shiftKey || measureMode) return;
    const t = e.target.closest(TARGET_SELECTOR);
    if (!isTarget(t)) return;
    if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT')) return;
    if (!selected.has(t)) { clearSelection(); addToSelection(t); }
    selectedBeforeDrag = t;
    draggingEl = t;
    const [x,y] = getXY(t);
    const crect = canvas.getBoundingClientRect();
    dragOffsetX = e.clientX - (crect.left + x);
    dragOffsetY = e.clientY - (crect.top  + y);
    e.preventDefault();
  });
  window.addEventListener('mousemove', e => {
    if (!debugOn || !draggingEl) return;
    const crect = canvas.getBoundingClientRect();
    let nx = e.clientX - crect.left - dragOffsetX;
    let ny = e.clientY - crect.top  - dragOffsetY;
    [nx, ny] = clampToCanvas(draggingEl, nx, ny);
    setXY(draggingEl, nx, ny);
  });
  window.addEventListener('mouseup', () => { draggingEl = null; selectedBeforeDrag = null; });

  document.addEventListener('click', e => { if (!debugOn || e.shiftKey || measureMode) return; const t = e.target.closest(TARGET_SELECTOR); if (!isTarget(t)) return; clearSelection(); addToSelection(t); }, true);

  function setCursorMode(on) { cursorMode = !!on; const disp = on && debugOn ? 'block' : 'none'; crossX.style.display = disp; crossY.style.display = disp; coordHUD.style.display = disp; }
  window.addEventListener('mousemove', e => { if (!debugOn || !cursorMode) return; const x = e.clientX, y = e.clientY; crossX.style.top = y + 'px'; crossY.style.left = x + 'px'; coordHUD.style.left = (x + 10) + 'px'; coordHUD.style.top  = (y + 10) + 'px'; coordHUD.textContent = `X: ${x}   Y: ${y}`; });
})();
</script>

<!-- ===================== TALENT CARDS ===================== -->
<script>
(() => {
  const panel = document.getElementById('talentsPanel');
  const addBtn = document.getElementById('addTalentBtn');
  if (!panel || !addBtn) { console.warn('[TALENTS] containers missing'); return; }

  let charTalents = [];

  // ----- Public API (save/load uses these) -----
  window.exportCharacterTalents = () =>
    charTalents.map(t => ({
      id: t.id, name: String(t.name||''), level: String(t.level||'-'),
      desc: String(t.desc||''), _min: !!t._min, _locked: !!t._locked
    }));

  window.importCharacterTalents = (list) => {
    charTalents = Array.isArray(list) ? list.map(sanitize) : [];
    renderPanel();
  };

  window.clearTalentsPanel = () => { charTalents = []; renderPanel(); };

  // ----- Add button -----
  addBtn.addEventListener('click', () => {
    const t = { id: uid(), name: 'New Talent', level: '-', desc: '', _min: false, _locked: false };
    charTalents.push(t);
    renderPanel();
  });

  // ----- Drag & drop reorder (handle-only) -----
  if (!panel.dataset.ddInit){
    panel.dataset.ddInit = '1';
    panel.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const after = getCardAfterY(panel, e.clientY);
      const dragging = panel.querySelector('.talent-card.dragging');
      if (!dragging) return;
      if (after == null) panel.appendChild(dragging);
      else panel.insertBefore(dragging, after);
      clearDropTargets();
      (after || dragging)?.classList.add('drop-target');
    });
    panel.addEventListener('drop', ()=> clearDropTargets());
  }
  function clearDropTargets(){ panel.querySelectorAll('.drop-target').forEach(n=>n.classList.remove('drop-target')); }
  function getCardAfterY(container, y){
    const cards = [...container.querySelectorAll('.talent-card:not(.dragging)')];
    return cards.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if (offset < 0 && offset > closest.offset) return {offset, element:child};
      return closest;
    }, {offset: Number.NEGATIVE_INFINITY, element: null}).element;
  }

  // ----- Render -----
  function renderPanel(){
    panel.innerHTML = '';
    charTalents.forEach(t => panel.appendChild(buildCard(t)));
  }

  // ----- Build one card (Gear-like header) -----
  function buildCard(t) {
    const card = el('article', { class: 'talent-card' + (t._min ? ' min' : ''), 'data-id': t.id });

    // Header
const header  = el('div', { class: 'card-header', title: 'Click empty header to minimise/expand' });
const dragH   = btn('drag-handle', '↕', 'Drag to reorder');
const title   = el('input', { class: 'card-title', type: 'text', placeholder: 'Talent Name', value: t.name || '' });

const lvlWrap = el('div', { class: 'lvl-wrap' });
const lvlLbl  = el('span', { class: 'lvl-label' }, 'level');
const level   = sel('lvl-select', ['-','1','2','3'], String(t.level||'-'));
lvlWrap.append(lvlLbl, level);

const minBtn  = btn('min-btn', '–', 'Minimise / expand');
const lockBtn = btn('lock-btn', '', 'Lock / Unlock');
setLockIcon(lockBtn, !!t._locked);

const mmWrap  = el('div', { class: 'mm-wrap' });
mmWrap.append(minBtn, lockBtn);

const hdrRight = el('div', { class: 'hdr-right' });
hdrRight.append(lvlWrap, mmWrap);

header.append(dragH, title, hdrRight);


    // Body: description only
    const body = el('div', { class: 'talent-body' });
    const desc = el('textarea', { class: 'description', placeholder: 'Description…' }, t.desc || '');
    autosize(desc);
    body.append(desc);

    // Footer: Remove only
    const footer = el('div', { class: 'card-footer' });
    const btnRemove = el('button', { class: 'remove-btn', type: 'button', title: 'Remove this talent' }, 'Remove');
    footer.append(btnRemove);

    // Assemble
    card.append(header, body, footer);

    // ----- Behaviour -----
    // Title/level/desc bindings
    title.addEventListener('input',  () => { t.name  = title.value; });
    level.addEventListener('change', () => { t.level = level.value; });
    desc .addEventListener('input',  () => { t.desc  = desc.value;  });

    // Minimise (button + empty header click)
    minBtn.addEventListener('click', () => toggleMin(card, t, desc));
    header.addEventListener('click', (e) => {
      const isCtl = e.target===title || e.target===dragH || e.target===minBtn || e.target===lockBtn || lvlWrap.contains(e.target);
      if (!isCtl) toggleMin(card, t, desc);
    });

    // Lock
    lockBtn.addEventListener('click', () => { t._locked = !t._locked; applyLock(); });
    function applyLock(){
      const locked = !!t._locked;
      setLockIcon(lockBtn, locked);
      card.classList.toggle('is-locked', locked);
      // Disable inputs (but keep drag/min/lock usable). Also disable Remove like Gear.
      [title, level, desc, btnRemove].forEach(el => el.disabled = locked);
    }
    applyLock();

    // Remove
    btnRemove.addEventListener('click', () => {
      const i = charTalents.findIndex(x => x.id === t.id);
      if (i > -1) { charTalents.splice(i, 1); renderPanel(); }
    });

    // Handle-only drag
    let allowDrag = false;
    dragH.addEventListener('mousedown', ()=>{ allowDrag = true; card.setAttribute('draggable','true'); });
    window.addEventListener('mouseup', ()=>{ allowDrag = false; card.removeAttribute('draggable'); });
    card.addEventListener('dragstart', (e)=>{
      if (!allowDrag) { e.preventDefault(); return; }
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      try { e.dataTransfer.setData('text/plain', t.id); } catch {}
    });
    card.addEventListener('dragend', ()=>{ card.classList.remove('dragging'); clearDropTargets(); });

    return card;
  }

  function toggleMin(card, t, desc){
    card.classList.toggle('min');
    t._min = card.classList.contains('min');
    if (!t._min) requestAnimationFrame(()=> fitTextarea(desc));
  }

  // ----- Helpers -----
  function sanitize(t){
    return { id: t.id||uid(), name:String(t.name||''), level:String(t.level||'-'), desc:String(t.desc||''), _min:!!t._min, _locked:!!t._locked };
  }
  function uid(){ return 't_' + Math.random().toString(36).slice(2, 9); }

  function el(tag, attrs, txt){
    const n = document.createElement(tag);
    if (attrs) for (const [k,v] of Object.entries(attrs)){ if (v===false||v==null) continue; if (v===true) n.setAttribute(k,''); else n.setAttribute(k,String(v)); }
    if (txt!=null) n.appendChild(document.createTextNode(txt));
    return n;
  }
  function btn(cls, text, title){ const b = el('button', { class: cls, type: 'button', title }); b.textContent = text; return b; }
  function sel(cls, opts, selected){
    const s = el('select', { class: cls }); opts.forEach(v => s.appendChild(el('option', { value: v, selected: (v===selected) }, v))); return s;
  }
  function setLockIcon(btn, locked){ btn.style.backgroundImage = `url('img/${locked ? 'lock.png' : 'lock_open.png'}')`; }
  function autosize(ta){ const fit=()=>{ ta.style.height='auto'; ta.style.height=(ta.scrollHeight+2)+'px'; }; queueMicrotask(fit); ta.addEventListener('input', fit); }
  function fitTextarea(ta){ ta.style.height='auto'; ta.style.height=(ta.scrollHeight+2)+'px'; }

  // Start
  renderPanel();
})();
</script>

<script id="gear-cards-module">
(function GearCardsModuleRefactor(){
  'use strict';

  // ---------- Panel & list ----------
  const panel = document.getElementById('gearPanelInner') || document.querySelector('#panel-gear #gearPanelInner');
  if(!panel){ console.warn('[GearCards] #gearPanelInner not found.'); return; }
  let list = panel.querySelector('.gear-list');
  if(!list){ list = document.createElement('section'); list.className = 'gear-list'; panel.appendChild(list); }

  // ---------- Shared helpers ----------
  const uid = () => 'gc_'+Math.random().toString(36).slice(2,9);
  const num = v => { const n = parseFloat(v); return Number.isFinite(n) ? Math.max(0, n) : 0; };

  const mkDiv = (cls)=>{ const n=document.createElement('div'); n.className=cls; return n; };
  const mkInput=(type,cls,val,ph)=>{ const n=document.createElement('input'); n.type=type; if(cls) n.className=cls; if(val!=null) n.value=val; if(ph) n.placeholder=ph; return n; };
  const mkBtn  =(cls,txt,title)=>{ const n=document.createElement('button'); if(cls) n.className=cls; n.type='button'; if(txt!=null) n.textContent=txt; if(title) n.title=title; return n; };
  const mkLabel=(txt)=>{ const n=document.createElement('label'); n.textContent=txt; return n; };
  const mkSelect=(cls, values, selected)=>{
    const s=document.createElement('select'); if(cls) s.className=cls;
    values.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; s.appendChild(o); });
    s.value = selected ?? values[0];
    return s;
  };
  const box = (labelTxt, controlEl, extraClass) => {
    const b = mkDiv('field-box' + (extraClass ? (' '+extraClass) : ''));
    const lab = mkLabel(labelTxt);
    b.append(lab, controlEl);
    return b;
  };
  const setLockIcon=(btn,locked)=> btn.style.backgroundImage=`url('img/${locked?'lock.png':'lock_open.png'}')`;

  // Encumbrance auto-sum (W & S across all cards)
  function recalcEncumbrance(){
    let w=0, s=0;
    list.querySelectorAll('input[name="weight"]').forEach(el=> w += num(el.value));
    list.querySelectorAll('input[name="stow"]').forEach(el=>   s += num(el.value));
    const wCur = document.getElementById('encWeightCur');
    const sCur = document.getElementById('encStowCur');
    if (wCur) wCur.value = Math.round(w);
    if (sCur) sCur.value = Math.round(s);
  }
  window.recalcEncumbrance = recalcEncumbrance;

  // ---------- Base Card Skeleton ----------
  function createBaseCardSkeleton(type, data, opts){
    const card = document.createElement('article');
    card.className = 'gear-card';
    card.dataset.cardId = data.id || uid();
    card.dataset.cardType = type;

    // Header
    const header = mkDiv('card-header');
    const dragHandle = mkBtn('drag-handle','↕','Drag to reorder');
    const title = mkInput('text','card-title', data.name || data.title || '', 'Item Name');

    const hdrRight = mkDiv('hdr-right');
    const stackWrap = mkDiv('stack-wrap');

    // Optional: Gear Bonus in header
    let gbHeader = null, gbRoll = null;
    if (opts.headerGearBonus !== false){
      const gbRow = mkDiv('hdr-row');
      const gbLabel = mkDiv('hdr-label'); gbLabel.textContent = 'Gear Bonus';
      gbHeader = mkInput('number','gb-input-header enc-input', (data.diceMod ?? 0));
      gbHeader.name = 'diceMod';
      gbRoll = document.createElement('img');
      gbRoll.src='img/roll_icon.png'; gbRoll.alt='Roll'; gbRoll.className='gb-roll hdr-15';
      gbRoll.title='Add Gear Bonus to dice pool';
      const gbWrap = mkDiv('gb-wrap'); gbWrap.append(gbHeader, gbRoll);
      gbRow.append(gbLabel, gbWrap); stackWrap.append(gbRow);

      gbRoll.addEventListener('click',()=>{
        gbRoll.classList.remove('is-animating'); void gbRoll.offsetWidth; gbRoll.classList.add('is-animating');
        gbRoll.addEventListener('animationend',()=>gbRoll.classList.remove('is-animating'),{once:true});
        const v=parseInt(gbHeader.value,10)||0;
        if(v && typeof window.changePool==='function') window.changePool(+v);
      });
    }

    // Optional: Damage in header (Weapons only)
    let dmgHeader = null;
    if (opts.headerDamage === true){
      const dmgRow = mkDiv('hdr-row');
      const dmgLabel = mkDiv('hdr-label'); dmgLabel.textContent='damage';
      dmgHeader = mkInput('number','dmg-input-header enc-input',(data.damage ?? 0));
      dmgHeader.name = 'damage';
      dmgRow.append(dmgLabel, dmgHeader); stackWrap.append(dmgRow);
    }

    // Minimise/Lock
    const mmWrap = mkDiv('mm-wrap');
    const minBtn = mkBtn('min-btn hdr-btn hdr-15','–','Minimise / expand');
    const lockBtn= mkBtn('lock-btn hdr-btn hdr-15','', 'Lock / Unlock');
    setLockIcon(lockBtn, !!data._locked);
    mmWrap.append(minBtn, lockBtn);

    hdrRight.append(stackWrap, mmWrap);
    header.append(dragHandle, title, hdrRight);

    // Body + Footer
    const body = mkDiv('card-body');
    const rows = mkDiv('fields-rows');
    const desc = document.createElement('textarea'); desc.className='description'; desc.placeholder='Description…'; desc.value=data.description||'';
    const footer = mkDiv('card-footer');
    const btnRemove = document.createElement('button'); btnRemove.type='button'; btnRemove.textContent='Remove'; btnRemove.title='Remove this item';
    footer.append(btnRemove);

    body.append(rows, desc); card.append(header, body, footer);

    // Minimise behaviour (button + empty header click)
    minBtn.addEventListener('click', ()=>{
      card.classList.toggle('min');
      if(!card.classList.contains('min')){
        requestAnimationFrame(()=>{ desc.style.height='auto'; desc.style.height=(desc.scrollHeight+2)+'px'; });
      }
    });
    header.addEventListener('click',(e)=>{
      const isCtl = e.target===title || e.target===dragHandle || e.target===minBtn || e.target===lockBtn || hdrRight.contains(e.target);
      if(!isCtl) minBtn.click();
    });

    // Lock behaviour (keep dice clickable)
    function applyLockState(){
      const locked=!!data._locked; setLockIcon(lockBtn, locked); card.classList.toggle('is-locked',locked);
      card.querySelectorAll('input, textarea, select, button').forEach(el=>{
        const keep=(el===dragHandle||el===minBtn||el===lockBtn||el===btnRemove);
        if(keep) return;
        el.disabled=locked;
      });
      btnRemove.disabled=locked;
      if (gbRoll){ gbRoll.style.pointerEvents='auto'; gbRoll.style.opacity='1'; }
    }
    lockBtn.addEventListener('click',()=>{ data._locked=!data._locked; applyLockState(); });
    applyLockState();

    // Remove
    btnRemove.addEventListener('click',()=>{ card.remove(); recalcEncumbrance(); });

    // Drag handle only
    let allowDrag=false;
    dragHandle.addEventListener('mousedown',()=>{ allowDrag=true; card.setAttribute('draggable','true'); });
    window.addEventListener('mouseup',()=>{ allowDrag=false; card.removeAttribute('draggable'); });
    card.addEventListener('dragstart',e=>{
      if(!allowDrag){ e.preventDefault(); return; }
      card.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; try{ e.dataTransfer.setData('text/plain',card.dataset.cardId); }catch{}
    });
    card.addEventListener('dragend',()=>{ card.classList.remove('dragging'); list.querySelectorAll('.drop-target').forEach(n=>n.classList.remove('drop-target')); });

    // Title binding
    title.addEventListener('input',()=>{ data.name=title.value; });

    return { card, header, body, rows, footer, gbHeader, gbRoll, dmgHeader, title, stackWrap };
  }

  // ---------- Shared rows (boxed) ----------
  function buildWSRowBoxed(data, options){
    const row = mkDiv('field-row boxed');

    const wNum = mkInput('number','enc-input', data.weight ?? 0); wNum.name='weight';
    const sNum = mkInput('number','enc-input', data.stow   ?? 0); sNum.name='stow';
    row.append(
      box('W', wNum),
      box('S', sNum)
    );

    if (options?.inlineGearBonus){
      const gbBody = mkInput('number','enc-input', data.diceMod ?? 0); gbBody.name='diceMod';
      row.append( box('Gear Bonus', gbBody) );
      if (options.headerGb){
        const hb = options.headerGb;
        const syncFromHeader = () => { const v=hb.value; gbBody.value=v; data.diceMod=v; };
        const syncFromBody   = () => { const v=gbBody.value; hb.value=v; data.diceMod=v; };
        hb.addEventListener('input', syncFromHeader);
        gbBody.addEventListener('input', syncFromBody);
      }
    }

    if (options?.inlineDamage){
      const dmgBody = mkInput('number','enc-input', data.damage ?? 0); dmgBody.name='damage';
      row.append( box('damage', dmgBody) );
      if (options.headerDmg){
        const hd = options.headerDmg;
        const syncDmgHdr  = () => { dmgBody.value = hd.value; data.damage = hd.value; };
        const syncDmgBody = () => { hd.value = dmgBody.value; data.damage = dmgBody.value; };
        hd.addEventListener('input', syncDmgHdr);
        dmgBody.addEventListener('input', syncDmgBody);
      }
    }

    if (options?.damageTypeText){
      const typeTxt = mkInput('text','enc-text', data.damageType ?? data.wpnTypeText ?? ''); typeTxt.name='damageType';
      row.append( box('type:', typeTxt) );
    }

    [wNum, sNum].forEach(el => el.addEventListener('input', recalcEncumbrance));
    return row;
  }

  // ---------- WEAPON CARD ----------
  function createWeaponCard(data){
    const id = data.id || ('gc_' + Math.random().toString(36).slice(2,9));
    const card = document.createElement('article');
    card.className = 'gear-card'; card.dataset.cardId = id; card.dataset.cardType = 'weapon';

    // Header
    const header = mkDiv('card-header');
    const dragHandle = mkBtn('drag-handle','↕','Drag to reorder');
    const title      = mkInput('text','card-title', data.name||data.title||'', 'Item Name');

    const hdrRight  = mkDiv('hdr-right');
    const stackWrap = mkDiv('stack-wrap');

    // Gear Bonus (tiny) + roll
    const gbRow   = mkDiv('hdr-row gb-row');
    const gbLabel = mkDiv('hdr-label'); gbLabel.textContent = 'Gear Bonus';
    const gbHeader = mkInput('number','gb-input-header', (data.diceMod ?? data.bonus ?? 0)); gbHeader.name='diceMod';
    const gbRoll = document.createElement('img');
    gbRoll.src='img/roll_icon.png'; gbRoll.alt='Roll';
    gbRoll.className='gb-roll hdr-15'; gbRoll.title='Add Gear Bonus to dice pool';
    const gbWrap = mkDiv('gb-wrap'); gbWrap.append(gbHeader, gbRoll);
    gbRow.append(gbLabel, gbWrap);

    // Damage (tiny)
    const dmgHdrRow   = mkDiv('hdr-row dmg-row');
    const dmgHdrLabel = mkDiv('hdr-label'); dmgHdrLabel.textContent='damage';
    const dmgHeader   = mkInput('number','dmg-input-header', (data.damage ?? 0)); dmgHeader.name='damage';
    dmgHdrRow.append(dmgHdrLabel, dmgHeader);

    // Min/Lock
    const mmWrap  = mkDiv('mm-wrap');
    const minBtn  = mkBtn('min-btn hdr-btn hdr-15','–','Minimise / expand');
    const lockBtn = mkBtn('lock-btn hdr-btn hdr-15','','Lock / Unlock');
    const setLock = (locked)=> lockBtn.style.backgroundImage=`url('img/${locked?'lock.png':'lock_open.png'}')`;
    setLock(!!data._locked);
    mmWrap.append(minBtn, lockBtn);

    stackWrap.append(gbRow, dmgHdrRow);
    hdrRight.append(stackWrap, mmWrap);
    header.append(dragHandle, title, hdrRight);

    // Body
    const body = mkDiv('card-body');
    const rows = mkDiv('fields-rows');

    // Row 1 — Skill | Type | Grip
    const row1 = mkDiv('field-row row-boxed');

    const skillSel = mkSelect('enc-select', ['Fight','Marksmanship','Other'], data.skill || 'Fight'); skillSel.name='skill';
    const typeSel  = mkSelect('enc-select', ['Bludgeon','Blade','Firearm','Projectile','Static','Thrown'], data.wpnClass || 'Bludgeon'); typeSel.name='wpnClass';
    const gripSel  = mkSelect('enc-select', ['1 hand','2 hands'], data.grip || '1 hand'); gripSel.name='grip';

    row1.append(
      box('Skill:', skillSel),
      box('Type:',  typeSel),
      box('Grip:',  gripSel),
    );
    rows.appendChild(row1);

    // Row 2 — W/S | damage+type | Gear Bonus | Shots+Reload
    const row2 = mkDiv('field-row row-boxed');

    const wNum  = mkInput('number','num-compact', (data.weight ?? 0)); wNum.name='weight';
    const sNum  = mkInput('number','num-compact', (data.stow ?? 0));   sNum.name='stow';
    const wsBox = mkDiv('field-box ws-box');
    wsBox.append(mkLabel('W'), wNum, (()=>{ const slash=document.createElement('span'); slash.textContent='/'; slash.className='ws-slash'; return slash; })(), mkLabel('S'), sNum);

    const dmgNum = mkInput('number','num-compact', (data.damage ?? 0)); dmgNum.name='damage';
    const typeTxt= mkInput('text','text-xs type-text', (data.damageType ?? data.wpnTypeText ?? '')); typeTxt.name='damageType';
    const dmgBox = mkDiv('field-box dmg-box');
    dmgBox.append(mkLabel('damage'), dmgNum, mkLabel('type:'), typeTxt);

    const gbBody = mkInput('number','num-compact', (data.diceMod ?? 0)); gbBody.name='diceMod';
    const gbBox  = mkDiv('field-box gb-box'); gbBox.append(mkLabel('Gear Bonus'), gbBody);

    const shNum  = mkInput('number','num-xs', (data.shots ?? 0));     shNum.name='shots';
    const rlNum  = mkInput('number','num-xs', (data.reloadAP ?? 0));  rlNum.name='reloadAP';
    const shotsBox = mkDiv('field-box shots-box'); shotsBox.append(mkLabel('Shots'), shNum, mkLabel('Reload (AP)'), rlNum);

    row2.append(wsBox, dmgBox, gbBox, shotsBox);
    rows.appendChild(row2);

    // Row 3 — Reach/Range
    const rrRow = mkDiv('field-row rr-row');
    const rrSel = mkSelect('enc-select', ['Close','Short','Medium','Long'], data.reachRange || 'Close'); rrSel.name='reachRange';
    rrRow.append(mkLabel('Reach/Range'), rrSel);
    rows.appendChild(rrRow);

    // Description
    const desc = document.createElement('textarea'); desc.className='description'; desc.placeholder='Description…'; desc.value = data.description || '';

    // Footer
    const footer = mkDiv('card-footer');
    const btnRemove = document.createElement('button'); btnRemove.type='button'; btnRemove.textContent='Remove'; btnRemove.title='Remove this item';
    btnRemove.addEventListener('click',()=>{ card.remove(); recalcEncumbrance(); });
    footer.append(btnRemove);

    body.append(rows, desc);
    card.append(header, body, footer);

    // ---- Behaviour ----
    [wNum, sNum].forEach(el => el.addEventListener('input', recalcEncumbrance));

    // Sync header <-> body damage
    const syncDmgHdr  = () => { dmgNum.value = dmgHeader.value; data.damage = dmgHeader.value; };
    const syncDmgBody = () => { dmgHeader.value = dmgNum.value;  data.damage = dmgNum.value;  };
    dmgHeader.addEventListener('input', syncDmgHdr);
    dmgNum   .addEventListener('input', syncDmgBody);

    // Sync header <-> body Gear Bonus
    const syncGbHdr  = () => { gbBody.value = gbHeader.value; data.diceMod = gbHeader.value; };
    const syncGbBody = () => { gbHeader.value = gbBody.value;  data.diceMod = gbBody.value;  };
    gbHeader.addEventListener('input', syncGbHdr);
    gbBody  .addEventListener('input', syncGbBody);

    // Roll from header Gear Bonus
    gbRoll.addEventListener('click',()=>{
      gbRoll.classList.remove('is-animating'); void gbRoll.offsetWidth; gbRoll.classList.add('is-animating');
      gbRoll.addEventListener('animationend',()=>gbRoll.classList.remove('is-animating'),{once:true});
      const v = parseInt(gbHeader.value,10) || 0;
      if (v && typeof window.changePool==='function') window.changePool(+v);
    });

    // Ranged-only visibility for Shots/Reload
    function setRangedVisibility(){
      const ranged = ['Firearm','Projectile'].includes(typeSel.value);
      shotsBox.style.display = ranged ? 'inline-flex' : 'none';
    }
    setRangedVisibility();
    typeSel.addEventListener('change', setRangedVisibility);

    // Lock behaviour
    function applyLockState(){
      const locked = !!data._locked;
      setLock(locked);
      card.classList.toggle('is-locked', locked);
      card.querySelectorAll('input, textarea, select, button').forEach(el=>{
        const keep = (el===dragHandle || el===minBtn || el===lockBtn || el===btnRemove);
        if(keep) return;
        el.disabled = locked;
      });
      btnRemove.disabled = locked;
      gbRoll.style.pointerEvents='auto'; gbRoll.style.opacity='1';
    }
    lockBtn.addEventListener('click',()=>{ data._locked = !data._locked; applyLockState(); });
    applyLockState();

    // Minimise
    minBtn.addEventListener('click', ()=>{
      card.classList.toggle('min');
      if(!card.classList.contains('min')){
        requestAnimationFrame(()=>{ desc.style.height='auto'; desc.style.height=(desc.scrollHeight+2)+'px'; });
      }
    });
    header.addEventListener('click',(e)=>{
      const isCtl = e.target===title || e.target===gbHeader || e.target===gbRoll
                 || e.target===dragHandle || e.target===minBtn || e.target===lockBtn
                 || hdrRight.contains(e.target);
      if(!isCtl) minBtn.click();
    });

    // Title binding
    title.addEventListener('input',()=>{ data.name = title.value; });

    // Handle-only drag
    let allowDrag=false;
    dragHandle.addEventListener('mousedown',()=>{ allowDrag=true; card.setAttribute('draggable','true'); });
    window.addEventListener('mouseup',()=>{ allowDrag=false; card.removeAttribute('draggable'); });
    card.addEventListener('dragstart',e=>{
      if(!allowDrag){ e.preventDefault(); return; }
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
      try{ e.dataTransfer.setData('text/plain', id); }catch{}
    });
    card.addEventListener('dragend',()=>{ card.classList.remove('dragging'); document.querySelectorAll('.drop-target').forEach(n=>n.classList.remove('drop-target')); });

    return card;
  }

  // ---------- ARMOUR CARD ----------
  function createArmourCard(data){
    const s = createBaseCardSkeleton('armour', data, { headerGearBonus:false, headerDamage:false });

    // Header: Armour Bonus + dice
    (function addArmourBonusHeader(){
      const row   = mkDiv('hdr-row');
      const label = mkDiv('hdr-label'); label.textContent = 'Armour Bonus';

      const armHdr = mkInput('number','arm-input-header', (data.armor ?? data.armour ?? 0));
      armHdr.name = 'armor';

      const roll = document.createElement('img');
      roll.src = 'img/roll_icon.png';
      roll.alt = 'Roll';
      roll.title = 'Add Armour Bonus to dice pool';
      roll.className = 'gb-roll hdr-15';

      const wrap = mkDiv('gb-wrap');
      wrap.append(armHdr, roll);
      row.append(label, wrap);
      s.stackWrap.appendChild(row);

      // Dice -> pool
      roll.addEventListener('click', () => {
        roll.classList.remove('is-animating'); void roll.offsetWidth; roll.classList.add('is-animating');
        roll.addEventListener('animationend', ()=> roll.classList.remove('is-animating'), {once:true});
        const v = parseInt(armHdr.value, 10) || 0;
        if (v && typeof window.changePool === 'function') window.changePool(+v);
      });

      s._armHdr = armHdr;
    })();

    // Body Row 1: Coverage | Armour Value | Penalties
    const r1 = mkDiv('field-row boxed');
    const cov = mkInput('text','enc-text', data.coverage || ''); cov.name='coverage';
    const av  = mkInput('number','enc-input', (data.armor ?? data.armour ?? 0)); av.name='armor';
    const pen = mkInput('text','enc-text', data.penalty || ''); pen.name='penalty';
    r1.append( box('Coverage', cov), box('Armour Value', av), box('Penalties', pen) );
    s.rows.appendChild(r1);

    // Sync header <-> body Armour Value
    if (s._armHdr){
      const hdrToBody = () => { av.value = s._armHdr.value; };
      const bodyToHdr = () => { s._armHdr.value = av.value || '0'; };
      s._armHdr.addEventListener('input', hdrToBody);
      av.addEventListener('input', bodyToHdr);
      bodyToHdr();
    }

    // Body Row 2: W/S
    const wsRow = buildWSRowBoxed(data, { inlineGearBonus:false, inlineDamage:false });
    s.rows.appendChild(wsRow);

    return s.card;
  }

  // ---------- CHEMICAL CARD ----------
  function createChemicalCard(data){
    const s = createBaseCardSkeleton('chemical', data, { headerGearBonus:false, headerDamage:false });

    // W/S
    const wsRow = buildWSRowBoxed(data, { inlineGearBonus:false, inlineDamage:false });
    s.rows.appendChild(wsRow);

    // Dose / Duration
    const r2 = mkDiv('field-row boxed');
    const dose = mkInput('text','enc-text', data.dose||''); dose.name='dose';
    const dur  = mkInput('text','enc-text', data.duration||''); dur.name='duration';
    r2.append( box('Dose', dose), box('Duration', dur) );
    s.rows.appendChild(r2);

    // Effects
    const r3 = mkDiv('field-row');
    r3.append(mkLabel('Effects (+/− dice)'));
    const eff = document.createElement('textarea'); eff.rows=2; eff.value=data.effects||''; eff.name='effects';
    eff.style.width='100%'; eff.style.fontFamily="Gothics, Dominican, serif"; eff.style.fontSize='11px';
    r3.append(eff); s.rows.appendChild(r3);

    // Withdrawal/Crash
    const r4 = mkDiv('field-row');
    r4.append(mkLabel('Withdrawal/Crash'));
    const wd = document.createElement('textarea'); wd.rows=2; wd.value=data.withdrawal||''; wd.name='withdrawal';
    wd.style.width='100%'; wd.style.fontFamily="Gothics, Dominican, serif"; wd.style.fontSize='11px';
    r4.append(wd); s.rows.appendChild(r4);

    // Addiction / Price
    const r5 = mkDiv('field-row boxed');
    const add = mkInput('text','enc-text', data.addiction||''); add.name='addiction';
    const price = mkInput('text','enc-text', data.price||'');  price.name='price';
    r5.append( box('Addiction Rating', add), box('Price', price) );
    s.rows.appendChild(r5);

    return s.card;
  }

  // ---------- GENERIC GEAR CARD (fallback) ----------
  function createGearCard(data){
    const s = createBaseCardSkeleton('gear', data, { headerGearBonus:true, headerDamage:false });

    // Row 1: W/S + (optional) inline Gear Bonus, synced with header
    const ws = buildWSRowBoxed(
      data,
      { inlineGearBonus:true, inlineDamage:false, headerGb: s.gbHeader }
    );
    s.rows.appendChild(ws);

    // Row 2: Freeform notes label (kept minimal)
    // (Description textarea is already present in the base skeleton)

    return s.card;
  }

  // ---------- Public API ----------
  window.spawnBlankGearCard = function(kind){
    const type = (kind==='armor') ? 'armour' : (kind || 'gear');
    let el;
    const base = { id: uid(), name:'', description:'', diceMod:0, weight:0, stow:0, damage:0 };

    if (type === 'weapon')       el = createWeaponCard(base);
    else if (type === 'armour')  el = createArmourCard(base);
    else if (type === 'chemical')el = createChemicalCard(base);
    else                         el = createGearCard(base);

    list.appendChild(el);
    recalcEncumbrance();
    return el;
  };

  // Export: collect per-card fields
  window.exportCharacterGear = function(){
    const out=[]; list.querySelectorAll('.gear-card').forEach(card=>{
      const item={
        id:card.dataset.cardId||null,
        type:card.dataset.cardType||'gear',
        _locked:card.classList.contains('is-locked'),
        _min:card.classList.contains('min'),
        name:card.querySelector('.card-title')?.value||'',
        description:card.querySelector('.description')?.value||'',
      };
      card.querySelectorAll('.card-body [name], .card-header [name]').forEach(el=>{
        const k = el.name; if(!k) return;
        item[k] = (el.type==='checkbox') ? !!el.checked : el.value;
      });
      out.push(item);
    }); return out;
  };

  // Import
  window.importCharacterGear = function(items){
    list.innerHTML='';
    if(!Array.isArray(items)){ recalcEncumbrance(); return; }
    items.forEach(data=>{
      let el;
      const t = (data.type||'gear').toLowerCase();
      if (t==='weapon' || t==='weapon_melee' || t==='weapon_ranged') el = createWeaponCard(data);
      else if (t==='armour' || t==='armor')                          el = createArmourCard(data);
      else if (t==='chemical' || t==='narcotic')                     el = createChemicalCard(data);
      else                                                           el = createGearCard(data);

      if (data._min)    el.classList.add('min');
      if (data._locked) el.classList.add('is-locked');

      el.querySelectorAll('[name]').forEach(ctrl=>{
        const k = ctrl.name;
        if (Object.prototype.hasOwnProperty.call(data,k)){
          if (ctrl.type==='checkbox') ctrl.checked = !!data[k];
          else ctrl.value = (data[k] ?? '');
        }
      });

      list.appendChild(el);
    });
    recalcEncumbrance();
  };

  // Clear all
  window.clearGearCards = function(){ list.innerHTML=''; recalcEncumbrance(); };

  // ---------- Drag & drop reorder on list ----------
  if(!list.dataset.ddInit){
    list.dataset.ddInit='1';
    list.addEventListener('dragover',e=>{
      e.preventDefault();
      const after=getCardAfterY(list,e.clientY);
      const dragging=list.querySelector('.gear-card.dragging');
      if(!dragging) return;
      if(after==null) list.appendChild(dragging); else list.insertBefore(dragging,after);
      list.querySelectorAll('.drop-target').forEach(n=>n.classList.remove('drop-target'));
      (after||dragging)?.classList.add('drop-target');
    });
    list.addEventListener('drop',()=> list.querySelectorAll('.drop-target').forEach(n=>n.classList.remove('drop-target')));
  }
  function getCardAfterY(container, y){
    const cards = [...container.querySelectorAll('.gear-card:not(.dragging)')];
    return cards.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - (box.height/2);
      if (offset < 0 && offset > closest.offset) return {offset, element:child};
      return closest;
    }, {offset: Number.NEGATIVE_INFINITY, element: null}).element;
  }

})(); 
</script>

<script>
/* ========= CATALOG RUNTIME (read-only, Hosting-backed) =========
   Your repo puts files at /public/catalog/*.json
   So on GitHub Pages they are at:
   https://dungeongrub.github.io/gxd6-dice-roller/public/catalog/*.json
   Buttons already call openCatalogPicker('weapons'|'armour'|'gear'|'chemical')
*/

/* 1) Loader (fixes the path to /public/catalog/...) */
async function loadCatalog(kind){
  const map = { armor:'armour', weapons:'weapons', armour:'armour', gear:'gear', chemical:'chemical' };
  const file = map[kind] || kind;
  try{
    const url = new URL(`public/catalog/${file}.json`, window.location.href);
    const res = await fetch(url.href, { cache:'no-store' });
    if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const data = await res.json();
    return Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
  }catch(e){
    console.warn('[Catalog] load failed:', e);
    alert(`Catalog load failed (${kind}): ${e.message || e}`);
    return [];
  }
}

/* 2) Spawn a blank card for the given kind and return the element */
function spawnCardForKind(kind){
  // our spawner expects: weapon | armor | gear | chemical
  if (kind === 'armour') kind = 'armor';
  return window.spawnBlankGearCard ? window.spawnBlankGearCard(kind) : null;
}

/* 3) Hydrate a new card from a catalog template object */
function hydrateCardFromTemplate(cardEl, tpl){
  if(!cardEl || !tpl) return;
  // Title
  const title = cardEl.querySelector('.card-title');
  if (title) title.value = tpl.name || tpl.title || '';

  // Description
  const desc = cardEl.querySelector('.description');
  if (desc && (tpl.description || tpl.desc)) desc.value = tpl.description || tpl.desc || '';

  // Copy over known fields to [name] controls (only if present)
  // Common weapon keys we’ll recognize from your JSON:
  const map = {
    damage: ['damage','dmg'],
    damageType: ['damageType','type','wpnType','wpnTypeText'],
    diceMod: ['diceMod','gearBonus','bonus'],
    reachRange: ['reachRange','range','reach'],
    weight: ['weight','w'],
    stow: ['stow','s'],
    shots: ['shots','ammo'],
    reloadAP: ['reloadAP','reload','reloadAp'],
    skill: ['skill'],
    wpnClass: ['wpnClass','class','kind','type'],
    grip: ['grip','hands'],

    // armour
    armor: ['armor','armour','av'],
    coverage: ['coverage','cover'],
    penalty: ['penalty','penalties'],

    // gear/chemical
    dose: ['dose'],
    duration: ['duration'],
    effects: ['effects'],
    withdrawal: ['withdrawal','crash'],
    addiction: ['addiction'],
    price: ['price']
  };

  // Reverse-lookup helper
  function getVal(key){
    const keys = map[key] || [key];
    for (const k of keys){
      if (k in tpl && tpl[k] != null) return tpl[k];
    }
    return undefined;
  }

  // Fill every [name] on the card if we have a value
  cardEl.querySelectorAll('[name]').forEach(ctrl=>{
    const k = ctrl.name;
    const v = getVal(k);
    if (v === undefined) return;
    if (ctrl.tagName === 'SELECT'){
      ctrl.value = String(v);
    } else if (ctrl.type === 'checkbox'){
      ctrl.checked = !!v;
    } else {
      ctrl.value = String(v);
    }
  });

  // Keep header/body mirrors in sync if present (damage / diceMod already synced by card code)
  // Recalc encumbrance if we changed W/S
  if (window.recalcEncumbrance) window.recalcEncumbrance();
}

/* 4) A tiny, no-CSS modal picker for now */
function makePicker(items, onPick){
  // overlay
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:100000;
  `;
  const box = document.createElement('div');
  box.style.cssText = `
    background:#fff; border:1px solid #000; width:420px; max-height:70vh; overflow:auto; padding:8px; font-family: DominicanSmall, Georgia, serif;
  `;
  const title = document.createElement('div');
  title.textContent = 'Select an item';
  title.style.cssText = 'font-weight:bold; margin-bottom:6px;';

  const list = document.createElement('div');
  items.forEach((it, i)=>{
    const row = document.createElement('div');
    row.style.cssText = 'display:flex; align-items:center; gap:6px; border-bottom:1px dashed #ddd; padding:4px 0;';
    const name = document.createElement('div');
    name.textContent = it.name || it.title || `Item ${i+1}`;
    name.style.cssText = 'flex:1 1 auto;';
    const add = document.createElement('button');
    add.textContent = 'Add';
    add.style.cssText = 'border:1px solid #000; background:#fff; padding:2px 6px; cursor:pointer;';
    add.addEventListener('click', ()=>{ onPick(it); document.body.removeChild(overlay); });
    row.append(name, add);
    list.appendChild(row);
  });

  const cancel = document.createElement('button');
  cancel.textContent = 'Cancel';
  cancel.style.cssText = 'margin-top:6px; border:1px solid #000; background:#fff; padding:2px 8px; cursor:pointer;';
  cancel.addEventListener('click', ()=> document.body.removeChild(overlay));

  box.append(title, list, cancel);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

/* 5) Public entry: called by the toolbar buttons */
async function openCatalogPicker(kind){
  // kind comes in as 'weapons' | 'armour' | 'gear' | 'chemical'
  const items = await loadCatalog(kind);
  if (!items.length){ alert(`No items found in ${kind}.json`); return; }

  makePicker(items, (tpl)=>{
    // spawn the correct blank card and hydrate it
    let spawnKind = kind;
    if (spawnKind === 'weapons') spawnKind = 'weapon';
    if (spawnKind === 'armour')  spawnKind = 'armor';
    const card = spawnCardForKind(spawnKind);
    if (!card) { alert('Could not create card'); return; }
    hydrateCardFromTemplate(card, tpl);
  });
}
</script>


<!-- Close body + html -->
</body>
</html>
