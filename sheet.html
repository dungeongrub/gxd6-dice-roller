<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GxD6 Character Sheet</title>
  <style>
/* === Fonts === */
@font-face { font-family: 'DominicanSmall'; src: url('fonts/DOMISC__.TTF'); }
@font-face { font-family: 'Dominican';      src: url('fonts/DOMINICA.TTF'); }
@font-face { font-family: 'DeutschGothic';  src: url('fonts/DeutschGothic.ttf'); }

body{
  font-family:'DominicanSmall', Georgia, serif;
  background:#f5f5f5;
  margin:0;
  padding:20px;
  color:black;
}

.sheet-container{ width:800px; margin:0 auto; min-width:800px; }

input,select{
  font-family:'Dominican', serif;
  font-size:14px;
  padding:2px 6px;
  background:transparent;
  border:none;
}

input[type="text"]{ font-family:'Dominican', serif; }

input[type=number]{
  font-family:'DeutschGothic', monospace;
  font-size:16px;
  text-align:center;
  -moz-appearance:textfield;
}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; }

button{
  font-family:'DominicanSmall', serif;
  padding:4px 4px;
  cursor:pointer;
}

.top-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:20px;
}
.login-controls,.admin-controls{ display:flex; align-items:center; gap:10px; }

/* === Attribute pip styles === */
.pip-base,.pip-current{
  width:20px; height:22px;
  border:none;
  background:transparent;
  display:flex; align-items:center; justify-content:center;
  position:relative;
}
.pip-base input,.pip-current input{
  width:20px; height:22px; font-size:20px;
  border:none; background:transparent; text-align:center;
  font-family:'DeutschGothic', monospace;
  padding:0; margin:0;
}
.pip-base .lock-icon{
  position:absolute; bottom:-10px; left:50%; transform:translateX(-50%);
  width:14px; height:14px; cursor:pointer;
}
.trauma-controls{
  position:absolute; top:0; right:-20px;
  display:flex; flex-direction:column; gap:2px;
}
.trauma-controls button{
  width:18px; height:18px; font-size:12px; font-weight:bold;
  background:#e0e0e0; border:none; cursor:pointer; line-height:1; padding:0;
}

/* === Canvas === */
.sheet-canvas{
  position:relative;
  width:800px; height:800px;
  background:url("img/CharSheet_Block_1600x1600.jpg") no-repeat 0 0 / 100% 100%;
  border:1px solid #000; margin-top:20px;
}
.abs{
  position:absolute;
  left:var(--x,0); top:var(--y,0);
  width:var(--w,auto); height:var(--h,auto);
  z-index:10;
}
/* Overlay text fields */
.abs input[type="text"], .abs select{
  font-family:'Dominican', serif;
  font-size:12px;
  background:transparent;
  padding:2px 6px;
  border:none;
  box-sizing:border-box;
  height:20px;
}
.abs input[type="number"]{
  font-family:'DeutschGothic', monospace;
  font-size:16px; text-align:center;
  height:20px; padding:0 4px;
}
.abs input[type="number"]::-webkit-outer-spin-button,
.abs input[type="number"]::-webkit-inner-spin_button{ -webkit-appearance:none; }

/* Debug: outlines overlays */
.canvas-debug .abs{ outline:1px dashed rgba(0,0,0,.25); }

/* live coordinate badge */
.coord-badge{
  position:absolute; z-index:9999; background:rgba(0,0,0,.75); color:#fff;
  font:12px/1.2 'DominicanSmall',serif; padding:2px 6px; border-radius:3px;
  pointer-events:none; white-space:nowrap; transform:translate(-2px,-18px);
}

/* highlight the selected overlay while debugging */
.canvas-debug .abs.selected{ outline:2px solid #4caf50; }

/* Tabs */
.tabBtn{ background:#eee; border:1px solid #333; }
.tabBtn.active{ background:#333; color:#fff; }

/* === Skill UI bits === */
.skill-num {
  font-family: 'DeutschGothic', monospace;
  font-size: 10px;     /* ✅ smaller font */
  height: 15px;
  width: 15px;
  text-align: center;
  padding: 0;
  background: transparent;
  border: none;
}

/* Pip checkbox */
.pip-check {
  appearance: none;
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  border: none
  background: transparent;
  cursor: pointer;
  display: inline-block;
  vertical-align: middle;   /* avoids inline distortion */  
}
.pip-check:checked {
  background: white;      /* ✅ shows up on dark BG */
}
.pip-check:focus {
  outline: none;
}


/* Roll button overlay (uses roll_icon.png, shows '+') */
.roll-btn{
  width:20px; height:20px;
  background:url("img/roll_icon.png") no-repeat center/contain;
  border:none; cursor:pointer;
  font-family:'DeutschGothic';
  font-size:14px; font-weight:bold; color:black;
  text-align:center; line-height:18px; padding:0;
}
.roll-btn:active{ transform:scale(0.9); }
  </style>
</head>
<body>
<div class="sheet-container">

  <!-- LOGIN FORM -->
  <div id="loginForm" class="top-row">
    <div class="login-controls">
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button onclick="signIn()">Sign In</button>
      <button onclick="signUp()">Sign Up</button>
    </div>
  </div>

  <!-- ADMIN CONTROLS -->
  <div id="accountControls" class="top-row" style="display:none;">
    <div class="admin-controls">
      <button onclick="signOutUser()">Sign Out</button>
      <button onclick="deleteAccount()">Delete Account</button>
      <button onclick="saveCharacter()">Save</button>
      <button onclick="loadCharacter()">Load</button>
      <label>Saved
        <select id="characterSelect"><option value="">--Select--</option></select>
      </label>
      <button onclick="deleteCharacter()">Delete Character</button>
    </div>
  </div>

  <!-- === Main canvas === -->
  <div class="sheet-canvas" id="mainCanvas">

    <!-- Character Info -->
    <input id="charName" class="abs" type="text" maxlength="40" style="--x:28px; --y:123px; --w:210px;" />
    <input id="ageGroup" class="abs" type="text" maxlength="20" style="--x:262px; --y:123px; --w:90px;" />
    <input id="gender"  class="abs" type="text" maxlength="20" style="--x:382px; --y:123px; --w:80px;" />
    <input id="origin"  class="abs" type="text" maxlength="60" style="--x:482px; --y:123px; --w:250px;" />

    <!-- Attributes -->
    <!-- BRAWN -->
    <span class="pip-base abs" style="--x:127px; --y:210px;">
      <input id="brawn" type="number" min="1" max="5" value="1">
      <img id="lock-brawn" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('brawn')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:210px;">
      <input id="brawnCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('brawnCurrent')">+</button>
        <button onclick="stepDownField('brawnCurrent')">−</button>
      </div>
    </span>
    <!-- AGILITY -->
    <span class="pip-base abs" style="--x:127px; --y:345px;">
      <input id="agility" type="number" min="1" max="5" value="1">
      <img id="lock-agility" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('agility')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:345px;">
      <input id="agilityCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('agilityCurrent')">+</button>
        <button onclick="stepDownField('agilityCurrent')">−</button>
      </div>
    </span>
    <!-- WITS -->
    <span class="pip-base abs" style="--x:127px; --y:480px;">
      <input id="wits" type="number" min="1" max="5" value="1">
      <img id="lock-wits" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('wits')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:480px;">
      <input id="witsCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('witsCurrent')">+</button>
        <button onclick="stepDownField('witsCurrent')">−</button>
      </div>
    </span>
    <!-- WILL -->
    <span class="pip-base abs" style="--x:127px; --y:665px;">
      <input id="will" type="number" min="1" max="5" value="1">
      <img id="lock-will" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('will')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:665px;">
      <input id="willCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('willCurrent')">+</button>
        <button onclick="stepDownField('willCurrent')">−</button>
      </div>
    </span>

    <!-- POWER POINTS (current) -->
    <span class="pip-current abs" style="--x:284px; --y:244px;">
      <input id="powerCurrent" type="number" min="0" max="99" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('powerCurrent')">+</button>
        <button onclick="stepDownField('powerCurrent')">−</button>
      </div>
    </span>

    <!-- ===== BRAWN SKILLS (Endurance / Fight / Might) ===== -->
    <!-- Row 1 -->
    <input id="endurance_key"   type="checkbox" class="abs pip-check" style="--x:33px; --y:247px;">
    <input id="endurance_lvl"   type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:236px;">
    <input id="endurance_mod"   type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:236px;">
    <input id="endurance_total" type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:236px;">
    <button id="endurance_roll" class="abs roll-btn" style="--x:340px; --y:236px;" onclick="addToDicePool('endurance_total')">+</button>
    <!-- Row 2 -->
    <input id="fight_key"       type="checkbox" class="abs pip-check" style="--x:33px; --y:267px;">
    <input id="fight_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:258px;">
    <input id="fight_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:258px;">
    <input id="fight_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:258px;">
    <button id="fight_roll"     class="abs roll-btn" style="--x:340px; --y:258px;" onclick="addToDicePool('fight_total')">+</button>
    <!-- Row 3 -->
    <input id="might_key"       type="checkbox" class="abs pip-check" style="--x:33px; --y:297px;">
    <input id="might_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:280px;">
    <input id="might_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:280px;">
    <input id="might_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:280px;">
    <button id="might_roll"     class="abs roll-btn" style="--x:340px; --y:280px;" onclick="addToDicePool('might_total')">+</button>

    <!-- ===== AGILITY SKILLS (Marksmanship / Mobility / Precision) ===== -->
    <!-- Row 1 -->
    <input id="marksmanship_key"   type="checkbox" class="abs pip-check" style="--x:33px; --y:371px;">
    <input id="marksmanship_lvl"   type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:371px;">
    <input id="marksmanship_mod"   type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:371px;">
    <input id="marksmanship_total" type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:371px;">
    <button id="marksmanship_roll" class="abs roll-btn" style="--x:340px; --y:371px;" onclick="addToDicePool('marksmanship_total')">+</button>
    <!-- Row 2 -->
    <input id="mobility_key"       type="checkbox" class="abs pip-check" style="--x:33px; --y:393px;">
    <input id="mobility_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:393px;">
    <input id="mobility_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:393px;">
    <input id="mobility_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:393px;">
    <button id="mobility_roll"     class="abs roll-btn" style="--x:340px; --y:393px;" onclick="addToDicePool('mobility_total')">+</button>
    <!-- Row 3 -->
    <input id="precision_key"      type="checkbox" class="abs pip-check" style="--x:33px; --y:415px;">
    <input id="precision_lvl"      type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:415px;">
    <input id="precision_mod"      type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:415px;">
    <input id="precision_total"    type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:415px;">
    <button id="precision_roll"    class="abs roll-btn" style="--x:340px; --y:415px;" onclick="addToDicePool('precision_total')">+</button>

    <!-- ===== WITS SKILLS (Heal / Insight / Logic / Survival / Vigilance) ===== -->
    <!-- Row 1 -->
    <input id="heal_key"           type="checkbox" class="abs pip-check" style="--x:33px; --y:506px;">
    <input id="heal_lvl"           type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:506px;">
    <input id="heal_mod"           type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:506px;">
    <input id="heal_total"         type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:506px;">
    <button id="heal_roll"         class="abs roll-btn" style="--x:340px; --y:506px;" onclick="addToDicePool('heal_total')">+</button>
    <!-- Row 2 -->
    <input id="insight_key"        type="checkbox" class="abs pip-check" style="--x:33px; --y:528px;">
    <input id="insight_lvl"        type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:528px;">
    <input id="insight_mod"        type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:528px;">
    <input id="insight_total"      type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:528px;">
    <button id="insight_roll"      class="abs roll-btn" style="--x:340px; --y:528px;" onclick="addToDicePool('insight_total')">+</button>
    <!-- Row 3 -->
    <input id="logic_key"          type="checkbox" class="abs pip-check" style="--x:33px; --y:550px;">
    <input id="logic_lvl"          type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:550px;">
    <input id="logic_mod"          type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:550px;">
    <input id="logic_total"        type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:550px;">
    <button id="logic_roll"        class="abs roll-btn" style="--x:340px; --y:550px;" onclick="addToDicePool('logic_total')">+</button>
    <!-- Row 4 -->
    <input id="survival_key"       type="checkbox" class="abs pip-check" style="--x:33px; --y:572px;">
    <input id="survival_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:572px;">
    <input id="survival_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:572px;">
    <input id="survival_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:572px;">
    <button id="survival_roll"     class="abs roll-btn" style="--x:340px; --y:572px;" onclick="addToDicePool('survival_total')">+</button>
    <!-- Row 5 -->
    <input id="vigilance_key"      type="checkbox" class="abs pip-check" style="--x:33px; --y:594px;">
    <input id="vigilance_lvl"      type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:594px;">
    <input id="vigilance_mod"      type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:594px;">
    <input id="vigilance_total"    type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:594px;">
    <button id="vigilance_roll"    class="abs roll-btn" style="--x:340px; --y:594px;" onclick="addToDicePool('vigilance_total')">+</button>

    <!-- ===== WILL SKILLS (Inspire / Manipulate / Resolve) ===== -->
    <!-- Row 1 -->
    <input id="inspire_key"        type="checkbox" class="abs pip-check" style="--x:33px; --y:691px;">
    <input id="inspire_lvl"        type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:691px;">
    <input id="inspire_mod"        type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:691px;">
    <input id="inspire_total"      type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:691px;">
    <button id="inspire_roll"      class="abs roll-btn" style="--x:340px; --y:691px;" onclick="addToDicePool('inspire_total')">+</button>
    <!-- Row 2 -->
    <input id="manipulate_key"     type="checkbox" class="abs pip-check" style="--x:222px; --y:713px;">
    <input id="manipulate_lvl"     type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:713px;">
    <input id="manipulate_mod"     type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:713px;">
    <input id="manipulate_total"   type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:713px;">
    <button id="manipulate_roll"   class="abs roll-btn" style="--x:340px; --y:713px;" onclick="addToDicePool('manipulate_total')">+</button>
    <!-- Row 3 -->
    <input id="resolve_key"        type="checkbox" class="abs pip-check" style="--x:33px; --y:735px;">
    <input id="resolve_lvl"        type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:248px; --y:735px;">
    <input id="resolve_mod"        type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:735px;">
    <input id="resolve_total"      type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:735px;">
    <button id="resolve_roll"      class="abs roll-btn" style="--x:340px; --y:735px;" onclick="addToDicePool('resolve_total')">+</button>

    <!-- Tabs box -->
    <div id="tabBox" class="abs"
      style="--x:278px; --y:331px; --w:440px; --h:430px; background:transparent; border:none; padding:5px;">
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button type="button" class="tabBtn" data-tab="main"   onclick="showTab('main')">Main</button>
        <button type="button" class="tabBtn" data-tab="combat" onclick="showTab('combat')">Combat</button>
        <button type="button" class="tabBtn" data-tab="gear"   onclick="showTab('gear')">Gear</button>
        <button type="button" class="tabBtn" data-tab="powers" onclick="showTab('powers')">Powers</button>
      </div>

      <!-- panel-main: inputs only (labels removed) -->
      <div id="panel-main" class="tabPanel" style="display:block;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <input id="archetype1" type="text" placeholder="" />
          <input id="profession1" type="text" placeholder="" />
          <input id="archetype2" type="text" placeholder="" />
          <input id="profession2" type="text" placeholder="" />
        </div>
        <div style="margin-top:14px; display:flex; justify-content:flex-end;">
          <input id="xp" type="number" value="0" style="width:40px;" />
        </div>
      </div>

      <div id="panel-combat" class="tabPanel" style="display:none;">Combat coming soon</div>
      <div id="panel-gear"   class="tabPanel" style="display:none;">Gear coming soon</div>
      <div id="panel-powers" class="tabPanel" style="display:none;">Powers coming soon</div>
    </div>

  </div>
</div>

<!-- Scripts -->
<script>
window.showTab = function(which){
  document.querySelectorAll('.tabPanel').forEach(p=>p.style.display='none');
  const active = document.getElementById('panel-'+which);
  if(active) active.style.display='block';
  document.querySelectorAll('.tabBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab===which);
  });
};

window.toggleLock = id => {
  const field = document.getElementById(id);
  const icon = document.getElementById(`lock-${id}`);
  if (!field || !icon) return;
  const locked = !field.disabled;
  field.disabled = locked;
  icon.src = locked ? 'img/lock.png' : 'img/lock_open.png';
  field.style.opacity = locked ? 0.6 : 1;
};
window.stepUpField = id => { document.getElementById(id)?.stepUp(); };
window.stepDownField = id => { document.getElementById(id)?.stepDown(); };

/* Dice integration stub: replace with your real pool logic */
function addToDicePool(totalId){
  const totalEl = document.getElementById(totalId);
  const val = parseInt(totalEl?.value,10) || 0;
  // Replace this with your Dice Roller integration (e.g., changePool(val))
  alert(`Would add ${val} dice from ${totalId} to the Dice Pool`);
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVINPqS-nMiWEs7RvabEqKuuUrii2S2MM",
  authDomain: "gxd6-character-sheet.firebaseapp.com",
  projectId: "gxd6-character-sheet",
  storageBucket: "gxd6-character-sheet.firebasestorage.app",
  messagingSenderId: "761778638151",
  appId: "1:761778638151:web:06a1d72423a7e980889062"
};
initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const loginFormEl=document.getElementById('loginForm');
const accountControlsEl=document.getElementById('accountControls');
const characterSelectEl=document.getElementById('characterSelect');

onAuthStateChanged(auth,user=>{
  if(user){
    loginFormEl.style.display='none';
    accountControlsEl.style.display='flex';
    populateCharacterList(user.uid);
  }else{
    loginFormEl.style.display='flex';
    accountControlsEl.style.display='none';
    characterSelectEl.innerHTML='<option value="">--Select--</option>';
  }
});

async function populateCharacterList(uid){
  const snap=await getDocs(collection(db,'users',uid,'characters'));
  characterSelectEl.innerHTML='<option value="">--Select--</option>';
  snap.forEach(d=>{
    const opt=document.createElement('option');opt.value=d.id;opt.text=d.id;characterSelectEl.appendChild(opt);
  });
}

window.signUp=async()=>{
  const em = document.getElementById('email').value.trim();
  const pw = document.getElementById('password').value;
  await createUserWithEmailAndPassword(auth,em,pw);
  alert('Signed up!');
};
window.signIn=async()=>{
  const em = document.getElementById('email').value.trim();
  const pw = document.getElementById('password').value;
  await signInWithEmailAndPassword(auth,em,pw);
  alert('Signed in!');
};
window.signOutUser=async()=>{ await signOut(auth); alert('Signed out'); };
window.deleteAccount=async()=>{
  if(auth.currentUser && confirm('Delete account?')){
    await deleteUser(auth.currentUser);
    alert('Account deleted');
  }
};

window.saveCharacter=async()=>{
  const user=auth.currentUser;
  const name=document.getElementById('charName').value.trim();
  if(!user||!name) return alert('Sign in & name required');

  const data={};
  // only save sheet + tabs (not login/admin)
  document.querySelectorAll('#mainCanvas input, #mainCanvas select, #tabBox input, #tabBox select').forEach(el=>{
    if(!el.id || el.id.startsWith('lock')) return;
    data[el.id] = (el.type==='checkbox') ? el.checked : el.value;
  });
  await setDoc(doc(db,'users',user.uid,'characters',name),data);
  alert('Saved');
  populateCharacterList(user.uid);
};

window.loadCharacter=async()=>{
  const user=auth.currentUser;
  if(!user) return alert('Sign in first');

  const id=characterSelectEl.value || document.getElementById('charName').value.trim();
  if(!id) return alert('Choose or type name');

  const snap=await getDoc(doc(db,'users',user.uid,'characters',id));
  if(!snap.exists()) return alert('Not found');

  const data=snap.data();
  Object.keys(data).forEach(k=>{
    const el=document.getElementById(k);
    if(el && !k.startsWith('lock')){
      (el.type==='checkbox') ? el.checked=!!data[k] : el.value=(data[k] ?? '');
    }
  });

  // Keep the dropdown and name in sync
  document.getElementById('charName').value = id;
  characterSelectEl.value = id;

  // Recompute totals after loading
  initAllSkillTotals();

  alert('Loaded');
};

window.deleteCharacter=async()=>{
  const user=auth.currentUser; const name=characterSelectEl.value;
  if(!user||!name) return alert('Select a character');
  if(confirm(`Delete "${name}"?`)){
    await deleteDoc(doc(db,'users',user.uid,'characters',name));
    alert('Deleted');
    populateCharacterList(user.uid);
  }
};
</script>

<script>
/* ===== Skill totals wiring ===== */
function toNum(v){ const n = parseInt(v,10); return isNaN(n) ? 0 : n; }

function setupSkillRow(attrCurrentId, baseId){
  const attrEl  = document.getElementById(attrCurrentId);
  const lvlEl   = document.getElementById(`${baseId}_lvl`);
  const modEl   = document.getElementById(`${baseId}_mod`);
  const totalEl = document.getElementById(`${baseId}_total`);
  if(!attrEl || !lvlEl || !modEl || !totalEl) return;

  const recalc = () => { totalEl.value = toNum(attrEl.value) + toNum(lvlEl.value) + toNum(modEl.value); };

  ['input','change'].forEach(ev=>{
    attrEl.addEventListener(ev,recalc);
    lvlEl.addEventListener(ev,recalc);
    modEl.addEventListener(ev,recalc);
  });
  recalc();
}

function initBrawnSkillTotals(){
  setupSkillRow('brawnCurrent','endurance');
  setupSkillRow('brawnCurrent','fight');
  setupSkillRow('brawnCurrent','might');
}
function initAgilitySkillTotals(){
  setupSkillRow('agilityCurrent','marksmanship');
  setupSkillRow('agilityCurrent','mobility');
  setupSkillRow('agilityCurrent','precision');
}
function initWitsSkillTotals(){
  setupSkillRow('witsCurrent','heal');
  setupSkillRow('witsCurrent','insight');
  setupSkillRow('witsCurrent','logic');
  setupSkillRow('witsCurrent','survival');
  setupSkillRow('witsCurrent','vigilance');
}
function initWillSkillTotals(){
  setupSkillRow('willCurrent','inspire');
  setupSkillRow('willCurrent','manipulate');
  setupSkillRow('willCurrent','resolve');
}
function initAllSkillTotals(){
  initBrawnSkillTotals();
  initAgilitySkillTotals();
  initWitsSkillTotals();
  initWillSkillTotals();
}

document.addEventListener('DOMContentLoaded', initAllSkillTotals);

/* ===== Unified canvas debug mover (press D) ===== */
(() => {
  let debug = false;
  let dragTarget = null;
  let selected = null;
  let offsetX = 0, offsetY = 0;
  const canvas = document.getElementById('mainCanvas');
  if (!canvas) return;

  const px = n => (typeof n === 'number' ? `${n}px` : n);
  const getPx = (el, varName) => {
    const v = el.style.getPropertyValue(varName).trim();
    return v.endsWith('px') ? parseFloat(v) : (v ? parseFloat(v) : 0);
  };
  const setXY = (el, x, y) => {
    el.style.setProperty('--x', px(x));
    el.style.setProperty('--y', px(y));
    updateBadge(el);
  };

  function ensureBadge(el){
    let b = el._badge;
    if (!b){
      b = document.createElement('div');
      b.className = 'coord-badge';
      el._badge = b;
      canvas.appendChild(b);
    }
    updateBadge(el);
  }
  function updateBadge(el){
    const b = el._badge;
    if (!b) return;
    const x = getPx(el,'--x'), y = getPx(el,'--y');
    b.textContent = `${el.id || el.tagName}  (${x}, ${y})`;
    b.style.left = el.offsetLeft + 'px';
    b.style.top  = el.offsetTop  + 'px';
  }
  function attachBadges(){
    canvas.querySelectorAll('.abs').forEach(el => ensureBadge(el));
    alert('DEBUG ON: click to select, drag or use arrow keys (1px). Shift=5px, Ctrl=10px. Press D to exit.');
  }
  function removeBadges(){
    canvas.querySelectorAll('.abs').forEach(el => {
      if (el._badge){ el._badge.remove(); el._badge = null; }
      el.classList.remove('selected');
    });
  }
  function clampToCanvas(el, x, y){
    const maxX = canvas.clientWidth  - el.offsetWidth;
    const maxY = canvas.clientHeight - el.offsetHeight;
    return [ Math.max(0, Math.min(x, maxX)), Math.max(0, Math.min(y, maxY)) ];
  }
  function selectEl(el){
    if (selected) selected.classList.remove('selected');
    selected = el;
    if (debug && selected) selected.classList.add('selected');
  }

  document.addEventListener('keydown', e => {
    if (e.key.toLowerCase() !== 'd') return;
    debug = !debug;
    canvas.classList.toggle('canvas-debug', debug);
    if (debug) attachBadges(); else removeBadges();
  });

  canvas.addEventListener('mousedown', e => {
    if (!debug) return;
    const target = e.target.closest('.abs');
    if (!target) return;
    selectEl(target);
    if (e.button === 0) {
      dragTarget = target;
      offsetX = e.clientX - target.offsetLeft;
      offsetY = e.clientY - target.offsetTop;
      if (e.target.tagName !== 'INPUT') e.preventDefault();
    }
  });

  document.addEventListener('mousemove', e => {
    if (!debug || !dragTarget) return;
    const rect = canvas.getBoundingClientRect();
    let newX = e.clientX - rect.left - offsetX;
    let newY = e.clientY - rect.top  - offsetY;
    [newX, newY] = clampToCanvas(dragTarget, newX, newY);
    setXY(dragTarget, newX, newY);
  });

  document.addEventListener('mouseup', () => {
    if (dragTarget){
      const x = getPx(dragTarget,'--x'), y = getPx(dragTarget,'--y');
      console.log(`${dragTarget.id || dragTarget.tagName} -> ${x}px, ${y}px`);
    }
    dragTarget = null;
  });

  document.addEventListener('keydown', e => {
    if (!debug || !selected) return;
    const ARROWS = ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'];
    if (!ARROWS.includes(e.key)) return;
    e.preventDefault();
    const base = 1;
    const step = e.ctrlKey ? 10 : (e.shiftKey ? 5 : base);
    let x = getPx(selected,'--x');
    let y = getPx(selected,'--y');
    if (e.key === 'ArrowLeft')  x -= step;
    if (e.key === 'ArrowRight') x += step;
    if (e.key === 'ArrowUp')    y -= step;
    if (e.key === 'ArrowDown')  y += step;
    [x, y] = clampToCanvas(selected, x, y);
    setXY(selected, x, y);
  });
})();
</script>
</body>
</html>
