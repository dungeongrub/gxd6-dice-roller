<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GxD6 Character Sheet</title>
  <style>
    /* ... include your @font-face and CSS layout from before ... */
  </style>
</head>
<body>
  <!-- Login UI -->
  <div id="loginForm">
    <label>Email: <input id="email" type="email"></label>
    <label>Password: <input id="password" type="password"></label>
    <button onclick="signUp()">Sign Up</button>
    <button onclick="signIn()">Sign In</button>
  </div>
  <button onclick="signOutUser()">Sign Out</button>
  <button onclick="deleteAccount()">Delete Account</button>
  <button onclick="deleteCharacter()">Delete Character</button>

  <!-- Character form fields and dropdown -->
  <div class="flex-row">
    <div class="field"><label>Character Name<input type="text" id="charName"></label></div>
    <div class="field"><label>Gender<input type="text" id="gender"></label></div>
    <div class="field"><label>Saved Characters<select id="characterSelect"><option>-- Select Character --</option></select></label></div>
    <div class="button-row">
      <button onclick="saveCharacter()">Save</button>
      <button onclick="loadCharacter()">Load</button>
    </div>
  </div>
  <!-- ... rest of form inputs like attributes, skills, notes ... -->

  <!-- Module script with all definitions -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const app = initializeApp({
      apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "...",
      messagingSenderId: "...", appId: "..."
    });
    const db = getFirestore(app);
    const auth = getAuth(app);
    const selectEl = document.getElementById("characterSelect");
    const loginForm = document.getElementById("loginForm");

    onAuthStateChanged(auth, user => {
      if (user) {
        loginForm.style.display = "none";
        populateCharacterList(user.uid);
      } else {
        loginForm.style.display = "block";
        selectEl.innerHTML = '<option value="">-- Select Character --</option>';
      }
    });

    async function populateCharacterList(uid) {
      selectEl.innerHTML = '<option value="">-- Select Character --</option>';
      const snap = await getDocs(collection(db, uid, "characters"));
      snap.forEach(docSnap => {
        const opt = document.createElement("option");
        opt.value = docSnap.id;
        opt.textContent = docSnap.id;
        selectEl.appendChild(opt);
      });
    }

    // Make these available globally
    window.signUp = async () => {
      try {
        await createUserWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value);
        alert("âœ… Signed Up!");
      } catch (e) { alert("Sign up failed: " + e.message); }
    };

    window.signIn = async () => {
      try {
        await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value);
        alert("âœ… Signed In!");
      } catch (e) { alert("Sign in failed: " + e.message); }
    };

    window.signOutUser = async () => { await signOut(auth); alert("ðŸ‘‹ Signed out."); };
    window.deleteAccount = async () => {
      if (confirm("Delete account permanently?")) await deleteUser(auth.currentUser).catch(e => alert("Deletion failed: " + e.message));
      alert("Account deleted.");
    };

    window.saveCharacter = async () => {
      const user = auth.currentUser;
      const name = document.getElementById("charName").value.trim();
      if (!user || !name) return alert("Sign in & name required.");
      const d = { name, gender: document.getElementById("gender").value /* + rest fields */ };
      try {
        const ref = doc(collection(db, user.uid, "characters"), name);
        console.log("Saving to:", ref.path, d);
        await setDoc(ref, d);
        alert("âœ… Character saved");
        populateCharacterList(user.uid);
      } catch (e) { alert("Save failed: " + e.message); }
    };

    window.loadCharacter = async () => {
      const user = auth.currentUser;
      const name = selectEl.value || document.getElementById("charName").value.trim();
      if (!user || !name) return alert("Sign in & select or name required.");
      try {
        const ref = doc(collection(db, user.uid, "characters"), name);
        const snap = await getDoc(ref);
        if (!snap.exists()) return alert("Character not found.");
        const data = snap.data();
        console.log("Loaded:", data);
        document.getElementById("charName").value = data.name || '';
        document.getElementById("gender").value = data.gender || '';
        // ... populate other fields ...
        alert("âœ… Character loaded");
      } catch (e) { alert("Load failed: " + e.message); }
    };

    window.deleteCharacter = async () => {
      const user = auth.currentUser;
      const name = selectEl.value;
      if (!user || !name || !confirm(`Delete "${name}"?`)) return;
      try {
        await deleteDoc(doc(collection(db, user.uid, "characters"), name));
        alert("âœ… Character deleted");
        populateCharacterList(user.uid);
      } catch (e) { alert("Deletion failed: " + e.message); }
    };
  </script>
</body>
</html>
