<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GxD6 Character Sheet</title>
  <style>
    @font-face { font-family: 'DominicanSmall'; src: url('fonts/DOMISC__.TTF') format('truetype'); }
    @font-face { font-family: 'Dominican'; src: url('fonts/DOMINICA.TTF') format('truetype'); }
    @font-face { font-family: 'DeutschGothic'; src: url('fonts/DeutschGothic.ttf') format('truetype'); }

    body { font-family: 'DominicanSmall', Georgia, serif; background: url('img/GXD6 Greyscale paper background.jpg') center/cover fixed; padding: 20px; color: black; }
    h3 { font-family: 'DominicanSmall', serif; font-variant: small-caps; }
    label, input[type="text"], textarea { font-family: 'Dominican', serif; }
    input[type="number"] { font-family: 'DeutschGothic', monospace; }

    .flex-row { display:flex; flex-wrap:wrap; gap:5px; align-items:flex-end; margin-bottom:10px; }
    .field { display:flex; flex-direction:column; gap:2px; }
    .button-row { display:flex; gap:10px; margin-left:auto; }
    .attribute-box { width:260px; padding:10px; margin:0 10px 10px 0; background:rgba(255,255,255,0.8); border:1px solid #000; }
    textarea { width:100%; height:100px; }
    #loginForm { margin-bottom:20px; }
  </style>
</head>
<body>

  <div id="loginForm">
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="signUp()">Sign Up</button>
    <button onclick="signIn()">Sign In</button>
  </div>
  <button onclick="signOutUser()">Sign Out</button>
  <button onclick="deleteAccount()">Delete Account</button>
  <button onclick="deleteCharacter()">Delete Character</button>

  <div class="flex-row">
    <div class="field"><label>Char Name<input type="text" id="charName"></label></div>
    <div class="field"><label>Gender<input type="text" id="gender"></label></div>
    <div class="field"><label>Saved<select id="characterSelect"><option value="">--Select--</option></select></label></div>
    <div class="button-row">
      <button onclick="saveCharacter()">Save</button>
      <button onclick="loadCharacter()">Load</button>
    </div>
  </div>

  <div class="flex-row">
    <div class="field"><label>Archetypes<input id="archetype1"><input id="archetype2"></label></div>
    <div class="field"><label>Professions<input id="profession1"><input id="profession2"></label></div>
    <div class="field"><label>XP<input type="number" id="xp"></label></div>
  </div>

  <div class="flex-row">
    <div class="attribute-box"><h3>Brawn</h3><label>Base<input type="number" id="brawn" min="1" max="5"></label><label>Current<input type="number" id="brawnCurrent" min="0" max="5"></label><hr><label>Endurance<input id="endurance" type="number"></label><label>Fight<input id="fight" type="number"></label><label>Might<input id="might" type="number"></label></div>
    <div class="attribute-box"><h3>Agility</h3><label>Base<input id="agility" type="number"></label><label>Current<input id="agilityCurrent" type="number"></label><hr><label>Marksmanship<input id="marksmanship" type="number"></label><label>Mobility<input id="mobility" type="number"></label><label>Precision<input id="precision" type="number"></label></div>
    <div class="attribute-box"><h3>Wits</h3><label>Base<input id="wits" type="number"></label><label>Current<input id="witsCurrent" type="number"></label><hr><label>Heal<input id="heal" type="number"></label><label>Insight<input id="insight" type="number"></label><label>Logic<input id="logic" type="number"></label><label>Survival<input id="survival" type="number"></label><label>Vigilance<input id="vigilance" type="number"></label></div>
    <div class="attribute-box"><h3>Will</h3><label>Base<input id="will" type="number"></label><label>Current<input id="willCurrent" type="number"></label><hr><label>Inspire<input id="inspire" type="number"></label><label>Manipulate<input id="manipulate" type="number"></label><label>Resolve<input id="resolve" type="number"></label></div>
  </div>

  <div class="flex-row">
    <label><input type="checkbox" id="starving"> Starving</label>
    <label><input type="checkbox" id="sleepless"> Sleepless</label>
    <label><input type="checkbox" id="dehydrated"> Dehydrated</label>
    <label><input type="checkbox" id="hypothermic"> Hypothermic</label>
  </div>

  <div class="gear-notes"><label>Gear / Notes<textarea id="notes"></textarea></label></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// Initialize Firebase
const config = {
  apiKey: "AIzaSyDVINPqS-nMiWEs7RvabEqKuuUrii2S2MM",
  authDomain: "gxd6-character-sheet.firebaseapp.com",
  projectId: "gxd6-character-sheet",
  storageBucket: "gxd6-character-sheet.firebasestorage.app",
  messagingSenderId: "761778638151",
  appId: "1:761778638151:web:06a1d72423a7e980889062"
};

const app = initializeApp(config);
const auth = getAuth(app);
const db = getFirestore(app);
const selectEl = document.getElementById("characterSelect");
const loginForm = document.getElementById("loginForm");

onAuthStateChanged(auth, user => {
  if (user) {
    loginForm.style.display = "none";
    populateCharacterList(user.uid);
  } else {
    loginForm.style.display = "block";
    selectEl.innerHTML = '<option value="">--Select--</option>';
  }
});

// AUTH HELPERS
window.signUp = async () => {
  const email = document.getElementById("email").value;
  const pw = document.getElementById("password").value;
  try {
    await createUserWithEmailAndPassword(auth, email, pw);
    alert("✅ Signed up!");
  } catch (err) {
    console.error("Sign up error:", err);
    alert("❌ Sign up failed: " + err.message);
  }
};

window.signIn = async () => {
  const email = document.getElementById("email").value;
  const pw = document.getElementById("password").value;
  try {
    await signInWithEmailAndPassword(auth, email, pw);
    alert("✅ Signed in!");
  } catch (err) {
    console.error("Sign in error:", err);
    alert("❌ Sign in failed: " + err.message);
  }
};

window.signOutUser = async () => {
  try {
    await signOut(auth);
    alert("✅ Signed out");
  } catch (err) {
    console.error("Sign out error:", err);
    alert("❌ Sign out failed: " + err.message);
  }
};

window.deleteAccount = async () => {
  const user = auth.currentUser;
  if (!user) return alert("Not signed in");
  if (!confirm("Delete your account and all characters?")) return;
  try {
    await deleteUser(user);
    alert("✅ Account deleted");
  } catch (err) {
    console.error("Account delete error:", err);
    alert("❌ Delete failed: " + err.message);
  }
};

// FIRESTORE
async function populateCharacterList(uid) {
  const selectEl = document.getElementById("characterSelect");
  selectEl.innerHTML = '<option value="">-- Select Character --</option>';
  try {
    const snap = await getDocs(collection(db, "users", uid, "characters"));
    snap.forEach(docSnap => {
      const opt = document.createElement("option");
      opt.value = docSnap.id;
      opt.text = docSnap.id;
      selectEl.appendChild(opt);
    });
  } catch (err) {
    console.error("List error:", err);
  }
}

window.saveCharacter = async () => {
  const user = auth.currentUser;
  if (!user) return alert("Sign in first");
  const name = document.getElementById("charName").value.trim();
  if (!name) return alert("Enter character name");

  const data = {
    name,
    gender: document.getElementById("gender").value,
    archetype1: document.getElementById("archetype1").value,
    archetype2: document.getElementById("archetype2").value,
    profession1: document.getElementById("profession1").value,
    profession2: document.getElementById("profession2").value,
    xp: +document.getElementById("xp").value || 0,
    brawn: +document.getElementById("brawn").value || 0,
    brawnCurrent: +document.getElementById("brawnCurrent").value || 0,
    agility: +document.getElementById("agility").value || 0,
    agilityCurrent: +document.getElementById("agilityCurrent").value || 0,
    wits: +document.getElementById("wits").value || 0,
    witsCurrent: +document.getElementById("witsCurrent").value || 0,
    will: +document.getElementById("will").value || 0,
    willCurrent: +document.getElementById("willCurrent").value || 0,
    skills: {
      endurance: +document.getElementById("endurance").value || 0,
      fight: +document.getElementById("fight").value || 0,
      might: +document.getElementById("might").value || 0,
      marksmanship: +document.getElementById("marksmanship").value || 0,
      mobility: +document.getElementById("mobility").value || 0,
      precision: +document.getElementById("precision").value || 0,
      heal: +document.getElementById("heal").value || 0,
      insight: +document.getElementById("insight").value || 0,
      logic: +document.getElementById("logic").value || 0,
      survival: +document.getElementById("survival").value || 0,
      vigilance: +document.getElementById("vigilance").value || 0,
      inspire: +document.getElementById("inspire").value || 0,
      manipulate: +document.getElementById("manipulate").value || 0,
      resolve: +document.getElementById("resolve").value || 0
    },
    conditions: {
      starving: document.getElementById("starving").checked,
      sleepless: document.getElementById("sleepless").checked,
      dehydrated: document.getElementById("dehydrated").checked,
      hypothermic: document.getElementById("hypothermic").checked
    },
    notes: document.getElementById("notes").value
  };

  try {
    const ref = doc(db, "users", user.uid, "characters", name);
    await setDoc(ref, data);
    alert("✅ Character saved");
    populateCharacterList(user.uid);
  } catch (err) {
    console.error("Save failed:", err);
    alert("❌ Save failed: " + err.message);
  }
};

window.loadCharacter = async () => {
  const user = auth.currentUser;
  if (!user) return alert("Sign in first");
  const name = document.getElementById("characterSelect").value || document.getElementById("charName").value.trim();
  if (!name) return alert("Enter/select name");

  try {
    const ref = doc(db, "users", user.uid, "characters", name);
    const snap = await getDoc(ref);
    if (!snap.exists()) return alert("❌ Character not found");
    const d = snap.data();

    document.getElementById("charName").value = d.name || '';
    document.getElementById("gender").value = d.gender || '';
    document.getElementById("archetype1").value = d.archetype1 || '';
    document.getElementById("archetype2").value = d.archetype2 || '';
    document.getElementById("profession1").value = d.profession1 || '';
    document.getElementById("profession2").value = d.profession2 || '';
    document.getElementById("xp").value = d.xp || '';
    document.getElementById("brawn").value = d.brawn || '';
    document.getElementById("brawnCurrent").value = d.brawnCurrent || '';
    document.getElementById("agility").value = d.agility || '';
    document.getElementById("agilityCurrent").value = d.agilityCurrent || '';
    document.getElementById("wits").value = d.wits || '';
    document.getElementById("witsCurrent").value = d.witsCurrent || '';
    document.getElementById("will").value = d.will || '';
    document.getElementById("willCurrent").value = d.willCurrent || '';

    for (let s in d.skills) {
      if (document.getElementById(s)) document.getElementById(s).value = d.skills[s];
    }
    for (let c in d.conditions) {
      if (document.getElementById(c)) document.getElementById(c).checked = d.conditions[c];
    }
    document.getElementById("notes").value = d.notes || '';
    alert("✅ Loaded!");
  } catch (err) {
    console.error("Load error:", err);
    alert("❌ Load failed: " + err.message);
  }
};

window.deleteCharacter = async () => {
  const user = auth.currentUser;
  const name = document.getElementById("characterSelect").value;
  if (!user || !name) return alert("Select a character");
  if (!confirm(`Delete "${name}"?`)) return;
  try {
    const ref = doc(db, "users", user.uid, "characters", name);
    await deleteDoc(ref);
    alert("🗑️ Deleted");
    populateCharacterList(user.uid);
  } catch (err) {
    console.error("Delete error:", err);
    alert("❌ Delete failed: " + err.message);
  }
};


</script>
</body>
</html>
