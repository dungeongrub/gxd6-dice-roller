<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>GxD6 Character Sheet – Clean Build</title>
<style>
/* ====== BASE ====== */
@font-face { font-family:'DominicanSmall'; src:url('fonts/DOMISC__.TTF'); }
@font-face { font-family:'Dominican';      src:url('fonts/DOMINICA.TTF'); }
@font-face { font-family:'DeutschGothic';  src:url('fonts/DeutschGothic.ttf'); }

html,body{margin:0;padding:0;background:#f5f5f5;color:#000;font-family:'DominicanSmall',Georgia,serif}
.sheet-container{width:800px;min-width:800px;margin:20px auto}

input,select,button{font-family:'Dominican',serif;font-size:14px;background:transparent;border:none;padding:2px 6px}
input[type=number]{font-family:'DeutschGothic',monospace;text-align:center;-moz-appearance:textfield}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; }

button{cursor:pointer}

.sheet-canvas{
  position:relative;width:800px;height:800px;
  background:url("img/CharSheet_Block_1600x1600.jpg") no-repeat 0 0 / 100% 100%;
  border:1px solid #000;
}
.abs{ position:absolute; left:var(--x,0); top:var(--y,0); width:var(--w,auto); height:var(--h,auto); z-index:10; }
.canvas-debug .abs{ outline:1px dashed rgba(0,0,0,.25); }

/* ====== TABS ====== */
.tabBtn{ background:#eee; border:1px solid #333; padding:4px 8px; }
.tabBtn.active{ background:#333; color:#fff; }
.tabPanel{ position:relative; }

/* ====== Dice bits kept minimal so page works ====== */
#dicePool{ width:40px; height:20px; font-family:'DeutschGothic',monospace; }

/* ====== DEBUGGER UI ====== */
.debugger{
  position:fixed; right:12px; bottom:12px; z-index:1000000;
  background:#fff; border:1px solid #bbb; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.18);
  font:12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111; width:260px;
}
.debugger .hdr{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px;border-bottom:1px solid #eee;cursor:move}
.debugger .body{padding:8px;display:grid;gap:6px}
.debugger .row{display:flex;align-items:center;gap:6px}
.debugger .grow{flex:1}
.debugger input[type="text"], .debugger input[type="number"]{border:1px solid #ddd;border-radius:4px}
.debugger button{border:1px solid #bbb;background:#f6f6f6;border-radius:4px;padding:3px 6px}

.debug-tooltip,.debug-coord{
  position:fixed; z-index:999998; display:none; background:#111; color:#fff;
  border:1px solid #444; border-radius:4px; padding:3px 6px; font:11px/1.2 system-ui;
  pointer-events:none; white-space:nowrap;
}
.debug-tooltip{transform:translate(8px,8px)}
.debug-cross-x,.debug-cross-y{
  position:fixed; z-index:999996; background:rgba(255,0,0,.85); display:none; pointer-events:none;
}
.debug-cross-x{height:1px;left:0;right:0}
.debug-cross-y{width:1px;top:0;bottom:0}
.debug-marquee{
  position:fixed; z-index:999997; display:none;
  border:1px dashed #0077ff; background:rgba(0,119,255,.12); pointer-events:none;
}
.debug-measure{
  position:fixed; z-index:999997; display:none;
  border:1px dashed #00aa55; background:rgba(0,170,85,.10); pointer-events:none;
}
.debug-selected{ outline:2px solid #0077ff !important; box-shadow:0 0 0 2px rgba(0,119,255,.2) inset; }
.debug-mini{ position:fixed; z-index:999999; display:none; background:#111;color:#fff;border:1px solid #444;border-radius:4px;padding:2px 4px;font:10px/1.2 system-ui;pointer-events:none}
.debugger.compact .body{ display:none; }
</style>
</head>
<body>
<div class="sheet-container">
  <!-- Minimal login strip omitted to avoid unrelated errors -->

  <div id="mainCanvas" class="sheet-canvas">
    <!-- Character header fields -->
    <input id="charName" class="abs" type="text" maxlength="40" style="--x:28px; --y:123px; --w:210px;">
    <input id="ageGroup" class="abs" type="text" maxlength="20" style="--x:262px; --y:123px; --w:90px;">
    <input id="gender"   class="abs" type="text" maxlength="20" style="--x:382px; --y:123px; --w:80px;">
    <input id="origin"   class="abs" type="text" maxlength="60" style="--x:482px; --y:123px; --w:250px;">

    <!-- Tiny dice pool just so addToDicePool() etc won’t blow up -->
    <input id="dicePool" class="abs" type="number" min="0" max="20" value="0" style="--x:372px; --y:189px;">

    <!-- === TAB BOX (450×400 inner panels) === -->
    <div id="tabBox" class="abs" style="--x:278px; --y:331px; --w:450px; --h:400px;">
      <!-- Buttons -->
      <div style="display:flex; gap:8px; margin:0 0 8px 10px;">
        <button type="button" class="tabBtn" data-tab="main"   onclick="showTab('main')">Main</button>
        <button type="button" class="tabBtn" data-tab="combat" onclick="showTab('combat')">Combat</button>
        <button type="button" class="tabBtn" data-tab="gear"   onclick="showTab('gear')">Gear</button>
        <button type="button" class="tabBtn" data-tab="powers" onclick="showTab('powers')">Powers</button>
      </div>

      <!-- Panels -->
      <div id="panel-main" class="tabPanel"
           style="display:block; width:450px; height:400px; background:url('img/tab_main.png') no-repeat center/100% 100%;">
        <!-- Fields placed relative to the *panel* (use debugger T key to lock origin here) -->
        <input id="archetype1"  class="abs" type="text" maxlength="20" style="--x:13px;  --y:70px;  --w:110px;">
        <input id="profession1" class="abs" type="text" maxlength="17" style="--x:160px; --y:70px;  --w:120px;">
        <input id="archetype2"  class="abs" type="text" maxlength="15" style="--x:13px;  --y:115px; --w:110px;">
        <input id="profession2" class="abs" type="text" maxlength="17" style="--x:160px; --y:115px; --w:120px;">

        <input id="xp" class="abs" type="number" value="0" min="0" style="--x:390px; --y:276px; --w:40px;">
        <div id="talentsDeck" class="abs" style="--x:16px; --y:160px; --w:418px; --h:220px;"></div>
      </div>

      <div id="panel-combat" class="tabPanel" style="display:none; width:450px; height:400px; background:#e9e9e9">
        <div class="abs" style="--x:12px; --y:12px;">Combat coming soon</div>
      </div>
      <div id="panel-gear" class="tabPanel" style="display:none; width:450px; height:400px; background:#e9e9e9">
        <div class="abs" style="--x:12px; --y:12px;">Gear coming soon</div>
      </div>
      <div id="panel-powers" class="tabPanel" style="display:none; width:450px; height:400px; background:#e9e9e9">
        <div class="abs" style="--x:12px; --y:12px;">Powers coming soon</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Tabs ===== -->
<script>
function showTab(which){
  document.querySelectorAll('#tabBox .tabPanel').forEach(p=>p.style.display='none');
  const active = document.getElementById('panel-'+which);
  if (active) active.style.display='block';
  document.querySelectorAll('#tabBox .tabBtn').forEach(b=>b.classList.toggle('active', b.dataset.tab===which));
}
function getPool(){ return Math.max(0, Math.min(20, parseInt(document.getElementById('dicePool').value,10)||0)); }
function setPool(n){ const el=document.getElementById('dicePool'); const v=Math.max(0,Math.min(20,n|0)); el.value=v; return v; }
function addToDicePool(id){ const t=document.getElementById(id); const add=parseInt(t?.value,10)||0; if(add>0) setPool(getPool()+add); }
</script>

<!-- ===== One, single, working debugger ===== -->
<script>
(() => {
  const SHEET = document.getElementById('mainCanvas');
  const TABS  = document.getElementById('tabBox');

  // State
  let ORIGIN = SHEET;
  let TARGET = '.abs';
  let debugOn = true, cursorOn = true, hoverOn = false, measureOn = false;
  let marqueeActive = false, measureActive = false;
  let dragging = null, dragDX = 0, dragDY = 0, startCX = 0, startCY = 0;
  const selected = new Set();

  // Overlays
  const tip   = mk('div','debug-tooltip');    // shows element label + coords
  const hud   = mk('div','debug-coord');      // cursor coords
  const cx    = mk('div','debug-cross-x');
  const cy    = mk('div','debug-cross-y');
  const box   = mk('div','debug-marquee');
  const meas  = mk('div','debug-measure');
  const mini  = mk('div','debug-mini');

  // Panel
  const panel = document.createElement('div');
  panel.className = 'debugger';
  panel.innerHTML = `
    <div class="hdr" id="dbgHdr">
      <strong>Debugger</strong>
      <label class="row"><input id="dbgOn" type="checkbox" checked> On</label>
    </div>
    <div class="body">
      <div class="row">
        <label class="row"><input id="dbgCursor" type="checkbox" checked> Cursor HUD</label>
        <label class="row"><input id="dbgMeasure" type="checkbox"> Measure</label>
      </div>
      <div class="row">
        <span>Target</span>
        <input id="dbgSel" class="grow" type="text" value=".abs" title="CSS selector for draggable targets">
      </div>
      <div class="row">
        <button id="dbgToSheet">Origin: Sheet (S)</button>
        <button id="dbgToTab">Origin: Tab (T)</button>
      </div>
      <div class="row">
        <button id="dbgClear">Clear sel</button>
        <button id="dbgLog">Log</button>
        <button id="dbgMin">Min</button>
      </div>
      <small>Hotkeys: D toggle • T tab • S sheet • Shift drag=marquee • Alt hover • Arrows nudge (Ctrl=5px)</small>
    </div>`;
  document.body.appendChild(panel);

  // Drag panel by header; Minimize
  (() => {
    const hdr = panel.querySelector('#dbgHdr');
    let pDragging=false, px=0, py=0, oLeft=0, oTop=0;
    hdr.addEventListener('dblclick', ()=> panel.classList.toggle('compact'));
    panel.querySelector('#dbgMin').addEventListener('click', ()=> panel.classList.toggle('compact'));
    hdr.addEventListener('mousedown', (e)=>{
      if (e.target.id==='dbgOn') return;
      pDragging = true; px=e.clientX; py=e.clientY;
      const r = panel.getBoundingClientRect(); oLeft=r.left; oTop=r.top;
      e.preventDefault();
    });
    window.addEventListener('mousemove', (e)=>{
      if (!pDragging) return;
      const dx=e.clientX-px, dy=e.clientY-py;
      panel.style.left = (oLeft+dx)+'px';
      panel.style.top  = (oTop +dy)+'px';
      panel.style.right = 'auto'; panel.style.bottom='auto';
    });
    window.addEventListener('mouseup', ()=> pDragging=false);
  })();

  // Panel controls
  const dbgOn      = panel.querySelector('#dbgOn');
  const dbgCursor  = panel.querySelector('#dbgCursor');
  const dbgMeasure = panel.querySelector('#dbgMeasure');
  const dbgSel     = panel.querySelector('#dbgSel');
  const btnSheet   = panel.querySelector('#dbgToSheet');
  const btnTab     = panel.querySelector('#dbgToTab');
  const btnClear   = panel.querySelector('#dbgClear');
  const btnLog     = panel.querySelector('#dbgLog');

  dbgOn.addEventListener('change', ()=> setDebug(dbgOn.checked));
  dbgCursor.addEventListener('change', ()=> setCursor(dbgCursor.checked));
  dbgMeasure.addEventListener('change', ()=> setMeasure(dbgMeasure.checked));
  dbgSel.addEventListener('change', ()=> { TARGET = dbgSel.value.trim() || '.abs'; clearSel(); });

  btnSheet.addEventListener('click', ()=> setOrigin(SHEET));
  btnTab.addEventListener('click', ()=> setOrigin(activeTab() || SHEET));
  btnClear.addEventListener('click', clearSel);
  btnLog.addEventListener('click', ()=> {
    if (!selected.size) return;
    console.table([...selected].map(el => ({ id: el.id || el.tagName, ...xy(el) })));
  });

  // Keyboard
  window.addEventListener('keydown', (e)=>{
    if (e.key==='d' || e.key==='D'){ dbgOn.checked=!dbgOn.checked; setDebug(dbgOn.checked); return; }
    if (e.key==='t' || e.key==='T'){ setOrigin(activeTab() || SHEET); return; }
    if (e.key==='s' || e.key==='S'){ setOrigin(SHEET); return; }

    if (debugOn && e.altKey) hoverOn = true;

    if (!debugOn || !selected.size) return;
    if (!/^Arrow(Up|Down|Left|Right)$/.test(e.key)) return;
    const step = e.ctrlKey ? 5 : 1;
    const dx = (e.key==='ArrowRight')? step : (e.key==='ArrowLeft')? -step : 0;
    const dy = (e.key==='ArrowDown') ? step : (e.key==='ArrowUp')   ? -step : 0;
    e.preventDefault();
    selected.forEach(el => nudge(el, dx, dy));
  });
  window.addEventListener('keyup', ()=>{ hoverOn=false; hideTip(); });

  // Mouse HUD
  window.addEventListener('mousemove', (e)=>{
    if (!debugOn || !cursorOn) return;
    const {x,y} = rel(e.clientX, e.clientY);
    cx.style.top = e.clientY+'px';
    cy.style.left= e.clientX+'px';
    hud.style.left = (e.clientX+10)+'px';
    hud.style.top  = (e.clientY+10)+'px';
    hud.textContent = `X: ${x}  Y: ${y}`;
    hud.style.display = 'block'; cx.style.display='block'; cy.style.display='block';
  });

  // Hover tooltip
  document.addEventListener('mouseover', (e)=>{
    if (!debugOn || !hoverOn) return;
    const t = closestTarget(e.target);
    if (t && inOrigin(t)) showTip(t, e.clientX, e.clientY);
  }, {capture:true});
  document.addEventListener('mousemove', (e)=>{
    if (!debugOn || !hoverOn || tip.style.display!=='block') return;
    tip.style.left = Math.min(window.innerWidth-8, e.clientX+8)+'px';
    tip.style.top  = Math.min(window.innerHeight-8, e.clientY+8)+'px';
  });
  document.addEventListener('mouseout', ()=>{ if (!debugOn || !hoverOn) return; hideTip(); }, {capture:true});

  // Marquee (Shift-drag)
  SHEET.addEventListener('mousedown', (e)=>{
    if (!debugOn || !e.shiftKey || measureOn) return;
    startCX=e.clientX; startCY=e.clientY; marqueeActive=true;
    placeBox(box, rectFrom(startCX,startCY,startCX,startCY));
    box.style.display='block'; e.preventDefault();
  });
  window.addEventListener('mousemove', (e)=>{
    if (!debugOn || !marqueeActive) return;
    const r = rectFrom(startCX,startCY,e.clientX,e.clientY);
    placeBox(box, r); clearSel();
    query(TARGET).forEach(el => { if (intersects(r, rectFor(el))) addSel(el); });
  });
  window.addEventListener('mouseup', ()=>{
    if (!debugOn || !marqueeActive) return;
    marqueeActive=false; box.style.display='none';
  });

  // Measure mode
  SHEET.addEventListener('mousedown', (e)=>{
    if (!debugOn || !measureOn) return;
    const t = closestTarget(e.target);
    if (t && inOrigin(t)) return;  // don't start on target
    startCX=e.clientX; startCY=e.clientY; measureActive=true;
    placeBox(meas, rectFrom(startCX,startCY,startCX,startCY));
    meas.style.display='block'; e.preventDefault();
  });
  window.addEventListener('mousemove', (e)=>{
    if (!debugOn || !measureOn || !measureActive) return;
    const r = rectFrom(startCX,startCY,e.clientX,e.clientY);
    placeBox(meas, r);
    mini.textContent = `${r.width} × ${r.height}px`;
    mini.style.left = (e.clientX+8)+'px';
    mini.style.top  = (e.clientY-2)+'px';
    mini.style.display='block';
  });
  window.addEventListener('mouseup', ()=>{
    if (!debugOn || !measureOn || !measureActive) return;
    measureActive=false; meas.style.display='none'; mini.style.display='none';
  });

  // Drag targets (click on sheet)
  SHEET.addEventListener('mousedown', (e)=>{
    if (!debugOn || e.shiftKey || measureOn) return;
    const t = closestTarget(e.target);
    if (!t || !inOrigin(t)) return;
    if (e.target && e.target.tagName === 'INPUT') return; // don't steal typing
    if (!selected.has(t)) { clearSel(); addSel(t); }
    const {x,y} = rel(e.clientX, e.clientY);
    const pos = xy(t);
    dragDX = x - pos.x; dragDY = y - pos.y;
    dragging = t; e.preventDefault();
  });
  window.addEventListener('mousemove', (e)=>{
    if (!debugOn || !dragging) return;
    const {x,y} = rel(e.clientX, e.clientY);
    moveTo(dragging, x - dragDX, y - dragDY);
  });
  window.addEventListener('mouseup', ()=> dragging=null);

  // Helpers — origin / coords
  function setOrigin(el){ ORIGIN = el || SHEET; console.log('Origin →', label(ORIGIN)); }
  function activeTab(){
    const p = Array.from(TABS.querySelectorAll('.tabPanel')).find(p=>p.style.display!=='none');
    return p || null;
  }
  function rel(clientX,clientY){
    const r = (ORIGIN||SHEET).getBoundingClientRect();
    return { x: Math.round(clientX - r.left), y: Math.round(clientY - r.top) };
  }
  function rectFrom(x1,y1,x2,y2){
    const a = rel(x1,y1), b = rel(x2,y2);
    const left=Math.min(a.x,b.x), top=Math.min(a.y,b.y);
    const width=Math.abs(a.x-b.x), height=Math.abs(a.y-b.y);
    return {left,top,width,height,right:left+width,bottom:top+height};
  }
  function placeBox(el, r){
    const o = (ORIGIN||SHEET).getBoundingClientRect();
    el.style.left = (o.left + r.left) + 'px';
    el.style.top  = (o.top  + r.top ) + 'px';
    el.style.width  = r.width + 'px';
    el.style.height = r.height + 'px';
  }

  // Helpers — selection + movement
  function xy(el){
    const cs = getComputedStyle(el);
    return { x: parseFloat(cs.getPropertyValue('--x')) || 0,
             y: parseFloat(cs.getPropertyValue('--y')) || 0 };
  }
  function moveTo(el, x, y){
    const [nx,ny] = clamp(el, x, y);
    el.style.setProperty('--x', Math.round(nx) + 'px');
    el.style.setProperty('--y', Math.round(ny) + 'px');
  }
  function nudge(el, dx, dy){ const p = xy(el); moveTo(el, p.x+dx, p.y+dy); }
  function clamp(el, x, y){
    const root = (ORIGIN||SHEET);
    const maxX = Math.max(0, root.clientWidth  - el.offsetWidth);
    const maxY = Math.max(0, root.clientHeight - el.offsetHeight);
    return [ Math.max(0, Math.min(x, maxX)), Math.max(0, Math.min(y, maxY)) ];
  }
  function clearSel(){ selected.forEach(el=>el.classList.remove('debug-selected')); selected.clear(); }
  function addSel(el){ if (!selected.has(el)) { selected.add(el); el.classList.add('debug-selected'); } }

  // Helpers — query/rect
  function closestTarget(t){ return t?.closest?.(TARGET) || null; }
  function inOrigin(el){ return (ORIGIN||SHEET).contains(el); }
  function query(sel){ return Array.from((ORIGIN||SHEET).querySelectorAll(sel)); }
  function rectFor(el){
    const o = (ORIGIN||SHEET).getBoundingClientRect();
    const r = el.getBoundingClientRect();
    return { left:r.left-o.left, top:r.top-o.top, right:r.right-o.left, bottom:r.bottom-o.top, width:r.width, height:r.height };
  }
  function intersects(a,b){ return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom); }
  function label(el){ return el.id ? '#'+el.id : (el.className || el.tagName); }

  // Helpers — tooltip
  function showTip(el, cxp, cyp){
    const p = xy(el);
    tip.textContent = `${el.id||el.tagName.toLowerCase()} (${Math.round(p.x)}, ${Math.round(p.y)})`;
    tip.style.left = Math.min(window.innerWidth-8, cxp+8)+'px';
    tip.style.top  = Math.min(window.innerHeight-8, cyp+8)+'px';
    tip.style.display='block';
    el.classList.add('debug-selected');
  }
  function hideTip(){ tip.style.display='none'; document.querySelectorAll('.debug-selected').forEach(n=>n.classList.remove('debug-selected')); }

  // Mode setters
  function setDebug(on){
    debugOn = !!on;
    SHEET.classList.toggle('canvas-debug', debugOn);
    setCursor(debugOn && cursorOn);
    if (!debugOn){ hoverOn=false; marqueeActive=false; measureActive=false; box.style.display='none'; meas.style.display='none'; mini.style.display='none'; hud.style.display='none'; cx.style.display='none'; cy.style.display='none'; hideTip(); }
  }
  function setCursor(on){ cursorOn = !!on; const disp = (debugOn && cursorOn) ? 'block' : 'none'; if (disp!=='block'){ hud.style.display='none'; cx.style.display='none'; cy.style.display='none'; } }
  function setMeasure(on){ measureOn = !!on; if (!measureOn){ measureActive=false; meas.style.display='none'; mini.style.display='none'; } }

  // Start state
  setDebug(true);
  setOrigin(SHEET);

  // Utilities
  function mk(tag, cls){ const e=document.createElement(tag); e.className=cls; document.body.appendChild(e); return e; }
})();
</script>
</body>
</html>
