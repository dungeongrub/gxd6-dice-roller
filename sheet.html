<!-- ===================== TALENT CARDS & REPOSITORY =====================
Paste this whole block near the end of <body> in CharsheetMain.html (just
before your existing <script> tags). It is self‑contained and namespaced. 
It expects your existing fonts (DominicanSmall/Dominican) and the class
.skill-num for small numeric dropdowns. Background art: /img/talent_card.png.
======================================================================= -->

<!-- Talent Repository Drawer (prewritten talents) -->
<aside id="talentRepo" class="talent-repo hidden" aria-label="Talent Repository">
  <div class="repo-header">
    <span>Talent Repository</span>
    <div class="repo-actions">
      <button type="button" class="btn" id="repoAddCustom">+ New</button>
      <button type="button" class="btn" id="repoImport">Import</button>
      <button type="button" class="btn" id="repoExport">Export</button>
      <button type="button" class="btn" id="repoClose" title="Close">✕</button>
    </div>
  </div>
  <div id="repoList" class="repo-list" aria-live="polite"></div>
  <div class="repo-footer">
    <small>Tip: Drag a card from here onto your sheet.</small>
  </div>
</aside>

<!-- Toggle button to open/close repository (position this as you like) -->
<button id="openTalentRepo" type="button" class="talent-repo-toggle" title="Open Talent Repository">Talents</button>

<!-- Main Panel drop zone for character’s selected talents -->
<section id="talentsPanel" class="talents-panel" aria-label="Character Talents" data-columns="2">
  <!-- Cards will appear here (drag from repo, or add inline) -->
</section>

<!-- Minimal styles; keep scoped to TALENTS only -->
<style>
  /* Drawer / Toggle */
  .talent-repo-toggle{position:absolute; right:10px; top:10px; z-index:30; padding:.35rem .6rem; font-family:DominicanSmall, Georgia, serif; border:1px solid #0002; border-radius:8px; background:#fff; box-shadow:0 1px 6px #0002; cursor:pointer}
  .talent-repo{position:fixed; right:16px; top:56px; width:360px; max-height:70vh; display:flex; flex-direction:column; background:#faf9f6; border:1px solid #0003; border-radius:14px; box-shadow:0 12px 28px #0003; z-index:1000}
  .talent-repo.hidden{display:none}
  .repo-header{display:flex; align-items:center; justify-content:space-between; padding:.6rem .75rem; font-family:DominicanSmall, Georgia, serif; font-variant:small-caps; font-size:18px; border-bottom:1px solid #0001}
  .repo-actions{display:flex; gap:.4rem}
  .repo-actions .btn{font-family:inherit; font-size:12px; padding:.25rem .5rem; border:1px solid #0002; background:#fff; border-radius:6px; cursor:pointer}
  .repo-list{overflow:auto; padding:.5rem; display:grid; grid-template-columns:1fr; gap:.5rem}
  .repo-item{display:flex; align-items:center; gap:.5rem; padding:.5rem; border:1px dashed #0002; border-radius:10px; background:#fff; cursor:grab}
  .repo-item:active{cursor:grabbing}
  .repo-title{font-family:DominicanSmall, Georgia, serif; font-variant:small-caps}
  .repo-footer{padding:.4rem .75rem .6rem; border-top:1px solid #0001; color:#444}

  /* Talents grid on the Main panel */
  .talents-panel{position:relative; z-index:10; display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); grid-auto-rows:min-content; gap:8px; padding:8px; background:transparent}
  .talents-panel.drag-over{outline:2px dashed #6aa; outline-offset:4px}

  /* Individual card */
  .talent-card{position:relative; display:flex; flex-direction:column; gap:6px; padding:12px 12px 14px 12px; min-height:140px; background:url('img/talent_card.png') center/100% 100% no-repeat; border:1px solid #0002; border-radius:12px; box-shadow:0 4px 10px #0002; user-select:none}
  .talent-card[draggable="true"]{cursor:grab}
  .talent-card.dragging{opacity:.6; cursor:grabbing}
  .talent-card.min{min-height:auto; padding:8px 10px}
  .talent-card.min .talent-body{display:none}

  /* Header line (title + level + actions) */
  .talent-head{display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:6px}
  .talent-title{width:100%; font-family:DominicanSmall, Georgia, serif; font-variant:small-caps; font-size:16px; background:transparent; border:none; outline:none; padding:2px 4px}
  .talent-title::placeholder{color:#0008}
  .talent-level{width:44px; text-align:center}
  .talent-actions{display:flex; gap:6px}
  .icon-btn{width:22px; height:22px; line-height:20px; text-align:center; border:1px solid #0002; border-radius:6px; background:#fff; cursor:pointer}

  /* Body (description + info), auto-resize textareas */
  .talent-body{display:flex; flex-direction:column; gap:6px}
  .talent-text{width:100%; min-height:56px; resize:none; overflow:hidden; padding:6px 8px; font-family:Dominican, Georgia, serif; font-size:14px; line-height:1.25; background:transparent; border:1px dashed transparent; outline:none}
  .talent-text:focus{border-color:#0002}

  /* Drag ghost spacer for reorder */
  .talent-placeholder{border:2px dashed #88a; border-radius:12px; height:120px}

  /* Utility */
  .hidden{display:none}
</style>

<script>
(()=>{
  // ===== Namespacing =====
  const LS_REPO_KEY = 'gxd6.talents.repo.v1';
  const LS_CHAR_KEY = 'gxd6.talents.character.v1';

  // ===== DOM =====
  const repo     = document.getElementById('talentRepo');
  const repoList = document.getElementById('repoList');
  const openBtn  = document.getElementById('openTalentRepo');
  const closeBtn = document.getElementById('repoClose');
  const addBtn   = document.getElementById('repoAddCustom');
  const impBtn   = document.getElementById('repoImport');
  const expBtn   = document.getElementById('repoExport');
  const panel    = document.getElementById('talentsPanel');

  if(!repo || !repoList || !panel){
    console.warn('[TALENTS] Required containers not found. Ensure you pasted the block correctly.');
    return;
  }

  // ===== Data =====
  /** Repo talent shape */
  // { id, name, level:'-'|1|2|3, desc, info }
  const defaultRepo = [
    {id: id(), name:'Salt of the Earth', level:'-', desc:'Your labour and grit earn respect among common folk. In settlements of working poor, reduce social friction.', info:''},
    {id: id(), name:'Inspire', level:'-', desc:'With a rousing word, grant an ally +1 die to the next roll once per scene.', info:''},
    {id: id(), name:'Pugilist', level:'1', desc:'You fight with fists, elbows, knees. Gain +1 when brawling unarmed at Close.', info:'I/II/III scale damage or control.'},
  ];

  // Load repo from LS
  let TALENT_REPO = loadJSON(LS_REPO_KEY, defaultRepo);
  renderRepo();

  // Load character talents
  let charTalents = loadJSON(LS_CHAR_KEY, []);
  renderPanel();

  // ===== UI Handlers: Repository =====
  openBtn?.addEventListener('click', ()=> repo.classList.toggle('hidden'));
  closeBtn?.addEventListener('click', ()=> repo.classList.add('hidden'));

  addBtn?.addEventListener('click', ()=>{
    const t = { id:id(), name:'New Talent', level:'-', desc:'', info:'' };
    TALENT_REPO.unshift(t); saveRepo(); renderRepo();
    // Focus the newly added repo item title
    queueMicrotask(()=>{
      const el = repoList.querySelector(`[data-id="${t.id}"] input.repo-edit`);
      el && el.focus();
    });
  });

  expBtn?.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(TALENT_REPO, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'gxd6_talent_repo.json';
    a.click(); URL.revokeObjectURL(a.href);
  });

  impBtn?.addEventListener('click', ()=>{
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'application/json';
    input.onchange = (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const data = JSON.parse(r.result);
          if(Array.isArray(data)){
            TALENT_REPO = data.map(sanitizeTalent);
            saveRepo(); renderRepo();
          } else alert('Invalid JSON format. Expected an array of talents.');
        }catch(err){ alert('Could not parse JSON: '+err.message); }
      };
      r.readAsText(file);
    };
    input.click();
  });

  // ===== Drag from repo -> panel =====
  repoList.addEventListener('dragstart', (e)=>{
    const item = e.target.closest('.repo-item'); if(!item) return;
    e.dataTransfer.setData('text/plain', JSON.stringify({source:'repo', id:item.dataset.id}));
    e.dataTransfer.effectAllowed = 'copy';
  });

  // ===== Panel: create, render, reorder, edit, minimize =====
  function renderPanel(){
    panel.innerHTML = '';
    charTalents.forEach(t => panel.appendChild(cardElement(t)));
  }

  function cardElement(t){
    const card = h('article', {class:'talent-card', draggable:'true', 'data-id':t.id});

    // Header
    const head = h('div', {class:'talent-head'});
    const title = h('input', {class:'talent-title', type:'text', placeholder:'Talent Name', value: t.name || ''});
    const level = h('select', {class:'talent-level skill-num'});
    ;['-','1','2','3'].forEach(v=> level.appendChild(h('option',{value:v, selected:String(t.level||'-')===v?true:null}, v)));
    const actions = h('div', {class:'talent-actions'});
    const btnMin = h('button', {class:'icon-btn', title:'Minimize/Expand', type:'button'}, '–');
    const btnDel = h('button', {class:'icon-btn', title:'Remove', type:'button'}, '✕');
    actions.append(btnMin, btnDel);
    head.append(title, level, actions);

    // Body
    const body = h('div', {class:'talent-body'});
    const desc = h('textarea', {class:'talent-text', placeholder:'Description…'}, t.desc||'');
    const info = h('textarea', {class:'talent-text', placeholder:'Info / Notes…'}, t.info||'');
    autoSize(desc); autoSize(info);
    body.append(desc, info);

    card.append(head, body);

    // Bind
    title.addEventListener('input', ()=>{ t.name = title.value.trim(); saveChar(); });
    level.addEventListener('change', ()=>{ t.level = level.value; saveChar(); });
    desc.addEventListener('input', ()=>{ t.desc = desc.value; autoSize(desc); saveChar(); });
    info.addEventListener('input', ()=>{ t.info = info.value; autoSize(info); saveChar(); });
    btnDel.addEventListener('click', ()=>{ removeTalent(t.id); });
    btnMin.addEventListener('click', ()=>{ card.classList.toggle('min'); saveChar(); });

    // Persist minimized state per card
    if(t._min) card.classList.add('min');
    card.addEventListener('click', (ev)=>{
      if(ev.target === title) return; // allow focusing title without toggle
      if(ev.detail === 2){ card.classList.toggle('min'); t._min = card.classList.contains('min'); saveChar(); }
    });

    // Drag within panel (reorder)
    card.addEventListener('dragstart', (e)=>{
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', JSON.stringify({source:'panel', id:t.id}));
    });
    card.addEventListener('dragend', ()=> card.classList.remove('dragging'));

    return card;
  }

  function removeTalent(id){
    const idx = charTalents.findIndex(x=>x.id===id);
    if(idx>=0){ charTalents.splice(idx,1); saveChar(); renderPanel(); }
  }

  // ===== Panel drag/drop targets =====
  panel.addEventListener('dragover', (e)=>{
    e.preventDefault(); panel.classList.add('drag-over');
    const after = getDragAfterElement(panel, e.clientY);
    const dragging = document.querySelector('.talent-card.dragging');
    if(after == null) panel.appendChild(placeholder());
    else panel.insertBefore(placeholder(), after);
  });
  panel.addEventListener('dragleave', ()=> panel.classList.remove('drag-over'));

  panel.addEventListener('drop', (e)=>{
    e.preventDefault(); panel.classList.remove('drag-over');
    const raw = e.dataTransfer.getData('text/plain');
    let payload = null; try{ payload = JSON.parse(raw); }catch{}
    const ph = panel.querySelector('.talent-placeholder');
    const insertIndex = ph ? [...panel.children].indexOf(ph) : charTalents.length;
    if(ph) ph.remove();

    if(payload?.source === 'repo'){
      const base = TALENT_REPO.find(x=> x.id===payload.id);
      if(!base) return;
      const inst = {...base, id:id(), _min:false};
      charTalents.splice(insertIndex,0, inst);
      saveChar(); renderPanel();
    }
    else if(payload?.source === 'panel'){
      const fromIdx = charTalents.findIndex(x=> x.id===payload.id);
      if(fromIdx<0) return;
      const [moved] = charTalents.splice(fromIdx,1);
      const toIndex = Math.min(insertIndex, charTalents.length);
      charTalents.splice(toIndex,0, moved);
      saveChar(); renderPanel();
    }
  });

  function placeholder(){
    let ph = panel.querySelector('.talent-placeholder');
    if(!ph){ ph = document.createElement('div'); ph.className='talent-placeholder'; }
    return ph;
  }

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.talent-card:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if(offset < 0 && offset > closest.offset){ return {offset, element:child}; }
      else return closest;
    }, {offset:Number.NEGATIVE_INFINITY}).element;
  }

  // ===== Render repository list =====
  function renderRepo(){
    repoList.innerHTML = '';
    TALENT_REPO.forEach(t=>{
      const row = h('div', {class:'repo-item', draggable:'true', 'data-id':t.id, title:'Drag onto sheet'},
        h('div', {style:'flex:1 1 auto; display:flex; flex-direction:column; gap:2px;'},
          h('input', {class:'repo-edit', value:t.name, title:'Name', type:'text'}),
          h('div', {style:'display:flex; gap:6px; align-items:center;'},
            h('select', {class:'skill-num', title:'Level', style:'width:44px; text-align:center;'},
              ...['-','1','2','3'].map(v=> h('option', {value:v, selected:String(t.level||'-')===v?true:null}, v))
            ),
            h('small', {class:'repo-title'}, 'Ready to drag')
          )
        ),
        h('button', {class:'btn', title:'Delete'}, 'Del')
      );
      const name = row.querySelector('input.repo-edit');
      const lev  = row.querySelector('select');
      const del  = row.querySelector('button');
      name.addEventListener('input', ()=>{ t.name = name.value; saveRepo(); });
      lev.addEventListener('change', ()=>{ t.level = lev.value; saveRepo(); });
      del.addEventListener('click', ()=>{
        TALENT_REPO = TALENT_REPO.filter(x=> x.id!==t.id); saveRepo(); renderRepo();
      });
      repoList.appendChild(row);
    });
  }

  // ===== Autosize multi-line fields; keep "info" beneath "desc" =====
  function autoSize(el){
    const fit = ()=>{ el.style.height='auto'; el.style.height = (el.scrollHeight+2)+'px'; };
    el.addEventListener('input', fit); queueMicrotask(fit);
  }

  // ===== Save / Load helpers =====
  function saveRepo(){ saveJSON(LS_REPO_KEY, TALENT_REPO); }
  function saveChar(){ saveJSON(LS_CHAR_KEY, charTalents); }
  function loadJSON(key, fallback){ try{ const raw=localStorage.getItem(key); return raw? JSON.parse(raw): structuredClone(fallback);}catch{ return structuredClone(fallback);} }
  function saveJSON(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){ console.warn('LocalStorage save failed', e);} }

  // ===== Public integration points (attach to window for your saver/loader) =====
  window.exportCharacterTalents = function(){
    // Return a serializable copy for your existing saveCharacter() payload
    return charTalents.map(t=> ({ id:t.id, name:t.name||'', level:String(t.level||'-'), desc:t.desc||'', info:t.info||'', _min:!!t._min }));
  };
  window.importCharacterTalents = function(list){
    if(!Array.isArray(list)) return;
    charTalents = list.map(sanitizeTalent); saveChar(); renderPanel();
  };
  window.addTalentFromRepoByName = function(name){
    const base = TALENT_REPO.find(x=> x.name.toLowerCase()===String(name||'').toLowerCase());
    if(!base) return null; const t={...base, id:id(), _min:false};
    charTalents.push(t); saveChar(); renderPanel(); return t.id;
  };

  // ===== Utils =====
  function sanitizeTalent(t){
    return { id: t.id||id(), name: String(t.name||''), level: String(t.level||'-'), desc: String(t.desc||''), info: String(t.info||''), _min: !!t._min };
  }
  function id(){ return 't_'+Math.random().toString(36).slice(2,9); }
  function h(tag, attrs, ...kids){
    const el = document.createElement(tag);
    if(attrs){ for(const [k,v] of Object.entries(attrs)){ if(v===null||v===undefined||v===false) continue; if(v===true) el.setAttribute(k,''); else el.setAttribute(k,String(v)); } }
    for(const k of kids){ if(k==null) continue; if(typeof k==='string'||typeof k==='number') el.appendChild(document.createTextNode(k)); else el.appendChild(k); }
    return el;
  }

  // ===== Panel drag target from external sources (repo) =====
  panel.addEventListener('dragenter', (e)=>{ e.preventDefault(); panel.classList.add('drag-over'); });
})();
</script>

<!-- ===================== END TALENT CARDS & REPO ===================== -->
