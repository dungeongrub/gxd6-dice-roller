<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GxD6 Character Sheet</title>
  <style>
    /* FONT SETUP */
    @font-face { font-family:'DominicanSmall'; src:url('fonts/DOMISC__.TTF'); }
    @font-face { font-family:'Dominican'; src:url('fonts/DOMINICA.TTF'); }
    @font-face { font-family:'DeutschGothic'; src:url('fonts/DeutschGothic.ttf'); }

    body {
      font-family:'DominicanSmall',Georgia,serif;
      background:url('img/GXD6 Greyscale paper background.jpg') center/cover fixed;
      margin:0; padding:20px; color:black;
    }

    .sheet-container {
      width:800px;
      margin:0 auto;
      min-width:800px;
      max-width:800px;
    }

    h3 {
      font-family:'DominicanSmall', serif;
      font-variant:small-caps;
      text-align: left;
      margin:5px 0;
      font-size:16px;
    }

    input[type="text"], input[type="number"], select {
      font-family:'Dominican', serif;
      font-size:14px;
      padding:2px 6px;
      border:1px solid #aaa;
    }

    input[type="number"] {
      font-family:'DeutschGothic', monospace;
      font-size:16px;
      width:60px;
      text-align:center;
      -moz-appearance:textfield;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance:none; margin:0;
    }

    button {
      font-family:'DominicanSmall', serif;
      padding:4px 10px;
    }

    .top-row {
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .login-controls, .admin-controls {
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* CHARACTER INFO (Fixed Layout) */
    .char-block {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:20px;
      width:800px;
    }
    .fixed-row {
      display:flex;
      gap:0px;
      align-items:center;
      width:100%;
      min-width:800px;
    }
    .fixed-row label {
      display:flex;
      flex-direction:column;
      font-family:'DominicanSmall', serif;
      font-size:14px;
      width:auto;
      margin-right:10px;
    }
    .fixed-row label:last-child {
      margin-right:0;
    }
    .fixed-row input {
      width:140px;
      padding:3px 5px;
      font-family:'Dominican', serif;
      font-size:14px;
      border:1px solid #999;
      box-sizing:border-box;
    }

    /* Unified styling for all attribute boxes */
    .attribute-box {
      width:270px;
      background:rgba(255,255,255,0.85);
      padding:5px 8px;
      margin-bottom:20px;
      border:1px solid #000;
      box-sizing:border-box;
      position:relative;
    }

    .attribute-box h3 {
      margin:0 0 5px;
      text-align:left;
      font-size:16px;
    }

    .attr-icon-container {
      position:relative;
      width:100%;
      margin:0 0 5px;
      text-align:left;
    }
    .attr-icon-container img {
      width:40%;
      display:inline-block;
      vertical-align:top;
      margin:0;
    }

    .pips {
      position:absolute;
      top:45%;
      left:calc(10% + 50px);
      display:flex;
      gap:10px;
    }
    .pip-base, .pip-current {
      width:35px;
      height:35px;
      border-radius:50%;
      border:2px solid #000;
      background:rgba(255,255,255,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .pip-base input, .pip-current input {
      width:40px;
      height:40px;
      font-size:22px;
      font-family:'DeutschGothic', monospace;
      border:none;
      background:transparent;
      text-align:center;
    }

    .pip-labels {
      position:absolute;
      top:10px;
      left:calc(10% + 50px);
      width:calc(2*35px + 10px);
      display:flex;
      justify-content:space-between;
      font-size:12px;
      font-family:'DominicanSmall', serif;
    }

    .skills-grid {
      display:grid;
      grid-template-columns:28px 1fr 36px 36px 36px;
      gap:3px;
      align-items:end;
      font-family:'Dominican', serif;
      font-size:13px;
    }
    .skills-grid > div:nth-child(-n+5) {
      font-size:12px;
      padding-bottom:0;
      line-height:1;
    }
    .skills-grid input[type="number"] {
      padding:0;
      margin:0;
      height:28px;
      box-sizing:border-box;
    }
    .pants-grid div {
      align-self:flex-end;
    }

    .pip-base .lock-icon {
      position:absolute;
      bottom:-10px;
      left:50%;
      transform:translateX(-50%);
      width:14px;
      height:14px;
    }
    .pip-current .trauma-controls {
      position:absolute;
      right:-22px;
      top:4px;
      display:flex;
      flex-direction:column;
    }
    .pip-current .trauma-controls button {
      width:14px;
      height:14px;
      font-size:10px;
      padding:0;
      margin:1px 0;
      background:none;
      border:none;
      cursor:pointer;
      line-height:10px;
    }

    /* Notes field styling */
    .notes-label {
      font-family:'Dominican', serif;
      font-size:14px;
      margin-top:20px;
      display:block;
    }
    textarea {
      width:100%;
      height:100px;
      font-family:'Dominican', serif;
      font-size:14px;
    }
  </style>
</head>
<body>
  <div class="sheet-container">

    <!-- LOGIN FORM -->
    <div id="loginForm" class="top-row">
      <div class="login-controls">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button onclick="signIn()">Sign In</button>
        <button onclick="signUp()">Sign Up</button>
      </div>
    </div>

    <!-- ADMIN CONTROLS -->
    <div id="accountControls" class="top-row" style="display:none;">
      <div class="admin-controls">
        <button onclick="signOutUser()">Sign Out</button>
        <button onclick="deleteAccount()">Delete Account</button>
        <button onclick="saveCharacter()">Save</button>
        <button onclick="loadCharacter()">Load</button>
        <label>Saved <select id="characterSelect"><option value="">--Select--</option></select></label>
        <button onclick="deleteCharacter()">Delete Character</button>
      </div>
    </div>

    <!-- CHARACTER INFO -->
    <div class="char-block">
      <div class="fixed-row">
        <label style="margin-right:10px;">Character Name
          <input id="charName" type="text" maxlength="30" style="width:250px;">
        </label>
        <label style="margin-right:10px;">Age Group
          <input id="ageGroup" type="text" maxlength="10" style="width:100px;">
        </label>
        <label style="margin-right:10px;">Gender
          <input id="gender" type="text" maxlength="15" style="width:100px;">
        </label>
        <label>XP
          <input id="xp" type="number" style="width:50px;">
        </label>
      </div>
      <div class="fixed-row">
        <label style="margin-right:5px;">Archetype 1
          <input id="archetype1" type="text" maxlength="20" style="width:150px;">
        </label>
        <label>Archetype 2
          <input id="archetype2" type="text" maxlength="20" style="width:150px;">
        </label>
      </div>
      <div class="fixed-row">
        <label style="margin-right:5px;">Profession 1
          <input id="profession1" type="text" maxlength="20" style="width:150px;">
        </label>
        <label>Profession 2
          <input id="profession2" type="text" maxlength="20" style="width:150px;">
        </label>
      </div>
    </div>

    <!-- ATTRIBUTE BOXES (Brawn, Agility, Wits, Will) -->
    <!-- Insert the combined HTML from your template here -->

  </div>

  <script type="module">
    /* ...signIn, saveCharacter, loadCharacter, etc. */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDVINPqS-nMiWEs7RvabEqKuuUrii2S2MM",
    authDomain: "gxd6-character-sheet.firebaseapp.com",
    projectId: "gxd6-character-sheet",
    storageBucket: "gxd6-character-sheet.firebasestorage.app",
    messagingSenderId: "761778638151",
    appId: "1:761778638151:web:06a1d72423a7e980889062"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginFormEl = document.getElementById('loginForm');
  const accountControlsEl = document.getElementById('accountControls');
  const characterSelectEl = document.getElementById('characterSelect');

  onAuthStateChanged(auth, user => {
    if (user) {
      loginFormEl.style.display = 'none';
      accountControlsEl.style.display = 'flex';
      populateCharacterList(user.uid);
    } else {
      loginFormEl.style.display = 'flex';
      accountControlsEl.style.display = 'none';
      characterSelectEl.innerHTML = '<option value="">--Select--</option>';
    }
  });

  window.signUp = async () => {
    const email = document.getElementById('email').value;
    const pw = document.getElementById('password').value;
    await createUserWithEmailAndPassword(auth, email, pw);
    alert('Signed up!');
  };

  window.signIn = async () => {
    const email = document.getElementById('email').value;
    const pw = document.getElementById('password').value;
    await signInWithEmailAndPassword(auth, email, pw);
    alert('Signed in!');
  };

  window.signOutUser = async () => {
    await signOut(auth);
    alert('Signed out');
  };

  window.deleteAccount = async () => {
    if (auth.currentUser && confirm('Delete account and characters?')) {
      await deleteUser(auth.currentUser);
      alert('Account deleted');
    }
  };

  async function populateCharacterList(uid) {
    const snap = await getDocs(collection(db, 'users', uid, 'characters'));
    characterSelectEl.innerHTML = '<option value="">--Select--</option>';
    snap.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.text = d.id;
      characterSelectEl.appendChild(opt);
    });
  }

  window.saveCharacter = async () => {
    const user = auth.currentUser;
    const name = document.getElementById('charName').value.trim();
    if (!user || !name) return alert('Sign in & enter a name');
    const container = document.querySelector('.sheet-container');
    const elements = container.querySelectorAll('input, select, textarea');
    const data = { name };
    elements.forEach(el => {
      const id = el.id;
      if (!id || id==='email'|| id==='password') return;
      if (el.type==='checkbox') data[id] = el.checked;
      else data[id] = el.value;
    });
    await setDoc(doc(db, 'users', user.uid, 'characters', name), data);
    alert('✅ Saved');
    populateCharacterList(user.uid);
  };

  window.loadCharacter = async () => {
    const user = auth.currentUser;
    if (!user) return alert('Sign in first');
    const id = characterSelectEl.value || document.getElementById('charName').value.trim();
    if (!id) return alert('Select or type name');
    const snap = await getDoc(doc(db, 'users', user.uid, 'characters', id));
    if (!snap.exists()) return alert('Not found');
    const data = snap.data();
    const container = document.querySelector('.sheet-container');
    container.querySelectorAll('input, select, textarea').forEach(el => {
      const id = el.id;
      if (!id || id==='email'|| id==='password') return;
      if (data[id] !== undefined) {
        if (el.type==='checkbox') el.checked = data[id];
        else el.value = data[id];
      }
    });
    alert('✅ Loaded');
  };

  window.deleteCharacter = async () => {
    const user = auth.currentUser;
    const name = characterSelectEl.value;
    if (!user || !name) return alert('Select a character');
    if (confirm(`Delete "${name}"?`)) {
      await deleteDoc(doc(db, 'users', user.uid, 'characters', name));
      alert('Deleted');
      populateCharacterList(user.uid);
    }
  };
    // Pip controls and skill-total logic:
    function stepUpField(id) {
      const el = document.getElementById(id);
      el.stepUp();
      computeAllTotals();
    }
    function stepDownField(id) {
      const el = document.getElementById(id);
      el.stepDown();
      computeAllTotals();
    }

    function computeAllTotals() {
      document.querySelectorAll('.skills-grid').forEach(grid => {
        const attr = grid.getAttribute('data-attr');
        const attrVal = +document.getElementById(attr)?.value || 0;
        grid.querySelectorAll('input[type="number"]').forEach(inp => {
          const id = inp.id;
          if (id.endsWith('_lvl') || id.endsWith('_mod')) {
            const skill = id.slice(0, id.lastIndexOf('_'));
            const lvl = +document.getElementById(`${skill}_lvl`).value || 0;
            const mod = +document.getElementById(`${skill}_mod`).value || 0;
            const tot = document.getElementById(`${skill}_total`);
            if (tot) tot.value = attrVal + lvl + mod;
          }
        });
      });
    }

    ['brawn','agility','wits','will'].forEach(attr => {
      document.getElementById(attr)?.addEventListener('input', computeAllTotals);
      document.getElementById(`${attr}Current`)?.addEventListener('input', computeAllTotals);
    });
    computeAllTotals();
  </script>
</body>
</html>
