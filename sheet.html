<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GxD6 Character Sheet</title>
  <style>
/* === Fonts (for the sheet—not used by debugger) === */
@font-face { font-family: 'DominicanSmall'; src: url('fonts/DOMISC__.TTF'); }
@font-face { font-family: 'Dominican';      src: url('fonts/DOMINICA.TTF'); }
@font-face { font-family: 'DeutschGothic';  src: url('fonts/DeutschGothic.ttf'); }

body{
  font-family:'DominicanSmall', Georgia, serif;
  background:#f5f5f5;
  margin:0;
  padding:20px;
  color:black;
}

.sheet-container{ width:800px; margin:0 auto; min-width:800px; }

input,select{
  font-family:'Dominican', serif;
  font-size:14px;
  padding:2px 6px;
  background:transparent;
  border:none;
}
input[type="text"]{ font-family:'Dominican', serif; }

input[type=number]{
  font-family:'DeutschGothic', monospace;
  font-size:16px;
  text-align:center;
  -moz-appearance:textfield;
}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; }

button{
  font-family:'DominicanSmall', serif;
  padding:4px 4px;
  cursor:pointer;
}

.top-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:20px;
}
.login-controls,.admin-controls{ display:flex; align-items:center; gap:10px; }

/* === Attribute pip styles === */
.pip-base,.pip-current{
  width:20px; height:22px;
  border:none;
  background:transparent;
  display:flex; align-items:center; justify-content:center;
  position:relative;
}
.pip-base input,.pip-current input{
  width:20px; height:22px; font-size:20px;
  border:none; background:transparent; text-align:center;
  font-family:'DeutschGothic', monospace;
  padding:0; margin:0;
}
.pip-base .lock-icon{
  position:absolute; bottom:-10px; left:50%; transform:translateX(-50%);
  width:14px; height:14px; cursor:pointer;
}
.trauma-controls{
  position:absolute; top:0; right:-20px;
  display:flex; flex-direction:column; gap:2px;
}
.trauma-controls button{
  width:18px; height:18px; font-size:12px; font-weight:bold;
  background:#e0e0e0; border:none; cursor:pointer; line-height:1; padding:0;
}

/* === Canvas === */
.sheet-canvas{
  position:relative;
  width:800px; height:800px;
  background:url("img/CharSheet_Block_1600x1600.jpg") no-repeat 0 0 / 100% 100%;
  border:1px solid #000; margin-top:20px;
}
.abs{
  position:absolute;
  left:var(--x,0); top:var(--y,0);
  width:var(--w,auto); height:var(--h,auto);
  z-index:10;
}
/* Overlay text fields */
.abs input[type="text"], .abs select{
  font-family:'Dominican', serif;
  font-size:12px;
  background:transparent;
  padding:2px 6px;
  border:none;
  box-sizing:border-box;
  height:20px;
}
.abs input[type="number"]{
  font-family:'DeutschGothic', monospace;
  font-size:16px; text-align:center;
  height:20px; padding:0 4px;
}
.abs input[type="number"]::-webkit-outer-spin-button,
.abs input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; }

/* Debug: outlines overlays */
.canvas-debug .abs{ outline:1px dashed rgba(0,0,0,.25); }

/* live coordinate badge (legacy mover) */
.coord-badge{
  position:absolute; z-index:9999; background:rgba(0,0,0,.75); color:#fff;
  font:12px/1.2 'DominicanSmall',serif; padding:2px 6px; border-radius:3px;
  pointer-events:none; white-space:nowrap; transform:translate(-2px,-18px);
}

/* highlight the selected overlay while debugging */
.canvas-debug .abs.selected{ outline:2px solid #4caf50; }

/* Tabs */
.tabBtn{ background:#eee; border:1px solid #333; }
.tabBtn.active{ background:#333; color:#fff; }

/* === Skill UI bits === */
.skill-num {
  font-family: 'DeutschGothic', monospace;
  font-size: 10px;
  height: 15px;
  width: 15px;
  text-align: center;
  padding: 0;
  background: transparent;
  border: none;
}

/* Pip checkbox */
.pip-check {
  appearance: none;
  -webkit-appearance: none;
  width: 7px; height: 7px; border-radius: 50%;
  background: transparent; cursor: pointer; display: inline-block;
  padding: 0; margin: 0; line-height: 0; vertical-align: middle;
}
.pip-check:checked { background: white; }
.pip-check:focus { outline: none; }

/* Roll button overlay (uses roll_icon.png, shows '+') */
.roll-btn{
  width:20px; height:20px;
  background:url("img/roll_icon.png") no-repeat center/contain;
  border:none; cursor:pointer;
  font-family:'DeutschGothic';
  font-size:14px; font-weight:bold; color:black;
  text-align:center; line-height:18px; padding:0;
}
.roll-btn:active{ transform:scale(0.9); }

<!-- =============================
     Unified Debugger (styles)
     ============================= -->
<style>
.debugger-panel {
  position: fixed; right: 12px; bottom: 12px; z-index: 1000000;
  /* High contrast, default system font, compact */
  background: #ffffff; color: #111; border: 1px solid #bbb;
  font: 9px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  padding: 6px; border-radius: 6px; box-shadow: 0 6px 18px rgba(0,0,0,.15);
  user-select: none; min-width: 170px;
}
.debugger-panel .row { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
.debugger-panel .row > .grow { flex: 1; }
.debugger-panel input[type="text"],
.debugger-panel input[type="number"],
.debugger-panel button {
  font: 9px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  padding: 2px 4px;
}
.debugger-panel button { border: 1px solid #bbb; background: #f6f6f6; cursor: pointer; }
.debugger-panel .muted { opacity: .75; }

/* Tooltip + coord HUD: small, readable, high-contrast */
.debug-tooltip,
.debug-coord-hud {
  position: fixed; z-index: 999998; display: none;
  background: #111; color: #fff; border: 1px solid #444; border-radius: 4px;
  padding: 3px 5px;
  font: 9px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  pointer-events: none; white-space: nowrap;
}
.debug-tooltip { transform: translate(8px,8px); }

/* Crosshairs */
.debug-crosshair-x, .debug-crosshair-y {
  position: fixed; z-index: 999996; background: rgba(255,0,0,.8); display: none; pointer-events: none;
}
.debug-crosshair-x { height: 1px; left: 0; right: 0; }
.debug-crosshair-y { width: 1px; top: 0; bottom: 0; }

/* Marquee box */
.debug-marquee {
  position: fixed; z-index: 999997; display: none;
  border: 1px dashed #0077ff; background: rgba(0,119,255,.12); pointer-events: none;
}

/* Selection highlight: strong and obvious */
.debug-selected {
  outline: 2px solid #0077ff !important;
  outline-offset: 0 !important;
  box-shadow: 0 0 0 2px rgba(0,119,255,.2) inset;
}

/* Compact state: only show header row */
.debugger-panel.compact > :not(:first-child){
  display: none;
}
</style>

</head>
<body>
<div class="sheet-container">

  <!-- LOGIN FORM -->
  <div id="loginForm" class="top-row">
    <div class="login-controls">
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button onclick="signIn()">Sign In</button>
      <button onclick="signUp()">Sign Up</button>
    </div>
  </div>

  <!-- ADMIN CONTROLS -->
  <div id="accountControls" class="top-row" style="display:none;">
    <div class="admin-controls">
      <button onclick="signOutUser()">Sign Out</button>
      <button onclick="deleteAccount()">Delete Account</button>
      <button onclick="saveCharacter()">Save</button>
      <button onclick="loadCharacter()">Load</button>
      <label>Saved
        <select id="characterSelect"><option value="">--Select--</option></select>
      </label>
      <button onclick="deleteCharacter()">Delete Character</button>
    </div>
  </div>

  <!-- === Main canvas === -->
  <div class="sheet-canvas" id="mainCanvas">

    <!-- Character Info -->
    <input id="charName" class="abs" type="text" maxlength="40" style="--x:28px; --y:123px; --w:210px;" />
    <input id="ageGroup" class="abs" type="text" maxlength="20" style="--x:262px; --y:123px; --w:90px;" />
    <input id="gender"  class="abs" type="text" maxlength="20" style="--x:382px; --y:123px; --w:80px;" />
    <input id="origin"  class="abs" type="text" maxlength="60" style="--x:482px; --y:123px; --w:250px;" />

    <!-- Attributes -->
    <!-- BRAWN -->
    <span class="pip-base abs" style="--x:127px; --y:210px;">
      <input id="brawn" type="number" min="1" max="5" value="1">
      <img id="lock-brawn" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('brawn')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:210px;">
      <input id="brawnCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('brawnCurrent')">+</button>
        <button onclick="stepDownField('brawnCurrent')">−</button>
      </div>
    </span>
    <!-- AGILITY -->
    <span class="pip-base abs" style="--x:127px; --y:345px;">
      <input id="agility" type="number" min="1" max="5" value="1">
      <img id="lock-agility" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('agility')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:345px;">
      <input id="agilityCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('agilityCurrent')">+</button>
        <button onclick="stepDownField('agilityCurrent')">−</button>
      </div>
    </span>
    <!-- WITS -->
    <span class="pip-base abs" style="--x:127px; --y:480px;">
      <input id="wits" type="number" min="1" max="5" value="1">
      <img id="lock-wits" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('wits')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:480px;">
      <input id="witsCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('witsCurrent')">+</button>
        <button onclick="stepDownField('witsCurrent')">−</button>
      </div>
    </span>
    <!-- WILL -->
    <span class="pip-base abs" style="--x:127px; --y:665px;">
      <input id="will" type="number" min="1" max="5" value="1">
      <img id="lock-will" class="lock-icon" src="img/lock_open.png" onclick="toggleLock('will')">
    </span>
    <span class="pip-current abs" style="--x:191px; --y:665px;">
      <input id="willCurrent" type="number" min="0" max="5" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('willCurrent')">+</button>
        <button onclick="stepDownField('willCurrent')">−</button>
      </div>
    </span>

    <!-- POWER POINTS (current) -->
    <span class="pip-current abs" style="--x:284px; --y:244px;">
      <input id="powerCurrent" type="number" min="0" max="99" value="0">
      <div class="trauma-controls">
        <button onclick="stepUpField('powerCurrent')">+</button>
        <button onclick="stepDownField('powerCurrent')">−</button>
      </div>
    </span>

    <!-- ===== BRAWN SKILLS ===== -->
    <input id="endurance_key"   type="checkbox" class="abs pip-check" style="--x:41px; --y:252px;">
    <input id="endurance_lvl"   type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:240px;">
    <input id="endurance_mod"   type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:150px; --y:236px;">
    <input id="endurance_total" type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:236px;">
    <button id="endurance_roll" class="abs roll-btn" style="--x:340px; --y:245px;" onclick="addToDicePool('endurance_total')">+</button>

    <input id="fight_key"       type="checkbox" class="abs pip-check" style="--x:41px; --y:277px;">
    <input id="fight_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:258px;">
    <input id="fight_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:258px;">
    <input id="fight_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:258px;">
    <button id="fight_roll"     class="abs roll-btn" style="--x:340px; --y:258px;" onclick="addToDicePool('fight_total')">+</button>

    <input id="might_key"       type="checkbox" class="abs pip-check" style="--x:41px; --y:301px;">
    <input id="might_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:280px;">
    <input id="might_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:280px;">
    <input id="might_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:280px;">
    <button id="might_roll"     class="abs roll-btn" style="--x:340px; --y:280px;" onclick="addToDicePool('might_total')">+</button>

    <!-- ===== AGILITY SKILLS ===== -->
    <input id="marksmanship_key"   type="checkbox" class="abs pip-check" style="--x:41px; --y:387px;">
    <input id="marksmanship_lvl"   type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:385px;">
    <input id="marksmanship_mod"   type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:385px;">
    <input id="marksmanship_total" type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:385px;">
    <button id="marksmanship_roll" class="abs roll-btn" style="--x:212px; --y:431px;" onclick="addToDicePool('marksmanship_total')">+</button>

    <input id="mobility_key"       type="checkbox" class="abs pip-check" style="--x:41px; --y:412px%;">
    <input id="mobility_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:408px;">
    <input id="mobility_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:408px%;">
    <input id="mobility_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:408px;">
    <button id="mobility_roll"     class="abs roll-btn" style="--x:212px; --y:404px;" onclick="addToDicePool('mobility_total')">+</button>

    <input id="precision_key"      type="checkbox" class="abs pip-check" style="--x:41px; --y:437px;">
    <input id="precision_lvl"      type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:433px;">
    <input id="precision_mod"      type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:433px;">
    <input id="precision_total"    type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:316px;">
    <button id="precision_roll"    class="abs roll-btn" style="--x:340px; --y:415px;" onclick="addToDicePool('precision_total')">+</button>

    <!-- ===== WITS SKILLS ===== -->
    <input id="heal_key"           type="checkbox" class="abs pip-check" style="--x:41px; --y:521px;">
    <input id="heal_lvl"           type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:506px;">
    <input id="heal_mod"           type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:506px;">
    <input id="heal_total"         type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:506px;">
    <button id="heal_roll"         class="abs roll-btn" style="--x:340px; --y:506px;" onclick="addToDicePool('heal_total')">+</button>

    <input id="insight_key"        type="checkbox" class="abs pip-check" style="--x:41px; --y:546px;">
    <input id="insight_lvl"        type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:528px;">
    <input id="insight_mod"        type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:528px;">
    <input id="insight_total"      type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:528px%;">
    <button id="insight_roll"      class="abs roll-btn" style="--x:340px; --y:528px;" onclick="addToDicePool('insight_total')">+</button>

    <input id="logic_key"          type="checkbox" class="abs pip-check" style="--x:41px; --y:570px;">
    <input id="logic_lvl"          type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:550px;">
    <input id="logic_mod"          type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:550px;">
    <input id="logic_total"        type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:550px;">
    <button id="logic_roll"        class="abs roll-btn" style="--x:340px; --y:550px;" onclick="addToDicePool('logic_total')">+</button>

    <input id="survival_key"       type="checkbox" class="abs pip-check" style="--x:41px; --y:596px;">
    <input id="survival_lvl"       type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:572px;">
    <input id="survival_mod"       type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:572px;">
    <input id="survival_total"     type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:572px;">
    <button id="survival_roll"     class="abs roll-btn" style="--x:340px; --y:572px;" onclick="addToDicePool('survival_total')">+</button>

    <input id="vigilance_key"      type="checkbox" class="abs pip-check" style="--x:41px; --y:621px;">
    <input id="vigilance_lvl"      type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:594px;">
    <input id="vigilance_mod"      type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:594px;">
    <input id="vigilance_total"    type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:594px;">
    <button id="vigilance_roll"    class="abs roll-btn" style="--x:340px; --y:594px;" onclick="addToDicePool('vigilance_total')">+</button>

    <!-- ===== WILL SKILLS ===== -->
    <input id="inspire_key"        type="checkbox" class="abs pip-check" style="--x:41px; --y:691px;">
    <input id="inspire_lvl"        type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:691px;">
    <input id="inspire_mod"        type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:691px;">
    <input id="inspire_total"      type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:691px;">
    <button id="inspire_roll"      class="abs roll-btn" style="--x:340px; --y:691px;" onclick="addToDicePool('inspire_total')">+</button>

    <input id="manipulate_key"     type="checkbox" class="abs pip-check" style="--x:41px; --y:713px;">
    <input id="manipulate_lvl"     type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:713px;">
    <input id="manipulate_mod"     type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:713px;">
    <input id="manipulate_total"   type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:713px;">
    <button id="manipulate_roll"   class="abs roll-btn" style="--x:340px; --y:713px;" onclick="addToDicePool('manipulate_total')">+</button>

    <input id="resolve_key"        type="checkbox" class="abs pip-check" style="--x:41px; --y:735px%;">
    <input id="resolve_lvl"        type="number"   class="abs skill-num" min="0"  max="5"  value="0" style="--x:137px; --y:735px;">
    <input id="resolve_mod"        type="number"   class="abs skill-num" min="-5" max="5"  value="0" style="--x:282px; --y:735px;">
    <input id="resolve_total"      type="number"   class="abs skill-num" readonly value="0" style="--x:316px; --y:735px;">
    <button id="resolve_roll"      class="abs roll-btn" style="--x:340px; --y:735px;" onclick="addToDicePool('resolve_total')">+</button>

    <!-- Tabs box -->
    <div id="tabBox" class="abs"
      style="--x:278px; --y:331px; --w:440px; --h:430px; background:transparent; border:none; padding:5px;">
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button type="button" class="tabBtn" data-tab="main"   onclick="showTab('main')">Main</button>
        <button type="button" class="tabBtn" data-tab="combat" onclick="showTab('combat')">Combat</button>
        <button type="button" class="tabBtn" data-tab="gear"   onclick="showTab('gear')">Gear</button>
        <button type="button" class="tabBtn" data-tab="powers" onclick="showTab('powers')">Powers</button>
      </div>

      <!-- panel-main: inputs only -->
      <div id="panel-main" class="tabPanel" style="display:block;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <input id="archetype1" type="text" placeholder="" />
          <input id="profession1" type="text" placeholder="" />
          <input id="archetype2" type="text" placeholder="" />
          <input id="profession2" type="text" placeholder="" />
        </div>
        <div style="margin-top:14px; display:flex; justify-content:flex-end;">
          <input id="xp" type="number" value="0" style="width:40px;" />
        </div>
      </div>

      <div id="panel-combat" class="tabPanel" style="display:none;">Combat coming soon</div>
      <div id="panel-gear"   class="tabPanel" style="display:none;">Gear coming soon</div>
      <div id="panel-powers" class="tabPanel" style="display:none;">Powers coming soon</div>
    </div>

  </div>
</div>

<!-- Scripts (tabs + small helpers) -->
<script>
window.showTab = function(which){
  document.querySelectorAll('.tabPanel').forEach(p=>p.style.display='none');
  const active = document.getElementById('panel-'+which);
  if(active) active.style.display='block';
  document.querySelectorAll('.tabBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab===which);
  });
};

window.toggleLock = id => {
  const field = document.getElementById(id);
  const icon = document.getElementById(`lock-${id}`);
  if (!field || !icon) return;
  const locked = !field.disabled;
  field.disabled = locked;
  icon.src = locked ? 'img/lock.png' : 'img/lock_open.png';
  field.style.opacity = locked ? 0.6 : 1;
};
window.stepUpField = id => { document.getElementById(id)?.stepUp(); };
window.stepDownField = id => { document.getElementById(id)?.stepDown(); };

/* Dice integration stub */
function addToDicePool(totalId){
  const totalEl = document.getElementById(totalId);
  const val = parseInt(totalEl?.value,10) || 0;
  alert(`Would add ${val} dice from ${totalId} to the Dice Pool`);
}
</script>

<!-- Firebase / Firestore -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVINPqS-nMiWEs7RvabEqKuuUrii2S2MM",
  authDomain: "gxd6-character-sheet.firebaseapp.com",
  projectId: "gxd6-character-sheet",
  storageBucket: "gxd6-character-sheet.firebasestorage.app",
  messagingSenderId: "761778638151",
  appId: "1:761778638151:web:06a1d72423a7e980889062"
};
initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const loginFormEl=document.getElementById('loginForm');
const accountControlsEl=document.getElementById('accountControls');
const characterSelectEl=document.getElementById('characterSelect');

onAuthStateChanged(auth,user=>{
  if(user){
    loginFormEl.style.display='none';
    accountControlsEl.style.display='flex';
    populateCharacterList(user.uid);
  }else{
    loginFormEl.style.display='flex';
    accountControlsEl.style.display='none';
    characterSelectEl.innerHTML='<option value="">--Select--</option>';
  }
});

async function populateCharacterList(uid){
  const snap=await getDocs(collection(db,'users',uid,'characters'));
  characterSelectEl.innerHTML='<option value="">--Select--</option>';
  snap.forEach(d=>{
    const opt=document.createElement('option');opt.value=d.id;opt.text=d.id;characterSelectEl.appendChild(opt);
  });
}

window.signUp=async()=>{
  const em = document.getElementById('email').value.trim();
  const pw = document.getElementById('password').value;
  await createUserWithEmailAndPassword(auth,em,pw);
  alert('Signed up!');
};
window.signIn=async()=>{
  const em = document.getElementById('email').value.trim();
  const pw = document.getElementById('password').value;
  await signInWithEmailAndPassword(auth,em,pw);
  alert('Signed in!');
};
window.signOutUser=async()=>{ await signOut(auth); alert('Signed out'); };
window.deleteAccount=async()=>{
  if(auth.currentUser && confirm('Delete account?')){
    await deleteUser(auth.currentUser);
    alert('Account deleted');
  }
};

window.saveCharacter=async()=>{
  const user=auth.currentUser;
  const name=document.getElementById('charName').value.trim();
  if(!user||!name) return alert('Sign in & name required');

  const data={};
  document.querySelectorAll('#mainCanvas input, #mainCanvas select, #tabBox input, #tabBox select').forEach(el=>{
    if(!el.id || el.id.startsWith('lock')) return;
    data[el.id] = (el.type==='checkbox') ? el.checked : el.value;
  });
  await setDoc(doc(db,'users',user.uid,'characters',name),data);
  alert('Saved');
  populateCharacterList(user.uid);
};

window.loadCharacter=async()=>{
  const user=auth.currentUser;
  if(!user) return alert('Sign in first');

  const id=characterSelectEl.value || document.getElementById('charName').value.trim();
  if(!id) return alert('Choose or type name');

  const snap=await getDoc(doc(db,'users',user.uid,'characters',id));
  if(!snap.exists()) return alert('Not found');

  const data=snap.data();
  Object.keys(data).forEach(k=>{
    const el=document.getElementById(k);
    if(el && !k.startsWith('lock')){
      (el.type==='checkbox') ? el.checked=!!data[k] : el.value=(data[k] ?? '');
    }
  });

  document.getElementById('charName').value = id;
  characterSelectEl.value = id;

  initAllSkillTotals();
  alert('Loaded');
};

window.deleteCharacter=async()=>{
  const user=auth.currentUser; const name=characterSelectEl.value;
  if(!user||!name) return alert('Select a character');
  if(confirm(`Delete "${name}"?`)){
    await deleteDoc(doc(db,'users',user.uid,'characters',name));
    alert('Deleted');
    populateCharacterList(user.uid);
  }
};
</script>

<!-- Skill totals + Unified Debugger -->
<script>
/* ===== Skill totals wiring ===== */
function toNum(v){ const n = parseInt(v,10); return isNaN(n) ? 0 : n; }
function setupSkillRow(attrCurrentId, baseId){
  const attrEl  = document.getElementById(attrCurrentId);
  const lvlEl   = document.getElementById(`${baseId}_lvl`);
  const modEl   = document.getElementById(`${baseId}_mod`);
  const totalEl = document.getElementById(`${baseId}_total`);
  if(!attrEl || !lvlEl || !modEl || !totalEl) return;
  const recalc = () => { totalEl.value = toNum(attrEl.value) + toNum(lvlEl.value) + toNum(modEl.value); };
  ['input','change'].forEach(ev=>{
    attrEl.addEventListener(ev,recalc);
    lvlEl.addEventListener(ev,recalc);
    modEl.addEventListener(ev,recalc);
  });
  recalc();
}
function initBrawnSkillTotals(){ setupSkillRow('brawnCurrent','endurance'); setupSkillRow('brawnCurrent','fight'); setupSkillRow('brawnCurrent','might'); }
function initAgilitySkillTotals(){ setupSkillRow('agilityCurrent','marksmanship'); setupSkillRow('agilityCurrent','mobility'); setupSkillRow('agilityCurrent','precision'); }
function initWitsSkillTotals(){ setupSkillRow('witsCurrent','heal'); setupSkillRow('witsCurrent','insight'); setupSkillRow('witsCurrent','logic'); setupSkillRow('witsCurrent','survival'); setupSkillRow('witsCurrent','vigilance'); }
function initWillSkillTotals(){ setupSkillRow('willCurrent','inspire'); setupSkillRow('willCurrent','manipulate'); setupSkillRow('willCurrent','resolve'); }
function initAllSkillTotals(){ initBrawnSkillTotals(); initAgilitySkillTotals(); initWitsSkillTotals(); initWillSkillTotals(); }
document.addEventListener('DOMContentLoaded', initAllSkillTotals);

<!-- =============================
     Unified Debugger (script)
     ============================= -->
<script>
(() => {
  // Targets: all positioned overlays inside the canvas
  let TARGET_SELECTOR = '.abs';

  // State
  let debugOn = false;
  let hoverEnabled = false;   // ALT
  let marqueeActive = false;  // Shift+drag
  let cursorMode = false;
  let selected = new Set();
  let startX = 0, startY = 0;

  const canvas = document.getElementById('mainCanvas');

  // Elements
  const tooltip = document.createElement('div');
  tooltip.className = 'debug-tooltip'; document.body.appendChild(tooltip);

  const marquee = document.createElement('div');
  marquee.className = 'debug-marquee'; document.body.appendChild(marquee);

  const crossX = document.createElement('div');
  crossX.className = 'debug-crosshair-x'; document.body.appendChild(crossX);
  const crossY = document.createElement('div');
  crossY.className = 'debug-crosshair-y'; document.body.appendChild(crossY);
  const coordHUD = document.createElement('div');
  coordHUD.className = 'debug-coord-hud'; coordHUD.textContent = 'X: 0  Y: 0';
  document.body.appendChild(coordHUD);

  // Panel
  const panel = document.createElement('div');
  panel.className = 'debugger-panel';
  panel.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <strong>Debugger</strong>
      <label class="row" title="Enable/disable debugger">
        <input id="dbg-toggle" type="checkbox"><span>On</span>
      </label>
    </div>

    <div class="row"><span class="muted">Selector</span></div>
    <input id="dbg-selector" type="text" value="${TARGET_SELECTOR}" title="CSS selector for debug targets">

    <div class="row" style="justify-content:space-between; margin-top:6px">
      <label class="row" title="Show crosshair + cursor coordinates">
        <input id="dbg-cursor" type="checkbox"><span>Cursor mode</span>
      </label>
      <span class="muted">Alt=tooltip • Shift+drag=marquee • Arrows=nudge • Ctrl=5px</span>
    </div>

    <hr style="border:none;border-top:1px solid #ddd;margin:8px 0" />

    <div class="row">
      <input id="dbg-left-x" class="grow" type="number" placeholder="Left X (px)">
      <button id="dbg-align-left" type="button" title="Set all selected left to X">Align Left</button>
    </div>
    <div class="row">
      <input id="dbg-top-y" class="grow" type="number" placeholder="Top Y (px)">
      <button id="dbg-align-top" type="button" title="Set all selected top to Y">Align Top</button>
    </div>

    <div class="row">
      <input id="dbg-center-x" class="grow" type="number" placeholder="Center X (px) — empty = use first">
      <button id="dbg-center-x-btn" type="button" title="Center each selected at this X">Align Center X</button>
    </div>
    <div class="row">
      <input id="dbg-center-y" class="grow" type="number" placeholder="Center Y (px) — empty = use first">
      <button id="dbg-center-y-btn" type="button" title="Center each selected at this Y">Align Center Y</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="dbg-clear" type="button" title="Clear selection">Clear selection</button>
      <button id="dbg-log" type="button" title="Log selected coords to console">Log coords</button>
    </div>

    <hr style="border:none;border-top:1px solid #ddd;margin:8px 0" />

    <div class="row" style="justify-content:space-between">
      <button id="dbg-export" type="button" title="Download selected positions as JSON">Export JSON</button>
      <button id="dbg-import" type="button" title="Import positions from JSON">Import JSON</button>
      <input id="dbg-file" type="file" accept="application/json" style="display:none">
    </div>
  `;
  document.body.appendChild(panel);

  // Compact behavior (auto-collapse when Off; click header to toggle)
  (function(){
    const headerRow = panel.querySelector('.row');
    if (headerRow) headerRow.style.cursor = 'pointer';
    function setCompact(on){ panel.classList.toggle('compact', !!on); }
    setCompact(true); // start compact
    headerRow && headerRow.addEventListener('click', function(e){
      const tgt = e.target;
      if (tgt && (tgt.id === 'dbg-toggle' || (tgt.closest && tgt.closest('#dbg-toggle')))) return;
      setCompact(!panel.classList.contains('compact'));
    });
    const toggle = document.getElementById('dbg-toggle');
    if (toggle){
      toggle.addEventListener('change', function(){ setCompact(!toggle.checked); });
      setCompact(!toggle.checked);
    }
  })();

  // Panel refs
  const $ = sel => document.querySelector(sel);
  const toggleEl   = $('#dbg-toggle');
  const selectorEl = $('#dbg-selector');
  const cursorEl   = $('#dbg-cursor');
  const clearBtn   = $('#dbg-clear');
  const logBtn     = $('#dbg-log');
  const leftInput  = $('#dbg-left-x');
  const topInput   = $('#dbg-top-y');
  const centerXInp = $('#dbg-center-x');
  const centerYInp = $('#dbg-center-y');
  const alignLeft  = $('#dbg-align-left');
  const alignTop   = $('#dbg-align-top');
  const centerXBtn = $('#dbg-center-x-btn');
  const centerYBtn = $('#dbg-center-y-btn');
  const exportBtn  = $('#dbg-export');
  const importBtn  = $('#dbg-import');
  const fileInput  = $('#dbg-file');

  // Helpers
  const inCanvas = el => canvas && canvas.contains(el);
  const isTarget = el => !!(el && el.matches && el.matches(TARGET_SELECTOR) && inCanvas(el));

  function getXY(el){
    const x = parseFloat(el.style.getPropertyValue('--x')) || 0;
    const y = parseFloat(el.style.getPropertyValue('--y')) || 0;
    return [x,y];
  }
  function setXY(el, x, y){
    el.style.setProperty('--x', x + 'px');
    el.style.setProperty('--y', y + 'px');
  }
  function clampToCanvas(el, x, y){
    const maxX = canvas.clientWidth  - el.offsetWidth;
    const maxY = canvas.clientHeight - el.offsetHeight;
    return [ Math.max(0, Math.min(x, maxX)), Math.max(0, Math.min(y, maxY)) ];
  }
  function centerOnX(el, cx){
    const r = el.getBoundingClientRect();
    const parent = canvas.getBoundingClientRect();
    const newLeft = Math.round(cx - (r.width/2) - parent.left);
    const [nx] = clampToCanvas(el, newLeft, getXY(el)[1]);
    setXY(el, nx, getXY(el)[1]);
  }
  function centerOnY(el, cy){
    const r = el.getBoundingClientRect();
    const parent = canvas.getBoundingClientRect();
    const newTop = Math.round(cy - (r.height/2) - parent.top);
    const [,ny] = clampToCanvas(el, getXY(el)[0], newTop);
    setXY(el, getXY(el)[0], ny);
  }

  function labelFor(el) {
    const id = el.id ? `#${el.id}` : '';
    const rect = el.getBoundingClientRect();
    const coords = `(${Math.round(rect.left)}, ${Math.round(rect.top)})`;
    return `${el.tagName.toLowerCase()}${id} ${coords}`;
  }
  function showTooltip(el, x, y) {
    el.classList.add('debug-outline'); // hover outline (subtle)
    tooltip.textContent = labelFor(el);
    const tx = Math.min(window.innerWidth - 8, (x ?? el.getBoundingClientRect().left) + 8);
    const ty = Math.min(window.innerHeight - 8, (y ?? el.getBoundingClientRect().top) + 8);
    tooltip.style.left = tx + 'px';
    tooltip.style.top  = ty + 'px';
    tooltip.style.display = 'block';
  }
  function hideTooltip() {
    tooltip.style.display = 'none';
    document.querySelectorAll('.debug-outline').forEach(n => n.classList.remove('debug-outline'));
  }

  function rectFromPoints(x1,y1,x2,y2){
    const left = Math.min(x1,x2), top = Math.min(y1,y2);
    const width = Math.abs(x2-x1), height = Math.abs(y2-y1);
    return {left, top, width, height, right:left+width, bottom:top+height};
  }
  function intersects(a, b){
    return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom);
  }
  function pageRect(el){
    const r = el.getBoundingClientRect();
    return {left:r.left, top:r.top, right:r.right, bottom:r.bottom};
  }

  function clearSelection() {
    selected.forEach(el => el.classList.remove('debug-selected'));
    selected.clear();
  }
  function addToSelection(el) {
    if (!selected.has(el)) { selected.add(el); el.classList.add('debug-selected'); }
  }

  function nudge(el, dx, dy) {
    const [x,y] = getXY(el);
    const [nx, ny] = clampToCanvas(el, x + dx, y + dy);
    setXY(el, nx, ny);
  }

  // Keying for import/export
  function cssPath(el) {
    const parts = [];
    for (let node = el; node && node.nodeType === 1 && node !== canvas; node = node.parentElement) {
      let sel = node.tagName.toLowerCase();
      if (node.id) { sel += `#${node.id}`; parts.unshift(sel); break; }
      let sibIndex = 1, sib = node;
      while ((sib = sib.previousElementSibling) && sib.tagName === node.tagName) sibIndex++;
      sel += `:nth-of-type(${sibIndex})`; parts.unshift(sel);
    }
    return parts.join(' > ');
  }
  function keyFor(el){ return el.id ? `#${el.id}` : cssPath(el); }
  function findByKey(key){
    if (!key) return null;
    if (key.startsWith('#')) return canvas.querySelector(key);
    return canvas.querySelector(key);
  }

  function exportSelection() {
    const items = [...selected].map(el => {
      const [left, top] = getXY(el);
      return { key: keyFor(el), left, top };
    });
    return { version: 1, items };
  }
  function importPositions(json) {
    const items = Array.isArray(json) ? json : (json?.items || []);
    const result = { applied: 0, total: items.length, unmatched: [] };
    items.forEach(item => {
      const el = findByKey(item.key);
      if (!el) { result.unmatched.push(item.key || '(no key)'); return; }
      const [x,y] = clampToCanvas(el, item.left ?? 0, item.top ?? 0);
      setXY(el, x, y);
      result.applied++;
    });
    return result;
  }

  // Panel wiring
  toggleEl.addEventListener('change', () => {
    debugOn = toggleEl.checked;
    canvas.classList.toggle('canvas-debug', debugOn);
    if (!debugOn) { hideTooltip(); clearSelection(); setCursorMode(false); }
  });
  selectorEl.addEventListener('change', () => { TARGET_SELECTOR = selectorEl.value.trim() || TARGET_SELECTOR; clearSelection(); });
  cursorEl.addEventListener('change', () => setCursorMode(cursorEl.checked));
  clearBtn.addEventListener('click', clearSelection);
  logBtn.addEventListener('click', () => {
    if (!selected.size) return;
    console.table([...selected].map(el => ({ key:keyFor(el), x:getXY(el)[0], y:getXY(el)[1] })));
  });
  alignLeft.addEventListener('click', () => {
    const x = parseFloat(leftInput.value); if (Number.isNaN(x)) return;
    selected.forEach(el => setXY(el, clampToCanvas(el, x, getXY(el)[1])[0], getXY(el)[1]));
  });
  alignTop.addEventListener('click', () => {
    const y = parseFloat(topInput.value); if (Number.isNaN(y)) return;
    selected.forEach(el => setXY(el, getXY(el)[0], clampToCanvas(el, getXY(el)[0], y)[1]));
  });
  centerXBtn.addEventListener('click', () => {
    if (!selected.size) return;
    let cx = parseFloat(centerXInp.value);
    if (Number.isNaN(cx)) {
      const first = [...selected][0].getBoundingClientRect();
      cx = Math.round(first.left + first.width/2);
    }
    selected.forEach(el => centerOnX(el, cx));
  });
  centerYBtn.addEventListener('click', () => {
    if (!selected.size) return;
    let cy = parseFloat(centerYInp.value);
    if (Number.isNaN(cy)) {
      const first = [...selected][0].getBoundingClientRect();
      cy = Math.round(first.top + first.height/2);
    }
    selected.forEach(el => centerOnY(el, cy));
  });
  exportBtn.addEventListener('click', () => {
    const data = exportSelection(); if (!data.items.length) return;
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `debug-positions-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
    a.click(); URL.revokeObjectURL(a.href);
  });
  importBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => {
    const file = fileInput.files?.[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const json = JSON.parse(String(reader.result));
        const res = importPositions(json);
        console.log(`Imported ${res.applied} / ${res.total} items. Unmatched:`, res.unmatched);
      } catch (e) { console.error('Invalid JSON:', e); }
      fileInput.value = '';
    };
    reader.readAsText(file);
  });

  // ALT = tooltip while pressed
  window.addEventListener('keydown', e => { if (debugOn && e.altKey) hoverEnabled = true; });
  window.addEventListener('keyup',   e => { if (debugOn && !e.altKey) { hoverEnabled = false; hideTooltip(); } });

  // Hover tooltip
  document.addEventListener('mouseover', e => {
    if (!debugOn || !hoverEnabled) return;
    const t = e.target.closest(TARGET_SELECTOR);
    if (isTarget(t)) showTooltip(t, e.clientX, e.clientY);
  }, {capture:true});
  document.addEventListener('mousemove', e => {
    if (!debugOn || !hoverEnabled || tooltip.style.display !== 'block') return;
    tooltip.style.left = Math.min(window.innerWidth - 8, e.clientX + 8) + 'px';
    tooltip.style.top  = Math.min(window.innerHeight - 8, e.clientY + 8) + 'px';
  });
  document.addEventListener('mouseout', e => {
    if (!debugOn || !hoverEnabled) return;
    const t = e.target.closest(TARGET_SELECTOR);
    if (isTarget(t)) hideTooltip();
  }, {capture:true});

  // ===== Fixed marquee selection: start on CANVAS, Shift required =====
  canvas.addEventListener('mousedown', e => {
    if (!debugOn || !e.shiftKey) return;
    marqueeActive = true;
    startX = e.clientX; startY = e.clientY;
    Object.assign(marquee.style, { left:startX+'px', top:startY+'px', width:'0px', height:'0px', display:'block' });
    e.preventDefault();
  });
  window.addEventListener('mousemove', e => {
    if (!debugOn || !marqueeActive) return;
    const box = rectFromPoints(startX, startY, e.clientX, e.clientY);
    Object.assign(marquee.style, { left:box.left+'px', top:box.top+'px', width:box.width+'px', height:box.height+'px' });
    clearSelection();
    canvas.querySelectorAll(TARGET_SELECTOR).forEach(el => {
      const r = pageRect(el);
      if (intersects(box, r)) addToSelection(el);
    });
  });
  window.addEventListener('mouseup', () => {
    if (!debugOn || !marqueeActive) return;
    marqueeActive = false; marquee.style.display = 'none';
  });

  // Arrow key nudging (Ctrl = 5px)
  window.addEventListener('keydown', e => {
    if (!debugOn || !selected.size) return;
    const key = e.key;
    if (!/^Arrow(Up|Down|Left|Right)$/.test(key)) return;
    const step = e.ctrlKey ? 5 : 1;
    const dx = (key === 'ArrowRight') ? step : (key === 'ArrowLeft') ? -step : 0;
    const dy = (key === 'ArrowDown')  ? step : (key === 'ArrowUp')   ? -step : 0;
    e.preventDefault();
    selected.forEach(el => nudge(el, dx, dy));
  });

  // Click selects one (no marquee)
  document.addEventListener('click', e => {
    if (!debugOn || e.shiftKey) return;            // ignore during marquee
    const t = e.target.closest(TARGET_SELECTOR);
    if (!isTarget(t)) return;
    clearSelection(); addToSelection(t);
  }, true);

  // ===== Cursor mode (fixed: HUD always updates when on) =====
  function setCursorMode(on) {
    cursorMode = !!on;
    const disp = on && debugOn ? 'block' : 'none';
    crossX.style.display = disp;
    crossY.style.display = disp;
    coordHUD.style.display = disp;
  }
  window.addEventListener('mousemove', e => {
    if (!debugOn || !cursorMode) return;
    const x = e.clientX, y = e.clientY;
    crossX.style.top = y + 'px';
    crossY.style.left = x + 'px';
    coordHUD.style.left = (x + 10) + 'px';
    coordHUD.style.top  = (y + 10) + 'px';
    coordHUD.textContent = `X: ${x}   Y: ${y}`;
  });

})();
</script>

</body>
</html>
